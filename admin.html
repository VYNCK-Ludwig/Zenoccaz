<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panneau d'administration ‚Äî ZENOCCAZ</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Effets visuels pour marge nette */
    @keyframes glitchPositive {
      0%, 100% { transform: translate(0); text-shadow: 2px 2px 0 #10b981, -2px -2px 0 #3b82f6; }
      20% { transform: translate(-2px, 2px); text-shadow: -2px -2px 0 #10b981, 2px 2px 0 #3b82f6; }
      40% { transform: translate(-2px, -2px); text-shadow: 2px -2px 0 #10b981, -2px 2px 0 #3b82f6; }
      60% { transform: translate(2px, -2px); text-shadow: -2px 2px 0 #10b981, 2px -2px 0 #3b82f6; }
      80% { transform: translate(2px, 2px); text-shadow: 2px -2px 0 #10b981, -2px 2px 0 #3b82f6; }
    }
    
    @keyframes glitchNegative {
      0%, 100% { transform: translate(0); text-shadow: 3px 3px 0 #ef4444, -3px -3px 0 #000; }
      25% { transform: translate(-3px, 3px); text-shadow: -3px -3px 0 #ef4444, 3px 3px 0 #000; }
      50% { transform: translate(3px, -3px); text-shadow: 3px -3px 0 #ef4444, -3px 3px 0 #000; }
      75% { transform: translate(-3px, -3px); text-shadow: -3px 3px 0 #ef4444, 3px -3px 0 #000; }
    }
    
    @keyframes screenShake {
      0%, 100% { transform: translate(0); }
      10% { transform: translate(-10px, -10px); }
      20% { transform: translate(10px, 10px); }
      30% { transform: translate(-10px, 10px); }
      40% { transform: translate(10px, -10px); }
      50% { transform: translate(-10px, -10px); }
      60% { transform: translate(10px, 10px); }
      70% { transform: translate(-10px, 10px); }
      80% { transform: translate(10px, -10px); }
      90% { transform: translate(-10px, 0); }
    }
    
    @keyframes flashRed {
      0%, 100% { background: transparent; }
      50% { background: rgba(239, 68, 68, 0.3); }
    }
    
    @keyframes flashGreen {
      0%, 100% { background: transparent; }
      50% { background: rgba(16, 185, 129, 0.2); }
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: scale(0.5); }
      10% { opacity: 1; transform: scale(1.1); }
      90% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.8); }
    }
    
    @keyframes particleFall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(500px) rotate(360deg); opacity: 0; }
    }
    
    @keyframes cyberpunkPulse {
      0%, 100% { box-shadow: 0 0 20px #10b981, 0 0 40px #3b82f6, 0 0 60px #10b981; }
      50% { box-shadow: 0 0 40px #10b981, 0 0 80px #3b82f6, 0 0 120px #10b981; }
    }
    
    @keyframes scanline {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(100%); }
    }
    
    .margin-effect-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .margin-positive-effect {
      font-size: 64px;
      font-weight: 900;
      color: #10b981;
      animation: glitchPositive 0.3s infinite, fadeInOut 3s ease-in-out forwards;
      text-transform: uppercase;
      letter-spacing: 4px;
      text-align: center;
      filter: drop-shadow(0 0 20px #10b981);
    }
    
    .margin-negative-effect {
      font-size: 64px;
      font-weight: 900;
      color: #ef4444;
      animation: glitchNegative 0.3s infinite, fadeInOut 3s ease-in-out forwards;
      text-transform: uppercase;
      letter-spacing: 4px;
      text-align: center;
      filter: drop-shadow(0 0 20px #ef4444);
    }
    
    .screen-flash-red {
      animation: flashRed 0.3s ease-in-out 3;
    }
    
    .screen-flash-green {
      animation: flashGreen 0.3s ease-in-out 3;
    }
    
    .screen-shake {
      animation: screenShake 0.5s ease-in-out 1;
    }
    
    .particle {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: particleFall 2s ease-in forwards;
    }
    
    .cyberpunk-border {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 600px;
      height: 300px;
      border: 3px solid #10b981;
      border-radius: 20px;
      animation: cyberpunkPulse 2s ease-in-out infinite, fadeInOut 3s ease-in-out forwards;
      pointer-events: none;
      z-index: 9998;
    }
    
    .cyberpunk-border::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, transparent, #10b981, transparent);
      animation: scanline 2s linear infinite;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="admin-header">
      <div class="admin-title">
        <h1>ZENOCCAZ ‚Äî Panneau d'administration</h1>
        <p class="tag">G√©rez le garage depuis ce panneau</p>
      </div>
      <div class="admin-actions">
        <a href="index.html" class="btn">Retour au site</a>
        <button id="admin-logout" class="btn">D√©connexion</button>
      </div>
    </div>
  </header>

  <!-- Barre d'administration simple (version deluxe) -->
  <nav class="admin-nav" role="navigation" aria-label="Barre d'administration">
    <div class="admin-nav-inner">
      <a class="admin-item" href="#dashboard" id="admin-dashboard-link">Administration</a>
      <a class="admin-item" href="#vehicules">V√©hicules</a>
      <a class="admin-item" href="#contacts">Contacts</a>
      <a class="admin-item" href="#chat">Chat IA</a>
      <a class="admin-item" href="#tache">T√¢che</a>
      <a class="admin-item" href="#evenements">√âv√©nements</a>
      <a class="admin-item" href="#finances">Finances</a>
      <a class="admin-item" href="#pieces">Pi√®ces</a>
      <a class="admin-item" href="#parrainages">Parrainages</a>
      <a class="admin-item" href="#expertises">Expertises</a>
      <a class="admin-item" href="#zenscan">ZenScan</a>
      <a class="admin-item" href="#reprises">Reprises</a>
      <a class="admin-item" href="#avis">Avis Clients</a>
      <a class="admin-item" href="#archives">üìÅ Archives</a>
    </div>
  </nav>

  <main style="max-width:1200px;margin:20px auto;padding:0 20px;">
    <div id="dashboard" class="admin-section admin-main">
      <!-- Dashboard header / quick stats -->
      <section class="dashboard-grid">
      <div class="stat-card">
        <div class="stat-left">
          <div class="stat-icon">üöó</div>
          <div>
            <div class="stat-label">V√©hicules</div>
            <div id="count-vehicules" class="stat-value">0</div>
          </div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-left">
          <div class="stat-icon">üë•</div>
          <div>
            <div class="stat-label">Contacts</div>
            <div id="count-contacts" class="stat-value">0</div>
          </div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-left">
          <div class="stat-icon">üóíÔ∏è</div>
          <div>
            <div class="stat-label">T√¢ches</div>
            <div id="count-taches" class="stat-value">0</div>
          </div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-left">
          <div class="stat-icon">üõí</div>
          <div>
            <div class="stat-label">Ventes</div>
            <div id="count-ventes" class="stat-value">0</div>
          </div>
        </div>
      </div>
    </section>

    <section class="dashboard-body">
      <div class="activity">
        <h3>Activit√© r√©cente</h3>
        <div id="activity-list" class="activity-list">
          <div class="activity-empty">Aucune activit√© r√©cente.</div>
        </div>
      </div>

      <aside class="stats-panel">
        <h3>Statistiques</h3>
        <div class="stats-row"><div class="stats-key">Taux de conversion</div><div class="stats-val" id="stat-conversion">‚Äî</div></div>
        <div class="stats-row"><div class="stats-key">Satisfaction client</div><div class="stats-val" id="stat-satisfaction">‚Äî</div></div>
        <div class="stats-row"><div class="stats-key">Temps moyen de vente</div><div class="stats-val" id="stat-delay">‚Äî</div></div>
      </aside>
    </section>

    </div><!-- end dashboard section -->
  </main>

  <!-- Gestion des v√©hicules: table d√©taill√©e (affich√©e au clic sur onglet V√©hicules) -->
  <section id="vehicules" class="admin-section hidden">
    <div class="admin-main" style="max-width:1200px;margin:20px auto;padding:0 20px;">
      <div class="section-header">
        <div>
          <h2 style="margin:0 0 6px;color:var(--text)">Gestion des v√©hicules</h2>
          <div class="muted">G√©rez les v√©hicules : modifier, supprimer ou ajouter</div>
        </div>
        <div>
          <button id="add-vehicle-admin" class="btn primary">+  Ajouter un v√©hicule</button>
        </div>
      </div>

      <div style="background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:12px;overflow:auto;">
        <table class="vehicles-table">
          <thead>
            <tr>
              <th>V√©hicule</th>
              <th>Prix</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="vehicles-table-body">
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Gestion des t√¢ches -->
  <section id="tache" class="admin-section hidden">
    <div class="admin-main" style="max-width:1200px;margin:20px auto;padding:0 20px;">
      <div class="section-header">
        <div>
          <h2 style="margin:0 0 6px;color:var(--text)">Gestion des t√¢ches</h2>
          <div class="muted">Organisez et suivez vos t√¢ches</div>
        </div>
        <div>
          <button id="add-task-admin" class="btn primary">+  Nouvelle t√¢che</button>
        </div>
      </div>

      <div style="background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:12px;overflow:auto;">
        <table class="tasks-table">
          <thead>
            <tr>
              <th>T√ÇCHE</th>
              <th>PRIORIT√â</th>
              <th>STATUT</th>
              <th>√âCH√âANCE</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody id="tasks-table-body">
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Gestion des contacts -->
  <section id="contacts" class="admin-section hidden">
    <div class="admin-main" style="max-width:1200px;margin:20px auto;padding:0 20px;">
      <div class="section-header">
        <div>
          <h2 style="margin:0 0 6px;color:var(--text)">Gestion des contacts</h2>
          <div class="muted">G√©rez les contacts et les prospects</div>
        </div>
        <div>
          <button id="add-contact-admin" class="btn primary">+  Nouveau contact</button>
        </div>
      </div>

      <div style="background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:12px;overflow:auto;">
        <table class="contacts-table">
          <thead>
            <tr>
              <th>CONTACT</th>
              <th>EMAIL</th>
              <th>T√âL√âPHONE</th>
              <th>DATE</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody id="contacts-table-body">
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Gestion des choix chat IA -->
  <section id="chat" class="admin-section hidden">
    <div class="admin-main" style="max-width:1200px;margin:20px auto;padding:0 20px;">
      <div class="section-header">
        <div>
          <h2 style="margin:0 0 6px;color:var(--text)">Choix Chat IA</h2>
          <div class="muted">Suivez les intentions des visiteurs via la chatbox</div>
        </div>
      </div>

      <!-- Filtres -->
      <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
        <button class="btn" id="chat-filter-all" style="background:var(--accent);color:#fff;" onclick="filterChatLeads('all')">Toutes</button>
        <button class="btn" id="chat-filter-active" style="background:rgba(255,255,255,0.08);" onclick="filterChatLeads('active')">Actives</button>
        <button class="btn" id="chat-filter-archived" style="background:rgba(255,255,255,0.08);" onclick="filterChatLeads('archived')">Archiv√©es</button>
      </div>

      <div style="background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:12px;overflow:auto;">
        <table class="contacts-table">
          <thead>
            <tr>
              <th>DATE</th>
              <th>CHOIX</th>
              <th>D√âTAILS</th>
              <th>STATUT</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody id="chat-leads-table-body">
          </tbody>
        </table>
      </div>
      
      <!-- Modal d√©tails -->
      <div id="chat-details-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;">
        <div style="background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:30px;max-width:600px;width:90%;max-height:80vh;overflow:auto;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3 style="margin:0;color:var(--text);">D√©tails complets</h3>
            <button id="close-chat-modal" style="background:transparent;border:none;color:#fff;font-size:24px;cursor:pointer;">&times;</button>
          </div>
          <div id="chat-details-content" style="color:var(--text);line-height:1.8;font-size:14px;"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Gestion des √©v√©nements / Ventes -->
  <section id="evenements" class="admin-section hidden">
    <div class="admin-main" style="max-width:1200px;margin:20px auto;padding:0 20px;">
      <div class="section-header">
        <div>
          <h2 style="margin:0 0 6px;color:var(--text)">Gestion des ventes</h2>
          <div class="muted">Suivez les ventes et les transactions</div>
        </div>
        <div>
          <button id="add-event-admin" class="btn primary">+  Nouvelle vente</button>
        </div>
      </div>

      <div style="background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:12px;overflow:auto;">
        <table class="events-table">
          <thead>
            <tr>
              <th>CLIENT</th>
              <th>V√âHICULE</th>
              <th>PRIX</th>
              <th>DATE</th>
              <th>STATUT</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody id="events-table-body">
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Gestion des finances -->
  <section id="finances" class="admin-section hidden">
    <div class="admin-main" style="max-width:1200px;margin:20px auto;padding:0 20px;">
      <div class="section-header">
        <div>
          <h2 style="margin:0 0 6px;color:var(--text)">Gestion financi√®re</h2>
          <div class="muted">Suivi des revenus, d√©penses et b√©n√©fices</div>
        </div>
      </div>

      <!-- KPI Cards -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-bottom:24px;">
        <div class="kpi-card">
          <div class="kpi-icon" style="color:#10b981;">‚Üë</div>
          <div class="kpi-label">Revenus totaux</div>
          <div class="kpi-value" id="finance-revenue">0 ‚Ç¨</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon" style="color:#ef4444;">‚Üì</div>
          <div class="kpi-label">D√©penses totales</div>
          <div class="kpi-value" id="finance-expenses" style="color:#ef4444;">0 ‚Ç¨</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon" style="color:#10b981;">‚óâ</div>
          <div class="kpi-label">B√©n√©fice net</div>
          <div class="kpi-value" id="finance-profit">0 ‚Ç¨</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon" style="color:#3b82f6;">%</div>
          <div class="kpi-label">Marge</div>
          <div class="kpi-value" id="finance-margin">0%</div>
        </div>
      </div>

      <!-- Calcul URSSAF Vente Voitures -->
      <div style="background:linear-gradient(135deg, rgba(16,185,129,0.05), rgba(59,130,246,0.05));border:1px solid rgba(16,185,129,0.2);padding:24px;border-radius:12px;margin-bottom:24px;">
        <h3 style="margin:0 0 20px;color:var(--text);display:flex;align-items:center;gap:8px;">
          <span style="font-size:24px;">üöó</span>
          Calcul des cotisations URSSAF - Vente voitures (12,6%)
        </h3>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;">
          <!-- Revenus vente voitures -->
          <div style="background:rgba(255,255,255,0.02);padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);">
            <div style="color:var(--muted);font-size:13px;margin-bottom:8px;">Revenus vente voitures</div>
            <div id="urssaf-vehicle-revenue" style="font-size:24px;font-weight:700;color:#10b981;">0,00 ‚Ç¨</div>
          </div>
          <!-- Cotisations URSSAF -->
          <div style="background:rgba(255,255,255,0.02);padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);">
            <div style="color:var(--muted);font-size:13px;margin-bottom:8px;">Cotisations URSSAF (12,6%)</div>
            <div id="urssaf-vehicle-tax" style="font-size:24px;font-weight:700;color:#f97316;">0,00 ‚Ç¨</div>
          </div>
          <!-- Marge nette apr√®s URSSAF -->
          <div style="background:linear-gradient(135deg, rgba(16,185,129,0.1), rgba(59,130,246,0.1));padding:16px;border-radius:8px;border:2px solid rgba(16,185,129,0.3);">
            <div style="color:var(--muted);font-size:13px;margin-bottom:8px;">Marge nette apr√®s URSSAF</div>
            <div id="urssaf-vehicle-net" style="font-size:24px;font-weight:700;color:#10b981;">0,00 ‚Ç¨</div>
            <div id="urssaf-vehicle-net-percent" style="font-size:12px;color:var(--muted);margin-top:4px;">0% du revenu brut</div>
          </div>
        </div>
        <div style="margin-top:16px;padding:12px;background:rgba(59,130,246,0.1);border-radius:8px;border-left:4px solid #3b82f6;">
          <div style="font-size:13px;color:var(--muted);">
            ‚ÑπÔ∏è <strong>Calcul :</strong> Revenus vente - (Revenus vente √ó 12,6%) = Marge nette vente voitures
          </div>
        </div>
      </div>

      <!-- Calcul URSSAF D√©pannage ZenScan -->
      <div style="background:linear-gradient(135deg, rgba(249,115,22,0.05), rgba(245,158,11,0.05));border:1px solid rgba(249,115,22,0.2);padding:24px;border-radius:12px;margin-bottom:24px;">
        <h3 style="margin:0 0 20px;color:var(--text);display:flex;align-items:center;gap:8px;">
          <span style="font-size:24px;">üîß</span>
          Calcul des cotisations URSSAF - D√©pannage ZenScan (21,4%)
        </h3>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;">
          <!-- Revenus d√©pannage -->
          <div style="background:rgba(255,255,255,0.02);padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);">
            <div style="color:var(--muted);font-size:13px;margin-bottom:8px;">Revenus d√©pannage ZenScan</div>
            <div id="urssaf-zenscan-revenue" style="font-size:24px;font-weight:700;color:#10b981;">0,00 ‚Ç¨</div>
          </div>
          <!-- Cotisations URSSAF -->
          <div style="background:rgba(255,255,255,0.02);padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);">
            <div style="color:var(--muted);font-size:13px;margin-bottom:8px;">Cotisations URSSAF (21,4%)</div>
            <div id="urssaf-zenscan-tax" style="font-size:24px;font-weight:700;color:#f97316;">0,00 ‚Ç¨</div>
          </div>
          <!-- Marge nette apr√®s URSSAF -->
          <div style="background:linear-gradient(135deg, rgba(16,185,129,0.1), rgba(59,130,246,0.1));padding:16px;border-radius:8px;border:2px solid rgba(16,185,129,0.3);">
            <div style="color:var(--muted);font-size:13px;margin-bottom:8px;">Marge nette apr√®s URSSAF</div>
            <div id="urssaf-zenscan-net" style="font-size:24px;font-weight:700;color:#10b981;">0,00 ‚Ç¨</div>
            <div id="urssaf-zenscan-net-percent" style="font-size:12px;color:var(--muted);margin-top:4px;">0% du revenu brut</div>
          </div>
        </div>
        <div style="margin-top:16px;padding:12px;background:rgba(249,115,22,0.1);border-radius:8px;border-left:4px solid #f97316;">
          <div style="font-size:13px;color:var(--muted);">
            ‚ÑπÔ∏è <strong>Calcul :</strong> Revenus d√©pannage - (Revenus d√©pannage √ó 21,4%) = Marge nette d√©pannage
          </div>
        </div>
      </div>

      <!-- Total des marges nettes -->
      <div style="background:linear-gradient(135deg, rgba(16,185,129,0.15), rgba(6,182,212,0.15));border:2px solid rgba(16,185,129,0.4);padding:28px;border-radius:16px;margin-bottom:24px;box-shadow:0 8px 32px rgba(16,185,129,0.2);">
        <h3 style="margin:0 0 24px;color:var(--text);display:flex;align-items:center;gap:12px;font-size:24px;">
          <span style="font-size:32px;">üí∞</span>
          <span>Total des marges nettes apr√®s URSSAF</span>
        </h3>
        <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:24px;">
          <!-- Marge nette vente voitures -->
          <div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
            <div style="color:var(--muted);font-size:14px;margin-bottom:8px;display:flex;align-items:center;gap:6px;">
              <span>üöó</span> Vente voitures
            </div>
            <div id="total-vehicle-margin" style="font-size:28px;font-weight:700;color:#10b981;">0,00 ‚Ç¨</div>
          </div>
          <!-- Marge nette d√©pannage -->
          <div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
            <div style="color:var(--muted);font-size:14px;margin-bottom:8px;display:flex;align-items:center;gap:6px;">
              <span>üîß</span> D√©pannage ZenScan
            </div>
            <div id="total-zenscan-margin" style="font-size:28px;font-weight:700;color:#10b981;">0,00 ‚Ç¨</div>
          </div>
          <!-- Total global -->
          <div style="background:linear-gradient(135deg, rgba(16,185,129,0.2), rgba(6,182,212,0.2));padding:20px;border-radius:12px;border:2px solid rgba(16,185,129,0.5);">
            <div style="color:var(--text);font-size:14px;margin-bottom:8px;font-weight:600;">TOTAL GLOBAL</div>
            <div id="total-global-margin" style="font-size:32px;font-weight:800;color:#10b981;">0,00 ‚Ç¨</div>
          </div>
        </div>
      </div>

      <!-- Finance operations list -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;">
        <div style="background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:16px;border-radius:12px;">
          <h3 style="margin:0 0 16px;color:var(--text)">V√©hicules vendus</h3>
          <div id="finance-vehicles" style="min-height:100px;">
            <div class="activity-empty">Aucun v√©hicule vendu.</div>
          </div>
        </div>
        <div style="background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:16px;border-radius:12px;">
          <h3 style="margin:0 0 16px;color:var(--text)">V√©hicules achet√©s</h3>
          <div id="finance-reprises" style="min-height:100px;">
            <div class="activity-empty">Aucun v√©hicule achet√©.</div>
          </div>
        </div>
        <div style="background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:16px;border-radius:12px;">
          <h3 style="margin:0 0 16px;color:var(--text)">Achats de pi√®ces</h3>
          <div id="finance-parts" style="min-height:100px;">
            <div class="activity-empty">Aucun achat de pi√®ce.</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Gestion des pi√®ces -->
  <section id="pieces" class="admin-section hidden">
    <div class="admin-main" style="max-width:1200px;margin:20px auto;padding:0 20px;">
      <div class="section-header">
        <div>
          <h2 style="margin:0 0 6px;color:var(--text)">Gestion des pi√®ces</h2>
          <div class="muted">G√©rez l'inventaire des pi√®ces d√©tach√©es</div>
        </div>
        <div>
          <button id="add-piece-admin" class="btn primary">+  Ajouter une pi√®ce</button>
        </div>
      </div>

      <div style="background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:12px;overflow:auto;">
        <table class="pieces-table" style="border-spacing:0 8px;border-collapse:separate;">
          <thead>
            <tr>
              <th style="padding:12px 16px;text-align:left;">PI√àCE</th>
              <th style="padding:12px 16px;text-align:left;">R√âF√âRENCE</th>
              <th style="padding:12px 16px;text-align:left;">PRIX</th>
              <th style="padding:12px 16px;text-align:left;">STOCK</th>
              <th style="padding:12px 16px;text-align:right;">ACTIONS</th>
            </tr>
          </thead>
          <tbody id="pieces-table-body">
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Gestion des parrainages -->
  <section id="parrainages" class="admin-section hidden">
    <div class="admin-main" style="max-width:1200px;margin:20px auto;padding:0 20px;">
      <div class="section-header">
        <div>
          <h2 style="margin:0 0 6px;color:var(--text)">Gestion des parrainages</h2>
          <div class="muted">Suivez vos parrains et les conversions</div>
        </div>
        <div>
          <button id="add-parrainage-admin" class="btn primary">+  Ajouter un parrain</button>
        </div>
      </div>

      <!-- KPI Cards -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-bottom:24px;">
        <div class="kpi-card">
          <div class="kpi-icon" style="color:#3b82f6;">üë§</div>
          <div class="kpi-label">Parrains actifs</div>
          <div class="kpi-value" id="parrainage-count">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon" style="color:#10b981;">‚úì</div>
          <div class="kpi-label">Conversions</div>
          <div class="kpi-value" id="parrainage-conversions">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon" style="color:#a855f7;">üí∞</div>
          <div class="kpi-label">Commissions</div>
          <div class="kpi-value" id="parrainage-commissions">0 ‚Ç¨</div>
        </div>
      </div>

      <div style="background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:12px;overflow:auto;">
        <table class="parrainage-table">
          <thead>
            <tr>
              <th>PARRAIN</th>
              <th>FILLEUL</th>
              <th>R√âCOMPENSE</th>
              <th>STATUT</th>
              <th>COMMISSION</th>
              <th>DATE</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody id="parrainage-table-body">
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Gestion des demandes ZenScan -->
  <section id="zenscan" class="admin-section hidden">
    <div class="admin-main" style="max-width:1200px;margin:20px auto;padding:0 20px;">
      <div class="section-header">
        <div>
          <h2 style="margin:0 0 6px;color:var(--text)">Demandes ZenScan</h2>
          <div class="muted">Liste des demandes de diagnostic enregistr√©es par les clients</div>
        </div>
      </div>

      <div style="background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:12px;overflow:auto;">
        <table class="zenscan-table">
          <thead>
            <tr>
              <th>REF</th>
              <th>CLIENT</th>
              <th>SERVICES</th>
              <th>DESTINATION</th>
              <th>TOTAL</th>
              <th>DATE</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody id="zenscan-table-body">
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Gestion des Expertises -->
  <section id="expertises" class="admin-section hidden">
    <div class="admin-main" style="max-width:1200px;margin:20px auto;padding:0 20px;">
      <div class="section-header">
        <div>
          <h2 style="margin:0 0 6px;color:var(--text)">Nos Expertises</h2>
          <div class="muted">Domaines de comp√©tences et services propos√©s</div>
        </div>
      </div>

      <!-- Grille des expertises -->
      <div style="display:grid;gap:24px;">
        
        <!-- Diagnostic & R√©paration -->
        <div style="background:linear-gradient(135deg, rgba(239,68,68,0.05), rgba(239,68,68,0.02));border:1px solid rgba(239,68,68,0.2);border-radius:16px;padding:28px;transition:transform 0.3s,box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 40px rgba(239,68,68,0.15)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
            <div style="width:56px;height:56px;background:linear-gradient(135deg,#ef4444,#dc2626);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 4px 12px rgba(239,68,68,0.3);">üîß</div>
            <div>
              <h3 style="margin:0;color:#ef4444;font-size:22px;font-weight:700;">Diagnostic & R√©paration</h3>
              <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Expertise technique compl√®te</p>
            </div>
          </div>
          <div style="display:grid;gap:12px;">
            <div style="display:flex;align-items:start;gap:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;">
              <span style="color:#ef4444;font-size:18px;flex-shrink:0;">üî©</span>
              <div>
                <div style="color:var(--text);font-weight:600;margin-bottom:2px;">Pannes m√©caniques/√©lectroniques</div>
                <div style="color:var(--muted);font-size:13px;">Diagnostic pr√©cis et r√©paration rapide</div>
              </div>
            </div>
            <div style="display:flex;align-items:start;gap:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;">
              <span style="color:#ef4444;font-size:18px;flex-shrink:0;">üõ†Ô∏è</span>
              <div>
                <div style="color:var(--text);font-weight:600;margin-bottom:2px;">Entretien courant</div>
                <div style="color:var(--muted);font-size:13px;">Vidange, freins, pneus, batteries</div>
              </div>
            </div>
            <div style="display:flex;align-items:start;gap:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;">
              <span style="color:#ef4444;font-size:18px;flex-shrink:0;">‚úÖ</span>
              <div>
                <div style="color:var(--text);font-weight:600;margin-bottom:2px;">R√©parations cibl√©es pour fiabilit√©</div>
                <div style="color:var(--muted);font-size:13px;">Solutions durables et garanties</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Revente & Valorisation -->
        <div style="background:linear-gradient(135deg, rgba(245,158,11,0.05), rgba(245,158,11,0.02));border:1px solid rgba(245,158,11,0.2);border-radius:16px;padding:28px;transition:transform 0.3s,box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 40px rgba(245,158,11,0.15)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
            <div style="width:56px;height:56px;background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 4px 12px rgba(245,158,11,0.3);">üí∞</div>
            <div>
              <h3 style="margin:0;color:#f59e0b;font-size:22px;font-weight:700;">Revente & Valorisation</h3>
              <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Optimisation de la valeur de revente</p>
            </div>
          </div>
          <div style="display:grid;gap:12px;">
            <div style="display:flex;align-items:start;gap:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;">
              <span style="color:#f59e0b;font-size:18px;flex-shrink:0;">üíé</span>
              <div>
                <div style="color:var(--text);font-weight:600;margin-bottom:2px;">Estimation juste de la valeur</div>
                <div style="color:var(--muted);font-size:13px;">√âvaluation professionnelle bas√©e sur le march√©</div>
              </div>
            </div>
            <div style="display:flex;align-items:start;gap:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;">
              <span style="color:#f59e0b;font-size:18px;flex-shrink:0;">‚ú®</span>
              <div>
                <div style="color:var(--text);font-weight:600;margin-bottom:2px;">Pr√©paration √† la vente</div>
                <div style="color:var(--muted);font-size:13px;">CT, nettoyage, conformit√©</div>
              </div>
            </div>
            <div style="display:flex;align-items:start;gap:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;">
              <span style="color:#f59e0b;font-size:18px;flex-shrink:0;">üìà</span>
              <div>
                <div style="color:var(--text);font-weight:600;margin-bottom:2px;">Conseils pour optimiser la revente</div>
                <div style="color:var(--muted);font-size:13px;">Strat√©gies pour maximiser votre prix de vente</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Conseil & Formation -->
        <div style="background:linear-gradient(135deg, rgba(59,130,246,0.05), rgba(59,130,246,0.02));border:1px solid rgba(59,130,246,0.2);border-radius:16px;padding:28px;transition:transform 0.3s,box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 40px rgba(59,130,246,0.15)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
            <div style="width:56px;height:56px;background:linear-gradient(135deg,#3b82f6,#2563eb);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 4px 12px rgba(59,130,246,0.3);">üìö</div>
            <div>
              <h3 style="margin:0;color:#3b82f6;font-size:22px;font-weight:700;">Conseil & Formation</h3>
              <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Accompagnement et pr√©vention</p>
            </div>
          </div>
          <div style="display:grid;gap:12px;">
            <div style="display:flex;align-items:start;gap:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;">
              <span style="color:#3b82f6;font-size:18px;flex-shrink:0;">üìñ</span>
              <div>
                <div style="color:var(--text);font-weight:600;margin-bottom:2px;">Guides pratiques d'entretien</div>
                <div style="color:var(--muted);font-size:13px;">Documentation et conseils personnalis√©s</div>
              </div>
            </div>
            <div style="display:flex;align-items:start;gap:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;">
              <span style="color:#3b82f6;font-size:18px;flex-shrink:0;">üõ°Ô∏è</span>
              <div>
                <div style="color:var(--text);font-weight:600;margin-bottom:2px;">Sensibilisation s√©curit√© routi√®re</div>
                <div style="color:var(--muted);font-size:13px;">Formation et bonnes pratiques</div>
              </div>
            </div>
            <div style="display:flex;align-items:start;gap:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;">
              <span style="color:#3b82f6;font-size:18px;flex-shrink:0;">üí°</span>
              <div>
                <div style="color:var(--text);font-weight:600;margin-bottom:2px;">Optimisation des co√ªts</div>
                <div style="color:var(--muted);font-size:13px;">Carburant, assurance, entretien</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Gestion des Reprises -->
  <section id="reprises" class="admin-section hidden">
    <div class="admin-main" style="max-width:1200px;margin:20px auto;padding:0 20px;">
      <div class="section-header">
        <div>
          <h2 style="margin:0 0 6px;color:var(--text)">Gestion des Reprises</h2>
          <div class="muted">Processus de rachat et v√©hicules repris</div>
        </div>
        <button onclick="openReprisesModal()" class="btn-primary" style="padding:12px 24px;background:linear-gradient(135deg,#10b981,#059669);border:none;color:#fff;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 12px rgba(16,185,129,0.3);">
          + V√©hicule Repris
        </button>
      </div>

      <!-- √âtapes du processus de reprise -->
      <div style="display:grid;gap:20px;margin-bottom:40px;">
        
        <!-- √âvaluation & Estimation -->
        <div style="background:linear-gradient(135deg, rgba(59,130,246,0.05), rgba(59,130,246,0.02));border:1px solid rgba(59,130,246,0.2);border-radius:12px;padding:20px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="width:44px;height:44px;background:linear-gradient(135deg,#3b82f6,#2563eb);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 10px rgba(59,130,246,0.3);">üìä</div>
            <div>
              <h3 style="margin:0;color:#3b82f6;font-size:18px;font-weight:700;">√âvaluation & Estimation</h3>
              <p style="margin:2px 0 0;color:var(--muted);font-size:12px;">Analyse compl√®te du v√©hicule</p>
            </div>
          </div>
          <div style="display:flex;gap:16px;flex-wrap:wrap;">
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(255,255,255,0.02);border-radius:6px;">
              <span style="color:#3b82f6;">üìã</span>
              <span style="color:var(--text);font-size:13px;">Diagnostic complet de l'√©tat du v√©hicule</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(255,255,255,0.02);border-radius:6px;">
              <span style="color:#3b82f6;">üìã</span>
              <span style="color:var(--text);font-size:13px;">V√©rification kilom√©trage, carnet d'entretien, historique</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(255,255,255,0.02);border-radius:6px;">
              <span style="color:#3b82f6;">üìã</span>
              <span style="color:var(--text);font-size:13px;">Estimation juste et transparente de la valeur</span>
            </div>
          </div>
        </div>

        <!-- Contr√¥le & Conformit√© -->
        <div style="background:linear-gradient(135deg, rgba(16,185,129,0.05), rgba(16,185,129,0.02));border:1px solid rgba(16,185,129,0.2);border-radius:12px;padding:20px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="width:44px;height:44px;background:linear-gradient(135deg,#10b981,#059669);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 10px rgba(16,185,129,0.3);">‚úÖ</div>
            <div>
              <h3 style="margin:0;color:#10b981;font-size:18px;font-weight:700;">Contr√¥le & Conformit√©</h3>
              <p style="margin:2px 0 0;color:var(--muted);font-size:12px;">V√©rifications r√©glementaires</p>
            </div>
          </div>
          <div style="display:flex;gap:16px;flex-wrap:wrap;">
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(255,255,255,0.02);border-radius:6px;">
              <span style="color:#10b981;">‚òëÔ∏è</span>
              <span style="color:var(--text);font-size:13px;">V√©rification du contr√¥le technique</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(255,255,255,0.02);border-radius:6px;">
              <span style="color:#10b981;">‚òëÔ∏è</span>
              <span style="color:var(--text);font-size:13px;">Mise en conformit√© si n√©cessaire</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(255,255,255,0.02);border-radius:6px;">
              <span style="color:#10b981;">‚òëÔ∏è</span>
              <span style="color:var(--text);font-size:13px;">V√©rification des papiers (carte grise, certificat de non-gage, assurance)</span>
            </div>
          </div>
        </div>

        <!-- Proc√©dure Administrative -->
        <div style="background:linear-gradient(135deg, rgba(245,158,11,0.05), rgba(245,158,11,0.02));border:1px solid rgba(245,158,11,0.2);border-radius:12px;padding:20px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="width:44px;height:44px;background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 10px rgba(245,158,11,0.3);">üìù</div>
            <div>
              <h3 style="margin:0;color:#f59e0b;font-size:18px;font-weight:700;">Proc√©dure Administrative</h3>
              <p style="margin:2px 0 0;color:var(--muted);font-size:12px;">Formalit√©s simplifi√©es</p>
            </div>
          </div>
          <div style="display:flex;gap:16px;flex-wrap:wrap;">
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(255,255,255,0.02);border-radius:6px;">
              <span style="color:#f59e0b;">üìÑ</span>
              <span style="color:var(--text);font-size:13px;">Gestion int√©grale des d√©marches de cession</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(255,255,255,0.02);border-radius:6px;">
              <span style="color:#f59e0b;">üìÑ</span>
              <span style="color:var(--text);font-size:13px;">Simplification des formalit√©s pour le vendeur</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(255,255,255,0.02);border-radius:6px;">
              <span style="color:#f59e0b;">üìÑ</span>
              <span style="color:var(--text);font-size:13px;">S√©curisation juridique de la transaction</span>
            </div>
          </div>
        </div>

      </div>

      <!-- Tableau des v√©hicules repris -->
      <div class="section-header" style="margin-top:30px;">
        <h3 style="margin:0;color:var(--text);font-size:18px;">V√©hicules Repris</h3>
      </div>
      <div id="reprises-table" style="margin-top:16px;"></div>
    </div>
  </section>

  <!-- Gestion des Avis Clients -->
  <section id="avis" class="admin-section hidden">
    <div class="admin-main" style="max-width:1200px;margin:20px auto;padding:0 20px;">
      <div class="section-header">
        <div>
          <h2 style="margin:0 0 6px;color:var(--text)">Gestion des Avis Clients</h2>
          <div class="muted">Mod√©rez les avis publi√©s par vos clients</div>
        </div>
      </div>

      <!-- Statistiques des avis -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:30px;">
        <div style="background:rgba(255,255,255,0.02);padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);">
          <div style="color:var(--muted);font-size:13px;margin-bottom:8px;">Total avis</div>
          <div id="avis-total" style="font-size:24px;font-weight:700;color:#10b981;">0</div>
        </div>
        <div style="background:rgba(255,255,255,0.02);padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);">
          <div style="color:var(--muted);font-size:13px;margin-bottom:8px;">Note moyenne</div>
          <div id="avis-average" style="font-size:24px;font-weight:700;color:#f59e0b;">0 ‚≠ê</div>
        </div>
        <div style="background:rgba(255,255,255,0.02);padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);">
          <div style="color:var(--muted);font-size:13px;margin-bottom:8px;">5 √©toiles</div>
          <div id="avis-5stars" style="font-size:24px;font-weight:700;color:#10b981;">0</div>
        </div>
        <div style="background:rgba(255,255,255,0.02);padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);">
          <div style="color:var(--muted);font-size:13px;margin-bottom:8px;">1-2 √©toiles</div>
          <div id="avis-lowstars" style="font-size:24px;font-weight:700;color:#ef4444;">0</div>
        </div>
      </div>

      <!-- Tableau des avis -->
      <div id="avis-table" style="margin-top:16px;"></div>
    </div>
  </section>

  <!-- Archives Mensuelles -->
  <section id="archives" class="admin-section hidden">
    <div class="admin-main" style="max-width:1200px;margin:20px auto;padding:0 20px;">
      <div class="section-header">
        <div>
          <h2 style="margin:0 0 6px;color:var(--text)">üìÅ Archives Financi√®res Mensuelles</h2>
          <div class="muted">Consultez et t√©l√©chargez les rapports financiers archiv√©s</div>
        </div>
      </div>

      <!-- Liste des archives -->
      <div id="archives-list" style="margin-top:24px;display:grid;gap:16px;"></div>
    </div>
  </section>

  <!-- Modal: D√©tails ZenScan -->
  <div id="zenscan-details-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:700px;">
      <h2 style="margin:0 0 20px;color:var(--text);font-size:20px;">üìù D√©tails de la demande ZenScan</h2>
      <div id="zenscan-details-content" style="display:grid;gap:16px;"></div>
      <div style="margin-top:24px;text-align:right;">
        <button id="zenscan-details-close" class="btn" style="padding:10px 24px;">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Modal: D√©tails Reprise -->
  <div id="reprise-details-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:900px;max-height:90vh;overflow-y:auto;">
      <h2 style="margin:0 0 20px;color:var(--text);font-size:20px;">üöó D√©tails du v√©hicule repris</h2>
      <div id="reprise-details-content" style="display:grid;gap:20px;"></div>
      <div style="margin-top:24px;text-align:right;">
        <button id="reprise-details-close" class="btn" style="padding:10px 24px;">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Modal: V√©hicule Repris Form -->
  <div id="reprises-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:800px;max-height:90vh;overflow-y:auto;">
      <h2 id="reprises-modal-title">Ajouter un v√©hicule repris</h2>
      <form id="reprises-form" style="display:grid;gap:16px;margin-top:16px;">
        <input type="hidden" id="reprise-edit-id" value="">
        
        <!-- Informations du v√©hicule -->
        <h3 style="margin:16px 0 8px;color:var(--text);border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:8px;">Informations du v√©hicule</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div class="field"><label>Marque *</label><input id="rep-make" required /></div>
          <div class="field"><label>Mod√®le *</label><input id="rep-model" required /></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
          <div class="field"><label>Ann√©e *</label><input id="rep-year" type="number" required placeholder="2020" /></div>
          <div class="field"><label>Kilom√©trage (km) *</label><input id="rep-mileage" type="number" required placeholder="80000" /></div>
          <div class="field">
            <label>Carburant *</label>
            <select id="rep-fuel" required style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:#1a1a2e;border-radius:6px;color:#e0e0e0;">
              <option value="" style="background:#1a1a2e;color:#e0e0e0;">--S√©lectionner--</option>
              <option value="Essence" style="background:#1a1a2e;color:#e0e0e0;">Essence</option>
              <option value="Diesel" style="background:#1a1a2e;color:#e0e0e0;">Diesel</option>
              <option value="Hybride" style="background:#1a1a2e;color:#e0e0e0;">Hybride</option>
              <option value="√âlectrique" style="background:#1a1a2e;color:#e0e0e0;">√âlectrique</option>
              <option value="GPL" style="background:#1a1a2e;color:#e0e0e0;">GPL</option>
            </select>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div class="field"><label>Immatriculation *</label><input id="rep-immat" required placeholder="AA-123-BB" /></div>
          <div class="field"><label>N¬∞ de s√©rie (VIN)</label><input id="rep-vin" placeholder="WV1ZZZ..." /></div>
        </div>

        <!-- Informations du vendeur -->
        <h3 style="margin:16px 0 8px;color:var(--text);border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:8px;">Informations du vendeur</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div class="field"><label>Nom complet *</label><input id="rep-seller-name" required /></div>
          <div class="field"><label>T√©l√©phone</label><input id="rep-seller-phone" type="tel" placeholder="+33..." /></div>
        </div>
        <div class="field">
          <label>Email</label>
          <input id="rep-seller-email" type="email" placeholder="vendeur@email.com" />
        </div>
        <div class="field">
          <label>Adresse</label>
          <textarea id="rep-seller-address" rows="2" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);" placeholder="Adresse compl√®te du vendeur..."></textarea>
        </div>

        <!-- Transaction -->
        <h3 style="margin:16px 0 8px;color:var(--text);border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:8px;">Transaction</h3>
        <div class="field">
          <label>Nom de l'acheteur *</label>
          <input id="rep-buyer-name" required placeholder="Nom du garage / entreprise qui rach√®te" />
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
          <div class="field">
            <label>Prix d'achat (‚Ç¨) *</label>
            <input id="rep-purchase-price" type="number" required placeholder="8000" />
          </div>
          <div class="field">
            <label>Date de rachat *</label>
            <input id="rep-purchase-date" type="date" required />
          </div>
          <div class="field">
            <label>Statut *</label>
            <select id="rep-status" required style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:#1a1a2e;border-radius:6px;color:#e0e0e0;">
              <option value="Achet√©" style="background:#1a1a2e;color:#e0e0e0;">Achet√©</option>
              <option value="En r√©paration" style="background:#1a1a2e;color:#e0e0e0;">En r√©paration</option>
              <option value="Pr√™t √† la vente" style="background:#1a1a2e;color:#e0e0e0;">Pr√™t √† la vente</option>
              <option value="Vendu" style="background:#1a1a2e;color:#e0e0e0;">Vendu</option>
            </select>
          </div>
        </div>

        <!-- Documents et √©tat -->
        <h3 style="margin:16px 0 8px;color:var(--text);border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:8px;">Documents & √âtat</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div class="field">
            <label>Contr√¥le technique</label>
            <select id="rep-ct" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:#1a1a2e;border-radius:6px;color:#e0e0e0;">
              <option value="" style="background:#1a1a2e;color:#e0e0e0;">--Non sp√©cifi√©--</option>
              <option value="Valide" style="background:#1a1a2e;color:#e0e0e0;">Valide</option>
              <option value="√Ä faire" style="background:#1a1a2e;color:#e0e0e0;">√Ä faire</option>
              <option value="Contre-visite" style="background:#1a1a2e;color:#e0e0e0;">Contre-visite n√©cessaire</option>
            </select>
          </div>
          <div class="field">
            <label>Carnet d'entretien</label>
            <select id="rep-carnet" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:#1a1a2e;border-radius:6px;color:#e0e0e0;">
              <option value="" style="background:#1a1a2e;color:#e0e0e0;">--Non sp√©cifi√©--</option>
              <option value="Complet" style="background:#1a1a2e;color:#e0e0e0;">Complet</option>
              <option value="Partiel" style="background:#1a1a2e;color:#e0e0e0;">Partiel</option>
              <option value="Absent" style="background:#1a1a2e;color:#e0e0e0;">Absent</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label>Documents fournis</label>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px;">
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="doc-carte-grise" value="Carte grise"> Carte grise</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="doc-certificat" value="Certificat de cession"> Certificat de cession</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="doc-non-gage" value="Certificat de non-gage"> Certificat de non-gage</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="doc-ct" value="Contr√¥le technique"> Contr√¥le technique</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="doc-factures" value="Factures d'entretien"> Factures d'entretien</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="doc-2cles" value="2 cl√©s"> 2 cl√©s</label>
          </div>
        </div>

        <!-- √âtat g√©n√©ral -->
        <div class="field">
          <label>√âtat g√©n√©ral du v√©hicule</label>
          <select id="rep-condition" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:#1a1a2e;border-radius:6px;color:#e0e0e0;">
            <option value="" style="background:#1a1a2e;color:#e0e0e0;">--Non √©valu√©--</option>
            <option value="Excellent" style="background:#1a1a2e;color:#e0e0e0;">Excellent</option>
            <option value="Tr√®s bon" style="background:#1a1a2e;color:#e0e0e0;">Tr√®s bon</option>
            <option value="Bon" style="background:#1a1a2e;color:#e0e0e0;">Bon</option>
            <option value="Moyen" style="background:#1a1a2e;color:#e0e0e0;">Moyen</option>
            <option value="√Ä r√©nover" style="background:#1a1a2e;color:#e0e0e0;">√Ä r√©nover</option>
          </select>
        </div>

        <!-- Notes et observations -->
        <div class="field">
          <label>Notes et observations</label>
          <textarea id="rep-notes" rows="4" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);" placeholder="Remarques sur l'√©tat, travaux √† pr√©voir, etc..."></textarea>
        </div>
        
        <div class="modal-actions" style="margin-top:16px;">
          <button type="button" onclick="closeReprisesModal()" class="btn-secondary">Annuler</button>
          <button type="submit" class="btn-primary">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Add Vehicle Form -->
  <div id="vehicle-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:800px;max-height:90vh;overflow-y:auto;">
      <h2 id="vehicle-modal-title">Ajouter un v√©hicule</h2>
      <form id="vehicle-form" style="display:grid;gap:16px;margin-top:16px;">
        <input type="hidden" id="vehicle-edit-id" value="">
        
        <!-- Informations de base -->
        <h3 style="margin:16px 0 8px;color:var(--text);border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:8px;">Informations de base</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div class="field"><label>Marque *</label><input id="veh-make" required /></div>
          <div class="field"><label>Mod√®le *</label><input id="veh-model" required /></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
          <div class="field"><label>Ann√©e *</label><input id="veh-year" type="number" required placeholder="2024" /></div>
          <div class="field"><label>Prix (‚Ç¨) *</label><input id="veh-price" type="number" required placeholder="15000" /></div>
          <div class="field"><label>Kilom√©trage (km)</label><input id="veh-mileage" type="number" placeholder="50000" /></div>
        </div>
        
        <!-- Caract√©ristiques techniques -->
        <h3 style="margin:16px 0 8px;color:var(--text);border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:8px;">Caract√©ristiques</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
          <div class="field">
            <label>Carburant</label>
            <select id="veh-fuel" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);">
              <option value="">--</option>
              <option value="Essence">Essence</option>
              <option value="Diesel">Diesel</option>
              <option value="√âlectrique">√âlectrique</option>
              <option value="Hybride">Hybride</option>
              <option value="GPL">GPL</option>
            </select>
          </div>
          <div class="field">
            <label>Transmission</label>
            <select id="veh-transmission" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);">
              <option value="">--</option>
              <option value="Manuelle">Manuelle</option>
              <option value="Automatique">Automatique</option>
              <option value="Semi-automatique">Semi-automatique</option>
            </select>
          </div>
          <div class="field"><label>Couleur</label><input id="veh-color" placeholder="Noir" /></div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
          <div class="field"><label>Portes</label><input id="veh-doors" type="number" placeholder="5" /></div>
          <div class="field"><label>Places</label><input id="veh-seats" type="number" placeholder="5" /></div>
          <div class="field"><label>Puissance (ch)</label><input id="veh-horsepower" type="number" placeholder="110" /></div>
          <div class="field">
            <label>√âtat</label>
            <select id="veh-condition" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);">
              <option value="Excellent">Excellent</option>
              <option value="Bon">Bon</option>
              <option value="Correct">Correct</option>
            </select>
          </div>
        </div>
        
        <!-- Historique -->
        <h3 style="margin:16px 0 8px;color:var(--text);border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:8px;">Historique & Garantie</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
          <div class="field"><label>Num√©ro de s√©rie (VIN)</label><input id="veh-vin" placeholder="1HGBH41JXMN109186" /></div>
          <div class="field"><label>Date 1√®re immatriculation</label><input id="veh-registration" type="date" /></div>
          <div class="field"><label>Nb propri√©taires pr√©c√©dents</label><input id="veh-owners" type="number" placeholder="1" /></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div class="field"><label>Date contr√¥le technique</label><input id="veh-technical" type="date" /></div>
          <div class="field"><label>Garantie (mois)</label><input id="veh-warranty" type="number" placeholder="12" /></div>
        </div>
        
        <!-- √âquipements -->
        <h3 style="margin:16px 0 8px;color:var(--text);border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:8px;">√âquipements</h3>
        <div class="field">
          <label>S√©lectionnez les √©quipements</label>
          <div id="features-checkboxes" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px;">
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="feature-gps" value="GPS"> GPS</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="feature-ac" value="Climatisation"> Climatisation</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="feature-cruise" value="R√©gulateur de vitesse"> R√©gulateur</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="feature-camera" value="Cam√©ra de recul"> Cam√©ra recul</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="feature-radar" value="Radar de recul"> Radar recul</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="feature-bluetooth" value="Bluetooth"> Bluetooth</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="feature-heated-seats" value="Si√®ges chauffants"> Si√®ges chauffants</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="feature-panoramic" value="Toit panoramique"> Toit panoramique</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="feature-alloy" value="Jantes alliage"> Jantes alliage</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="feature-audio" value="Syst√®me audio premium"> Audio premium</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="feature-led" value="Phares LED"> Phares LED</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="feature-parking" value="Aide au stationnement"> Aide stationnement</label>
          </div>
        </div>
        
        <!-- Description et images -->
        <h3 style="margin:16px 0 8px;color:var(--text);border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:8px;">Description & Photos</h3>
        <div class="field">
          <label>Description d√©taill√©e</label>
          <textarea id="veh-desc" rows="4" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);" placeholder="D√©crivez le v√©hicule en d√©tail..."></textarea>
        </div>
        <div class="field">
          <label>Images actuelles</label>
          <div id="current-images-preview" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-bottom:12px;"></div>
        </div>
        <div class="field">
          <label>Ajouter des images (plusieurs photos possibles)</label>
          <input id="veh-images" type="file" accept="image/*" multiple style="padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);" />
          <p style="margin:8px 0 0;font-size:13px;color:var(--muted);">Les nouvelles images s'ajouteront aux images existantes (Ctrl+clic pour s√©lection multiple)</p>
        </div>
        
        <div class="modal-actions" style="margin-top:16px;">
          <button type="submit" class="btn primary">üíæ Enregistrer</button>
          <button type="button" id="vehicle-cancel" class="btn">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Prix de vente -->
  <div id="sale-price-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:400px;">
      <h2 style="margin:0 0 20px;color:var(--text);font-size:20px;">üí∞ Prix de vente</h2>
      <form id="sale-price-form" style="display:grid;gap:16px;">
        <input type="hidden" id="sale-vehicle-id" />
        <input type="hidden" id="sale-vehicle-name" />
        <div class="field">
          <label style="display:block;margin-bottom:8px;color:var(--text);font-weight:600;">√Ä quel prix avez-vous vendu ce v√©hicule ?</label>
          <input id="sale-price-input" type="number" step="0.01" required placeholder="Ex: 15000" style="width:100%;padding:12px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);font-size:16px;" />
          <p style="margin:8px 0 0;font-size:13px;color:var(--muted);">Ce montant sera ajout√© aux finances</p>
        </div>
        <div class="modal-actions" style="display:flex;gap:12px;margin-top:8px;">
          <button type="submit" class="btn primary" style="flex:1;">‚úÖ Confirmer la vente</button>
          <button type="button" id="sale-price-cancel" class="btn" style="flex:1;">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Add Contact Form -->
  <div id="contact-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:600px;">
      <h2>Ajouter un contact</h2>
      <form id="contact-form" style="display:grid;gap:12px;margin-top:16px;">
        <div class="field"><label>Nom *</label><input id="cont-name" required /></div>
        <div class="field"><label>Email</label><input id="cont-email" type="email" /></div>
        <div class="field"><label>T√©l√©phone</label><input id="cont-phone" type="tel" /></div>
        <div class="modal-actions">
          <button type="submit" class="btn primary">Ajouter</button>
          <button type="button" id="contact-cancel" class="btn">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Add Task Form -->
  <div id="task-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:600px;">
      <h2 id="task-modal-title">Ajouter une t√¢che</h2>
      <form id="task-form" style="display:grid;gap:12px;margin-top:16px;">
        <input type="hidden" id="task-id" />
        <div class="field"><label>Titre *</label><input id="task-title" required /></div>
        <div class="field"><label>Description</label><textarea id="task-desc" rows="3" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);"></textarea></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div class="field"><label>Priorit√©</label><select id="task-priority" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);"><option style="background:#1a1a2e;color:#e0e0e0;">Basse</option><option style="background:#1a1a2e;color:#e0e0e0;">Moyenne</option><option style="background:#1a1a2e;color:#e0e0e0;">Haute</option></select></div>
          <div class="field"><label>Statut</label><select id="task-status" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);"><option style="background:#1a1a2e;color:#e0e0e0;">√Ä faire</option><option style="background:#1a1a2e;color:#e0e0e0;">En cours</option><option style="background:#1a1a2e;color:#e0e0e0;">Fait</option></select></div>
        </div>
        <div class="field"><label>√âch√©ance</label><input id="task-due" type="date" /></div>
        <div class="modal-actions">
          <button type="submit" class="btn primary" id="task-submit-btn">Ajouter</button>
          <button type="button" id="task-cancel" class="btn">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Add Event/Sale Form -->
  <div id="event-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:600px;">
      <h2>Ajouter une vente</h2>
      <form id="event-form" style="display:grid;gap:12px;margin-top:16px;">
        <div class="field"><label>Client *</label><input id="event-client" required /></div>
        <div class="field"><label>V√©hicule *</label><input id="event-vehicle" required /></div>
        <div class="field"><label>Prix (‚Ç¨) *</label><input id="event-price" type="number" required /></div>
        <div class="field"><label>Statut</label><select id="event-status" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);"><option>En cours</option><option>Compl√©t√©e</option><option>Annul√©e</option></select></div>
        <div class="modal-actions">
          <button type="submit" class="btn primary">Ajouter</button>
          <button type="button" id="event-cancel" class="btn">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Add Piece Form -->
  <div id="piece-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:600px;">
      <h2>Ajouter une pi√®ce</h2>
      <form id="piece-form" style="display:grid;gap:12px;margin-top:16px;">
        <div class="field"><label>Nom *</label><input id="piece-name" required /></div>
        <div class="field"><label>R√©f√©rence</label><input id="piece-ref" /></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div class="field"><label>Prix (‚Ç¨) *</label><input id="piece-price" type="number" required /></div>
          <div class="field"><label>Stock</label><input id="piece-stock" type="number" placeholder="0" /></div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn primary">Ajouter</button>
          <button type="button" id="piece-cancel" class="btn">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Add Parrainage Form -->
  <div id="parrainage-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:600px;">
      <h2 id="parrainage-modal-title">Ajouter un parrainage</h2>
      <form id="parrainage-form" style="display:grid;gap:12px;margin-top:16px;">
        <input type="hidden" id="parr-id" />
        <div class="field"><label>Parrain *</label><input id="parr-parrain" required /></div>
        <div class="field"><label>Email du parrain</label><input id="parr-email" type="email" /></div>
        <div class="field"><label>Filleul</label><input id="parr-filleul" /></div>
        <div class="field">
          <label>Type de r√©compense *</label>
          <select id="parr-reward" required style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);">
            <option value="bon_125" style="background:#1a1a2e;color:#e0e0e0;">Bon d'achat de 125‚Ç¨</option>
            <option value="vidange_75" style="background:#1a1a2e;color:#e0e0e0;">Bon vidange/autre √† 75‚Ç¨</option>
          </select>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div class="field"><label>Statut</label><select id="parr-status" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);"><option style="background:#1a1a2e;color:#e0e0e0;">Actif</option><option style="background:#1a1a2e;color:#e0e0e0;">Fini</option><option style="background:#1a1a2e;color:#e0e0e0;">Archiv√©</option></select></div>
          <div class="field"><label>Commission (‚Ç¨)</label><input id="parr-commission" type="number" placeholder="0" /></div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn primary" id="parrainage-submit-btn">Ajouter</button>
          <button type="button" id="parrainage-cancel" class="btn">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Add Finance Form -->
  <div id="finance-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:600px;">
      <h2>Ajouter une op√©ration financi√®re</h2>
      <form id="finance-form" style="display:grid;gap:12px;margin-top:16px;">
        <div class="field"><label>Description *</label><input id="fin-desc" required /></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div class="field"><label>Type</label><select id="fin-type" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);"><option value="revenue">Revenu</option><option value="expense">D√©pense</option></select></div>
          <div class="field"><label>Montant (‚Ç¨) *</label><input id="fin-amount" type="number" required /></div>
        </div>
        <div class="field"><label>Cat√©gorie</label><select id="fin-category" style="width:100%;padding:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);border-radius:6px;color:var(--text);"><option value="vehicle">V√©hicule</option><option value="parts">Pi√®ces</option><option value="other">Autre</option></select></div>
        <div class="modal-actions">
          <button type="submit" class="btn primary">Ajouter</button>
          <button type="button" id="finance-cancel" class="btn">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <footer class="site-footer">¬© ZENOCCAZ ‚Äî Panneau administrateur</footer>

  <!-- Charger Supabase depuis le CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script type="module">
    try {
      console.log('üîÑ D√©but du chargement Supabase...');
      
      // Attendre que la lib Supabase soit charg√©e
      if (typeof window.supabase === 'undefined' && typeof supabase === 'undefined') {
        throw new Error('Biblioth√®que Supabase non charg√©e depuis le CDN');
      }
      
      // Import de la config
      const config = await import('./supabase-config.js');
      console.log('‚úÖ Configuration import√©e');
      
      // Cr√©er le client Supabase
      const { createClient } = window.supabase || supabase;
      const supabaseClient = createClient(config.SUPABASE_URL, config.SUPABASE_ANON_KEY);
      console.log('‚úÖ Client Supabase cr√©√©');
      
      // Cr√©er les fonctions helper
      window.supabase = supabaseClient;
      window.supabaseClient = {
        supabase: supabaseClient,
        
        async fetchVehicles() {
          const { data, error } = await supabaseClient.from('vehicles').select('*').order('created_at', { ascending: false });
          return { data: data || [], error };
        },
        
        async insertVehicle(vehicle) {
          const payload = {
            id: vehicle.id,
            make: vehicle.make || null,
            model: vehicle.model || null,
            year: vehicle.year || null,
            price: parseFloat(vehicle.price) || null,
            description: vehicle.description || null,
            image: vehicle.image || null,
            created_at: vehicle.date || new Date().toISOString()
          };
          return await supabaseClient.from('vehicles').insert([payload]);
        },
        
        async deleteVehicle(id) {
          return await supabaseClient.from('vehicles').delete().eq('id', id);
        },
        
        async uploadVehicleImage(file, vehicleId) {
          const ext = file.name.split('.').pop();
          const fileName = `${vehicleId}_${Date.now()}.${ext}`;
          const { data, error } = await supabaseClient.storage.from('vehicle-images').upload(fileName, file);
          if(error) return { data: null, error };
          const { data: urlData } = supabaseClient.storage.from('vehicle-images').getPublicUrl(fileName);
          return { data: urlData?.publicUrl || null, error: null };
        }
      };
      
      console.log('‚úÖ Supabase client charg√© et expos√©');
      console.log('üì¶ URL:', config.SUPABASE_URL);
      
      // D√©clencher l'√©v√©nement personnalis√©
      window.dispatchEvent(new Event('supabaseReady'));
      
    } catch (error) {
      console.error('‚ùå Erreur lors du chargement de Supabase:', error);
      console.error('‚ùå Message:', error.message);
      console.error('‚ùå Stack:', error.stack);
      
      alert('‚ùå Erreur de chargement Supabase:\n\n' + error.message + '\n\nV√©rifiez la console (F12) pour plus de d√©tails.');
    }
  </script>
  
  <script>
    (function(){
      try{
        const admin = localStorage.getItem('zenoccaz_admin')
        if(admin !== '1'){
          window.location.replace('index.html')
        }
      }catch(e){ window.location.replace('index.html') }
    })();

    document.addEventListener('DOMContentLoaded', ()=>{
      // Attendre l'√©v√©nement supabaseReady
      if (window.supabaseClient) {
        console.log('‚úÖ Supabase d√©j√† disponible');
        initAdmin();
      } else {
        console.log('‚è≥ Attente du chargement de Supabase...');
        window.addEventListener('supabaseReady', () => {
          console.log('‚úÖ √âv√©nement supabaseReady re√ßu');
          initAdmin();
        }, { once: true });
        
        // Timeout de s√©curit√©
        setTimeout(() => {
          if (!window.supabaseClient) {
            console.error('‚ùå Timeout: Supabase non charg√©');
            alert('‚ö†Ô∏è Erreur de chargement Supabase.\n\nOuvrez la console (F12) pour voir les d√©tails.\n\nV√©rifiez que supabase-config.js existe et contient votre cl√© API.');
          }
        }, 5000);
      }
    });

    // Fonction globale pour supprimer un avis (doit √™tre hors de initAdmin)
    window.deleteReview = async function(id){
      if(!confirm('‚ùå Supprimer d√©finitivement cet avis client ?')) return
      try{
        if(!window.supabase){
          alert('‚ùå Erreur: Supabase non initialis√©');
          return;
        }
        const { error } = await window.supabase.from('reviews').delete().eq('id', id);
        if(error){
          console.error('‚ùå Erreur suppression:', error);
          alert('‚ùå Erreur lors de la suppression');
          return;
        }
        console.log('‚úÖ Avis supprim√©');
        // Recharger les avis
        if(window.loadReviewsAdmin){
          await window.loadReviewsAdmin();
        }
      }catch(e){
        console.error('‚ùå Exception:', e);
        alert('‚ùå Exception lors de la suppression');
      }
    }

    function initAdmin(){
      const logout = document.getElementById('admin-logout')
      const addAdminBtn = document.getElementById('add-vehicle-admin')
      const tbody = document.getElementById('vehicles-table-body')
      const activity = document.getElementById('activity-list')
      const vehiculesSection = document.getElementById('vehicules')
      const vehiculesLink = document.querySelector('a[href="#vehicules"]')
      const navItems = document.querySelectorAll('.admin-nav .admin-item')

      function triggerLavaEffect(el){
        if(!el) return
        el.classList.remove('lava-burst')
        void el.offsetWidth
        el.classList.add('lava-burst')
        setTimeout(()=> el.classList.remove('lava-burst'), 800)
      }

      navItems.forEach(item=>{
        item.addEventListener('click', ()=> {
          triggerLavaEffect(item)
          document.body.classList.add('admin-fire-text')
        })
      })

      // Cacher toutes les sections, afficher le dashboard par d√©faut
      function hideAllSections(){
        const sections = document.querySelectorAll('.admin-section')
        sections.forEach(s=> s.classList.add('hidden'))
      }

      // Afficher la section V√©hicules au clic
      if(vehiculesLink){
        vehiculesLink.addEventListener('click', async (e)=>{
          e.preventDefault()
          hideAllSections()
          vehiculesSection.classList.remove('hidden')
          await renderVehiclesTable()
        })
      }

      // Afficher le dashboard au clic sur Administration
      const dashboardLink = document.getElementById('admin-dashboard-link')
      const dashboardSection = document.getElementById('dashboard')
      if(dashboardLink){
        dashboardLink.addEventListener('click', (e)=>{
          e.preventDefault()
          hideAllSections()
          dashboardSection.classList.remove('hidden')
        })
      }

      if(logout) logout.addEventListener('click', ()=>{
        try{ localStorage.setItem('zenoccaz_admin','0') }catch(e){}
        window.location.replace('index.html')
      })

      async function loadVehicles(){
        try{
          if(window.supabaseClient && window.supabaseClient.fetchVehicles){
            const { data, error } = await window.supabaseClient.fetchVehicles();
            if(error){
              console.error('‚ùå Erreur chargement v√©hicules:', error);
              return [];
            }
            console.log('‚úÖ V√©hicules charg√©s depuis Supabase:', data.length);
            return data || [];
          }
          return [];
        }catch(e){
          console.error('‚ùå Exception loadVehicles:', e);
          return [];
        }
      }

      function saveVehicles(arr){
        // Deprecated: maintenant tout passe par Supabase
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c])
      }

      async function renderVehiclesTable(){
        const arr = await loadVehicles()
        tbody.innerHTML = ''
        if(arr.length===0){
          const tr = document.createElement('tr')
          tr.innerHTML = '<td colspan="4" class="activity-empty">Aucun v√©hicule.</td>'
          tbody.appendChild(tr)
          return
        }
        arr.forEach(v=>{
          const tr = document.createElement('tr')
          tr.className = 'vehicle-row'
          const statusText = v.status || 'Disponible'
          const statusColors = {
            'Disponible': {bg: 'rgba(16,185,129,0.12)', color: '#10b981'},
            'Vendu': {bg: 'rgba(245,158,11,0.12)', color: '#f59e0b'},
            'Archiv√©': {bg: 'rgba(107,114,128,0.12)', color: '#6b7280'}
          }
          const statusStyle = statusColors[statusText] || statusColors['Disponible']
          tr.innerHTML = `<td><div class="vehicle-cell-title"><div class="vehicle-avatar">üöó</div><div><div class="vehicle-meta-title">${escapeHtml(v.make||'‚Äî')} ${escapeHtml(v.model||'')}</div><div class="vehicle-meta-sub">${escapeHtml(v.year||'')} ‚Äî ${escapeHtml(v.description||'')}</div></div></div></td><td>${escapeHtml(v.price||'')} ‚Ç¨</td><td><span class="status-pill" style="background:${statusStyle.bg};color:${statusStyle.color}">${statusText}</span></td><td><div class="action-links" style="display:flex;gap:8px;"><span class="edit" data-id="${v.id}" title="Modifier" style="cursor:pointer;padding:6px 10px;background:rgba(16,185,129,0.1);border-radius:6px;font-size:16px;transition:all 0.2s;">‚úèÔ∏è</span><span class="sold" data-id="${v.id}" data-price="${v.price}" data-vehicle="${escapeHtml(v.make||'')} ${escapeHtml(v.model||'')}" title="Marquer comme vendu" style="cursor:pointer;padding:6px 10px;background:rgba(245,158,11,0.1);border-radius:6px;font-size:16px;transition:all 0.2s;">üí∞</span><span class="archive" data-id="${v.id}" title="Archiver" style="cursor:pointer;padding:6px 10px;background:rgba(107,114,128,0.1);border-radius:6px;font-size:16px;transition:all 0.2s;">üì¶</span><span class="del" data-id="${v.id}" title="Supprimer" style="cursor:pointer;padding:6px 10px;background:rgba(239,68,68,0.1);border-radius:6px;font-size:16px;transition:all 0.2s;">üóëÔ∏è</span></div></td>`
          tbody.appendChild(tr)
        })

        tbody.querySelectorAll('.edit').forEach(el=> el.addEventListener('click', (e)=>{
          const id = Number(e.target.dataset.id)
          editVehicle(id)
        }))
        tbody.querySelectorAll('.sold').forEach(el=> el.addEventListener('click', (e)=>{
          const id = Number(e.target.dataset.id)
          const vehicle = e.target.dataset.vehicle
          openSalePriceModal(id, vehicle)
        }))
        tbody.querySelectorAll('.archive').forEach(el=> el.addEventListener('click', (e)=>{
          const id = Number(e.target.dataset.id)
          archiveVehicle(id)
        }))
        tbody.querySelectorAll('.del').forEach(el=> el.addEventListener('click', (e)=>{
          const id = Number(e.target.dataset.id)
          deleteVehicle(id)
        }))
      }

      async function updateDashboard(){
        const arr = await loadVehicles()
        document.getElementById('count-vehicules').textContent = arr.length
        activity.innerHTML = ''
        if(arr.length===0){ activity.innerHTML = '<div class="activity-empty">Aucune activit√© r√©cente.</div>' }
        else{
          arr.slice(0,6).forEach(v=>{
            const it = document.createElement('div')
            it.className = 'activity-item'
            it.innerHTML = `<div class="act-icon">üöó</div><div><div style="font-weight:600">${escapeHtml(v.make||'‚Äî')} ${escapeHtml(v.model||'')}</div><div class="muted" style="font-size:13px;margin-top:4px">Ajout√© ‚Äî ${escapeHtml(v.year||'')} ‚Äî ${escapeHtml(v.price||'')} ‚Ç¨</div></div>`
            activity.appendChild(it)
          })
        }
      }

      const vehicleModal = document.getElementById('vehicle-modal')
      const vehicleForm = document.getElementById('vehicle-form')
      const vehicleCancel = document.getElementById('vehicle-cancel')

      // Variable globale pour stocker les images √† supprimer et les images existantes
      let currentVehicleImages = []
      let imagesToDelete = []

      function removeImage(index){
        if(confirm('Supprimer cette image ?')){
          imagesToDelete.push(index)
          // Rafra√Æchir la pr√©visualisation
          const previewContainer = document.getElementById('current-images-preview')
          previewContainer.innerHTML = ''
          currentVehicleImages.forEach((imgUrl, i) => {
            if(imagesToDelete.includes(i)) return // Skip deleted images
            const imgWrapper = document.createElement('div')
            imgWrapper.style.cssText = 'position:relative;width:100%;padding-bottom:100%;border-radius:8px;overflow:hidden;border:2px solid rgba(255,255,255,0.1);'
            imgWrapper.innerHTML = `
              <img src="${imgUrl}" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;">
              <button type="button" onclick="removeImage(${i})" style="position:absolute;top:4px;right:4px;background:rgba(255,0,0,0.8);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:16px;line-height:1;padding:0;">√ó</button>
            `
            previewContainer.appendChild(imgWrapper)
          })
          if(previewContainer.children.length === 0){
            previewContainer.innerHTML = '<p style="color:var(--muted);font-size:13px;">Aucune image (ajoutez-en ci-dessous)</p>'
          }
        }
      }

      function openVehicleModal(){
        vehicleModal.classList.remove('hidden')
        vehicleModal.setAttribute('aria-hidden','false')
        vehicleForm.reset()
        document.getElementById('vehicle-edit-id').value = '' // Mode ajout
        document.getElementById('vehicle-modal-title').textContent = 'Ajouter un v√©hicule'
        document.getElementById('current-images-preview').innerHTML = '' // Vider la pr√©visualisation
        currentVehicleImages = []
        imagesToDelete = []
        document.getElementById('veh-make').focus()
      }

      function closeVehicleModal(){
        vehicleModal.classList.add('hidden')
        vehicleModal.setAttribute('aria-hidden','true')
      }

      vehicleCancel.addEventListener('click', closeVehicleModal)
      vehicleModal.addEventListener('click', (e)=>{ if(e.target === vehicleModal) closeVehicleModal() })

      vehicleForm.addEventListener('submit', async (e)=>{
        e.preventDefault()
        
        // D√©tecter le mode (ajout ou √©dition)
        const editId = document.getElementById('vehicle-edit-id').value
        const isEdit = editId !== ''
        console.log(isEdit ? '‚úèÔ∏è D√©but modification v√©hicule ID:' + editId : 'üöÄ D√©but ajout v√©hicule...')
        
        // R√©cup√©rer tous les champs
        const make = document.getElementById('veh-make').value.trim()
        const model = document.getElementById('veh-model').value.trim()
        const year = document.getElementById('veh-year').value.trim()
        const price = document.getElementById('veh-price').value.trim()
        const description = document.getElementById('veh-desc').value.trim()
        
        // Caract√©ristiques
        const mileage = document.getElementById('veh-mileage').value || null
        const fuel_type = document.getElementById('veh-fuel').value || null
        const transmission = document.getElementById('veh-transmission').value || null
        const color = document.getElementById('veh-color').value || null
        const doors = document.getElementById('veh-doors').value || null
        const seats = document.getElementById('veh-seats').value || null
        const horsepower = document.getElementById('veh-horsepower').value || null
        const condition = document.getElementById('veh-condition').value || 'Occasion'
        
        // Historique
        const vin = document.getElementById('veh-vin').value || null
        const registration_date = document.getElementById('veh-registration').value || null
        const previous_owners = document.getElementById('veh-owners').value || null
        const technical_control_date = document.getElementById('veh-technical').value || null
        const warranty_months = document.getElementById('veh-warranty').value || null
        
        // √âquipements
        const features = []
        if(document.getElementById('feature-gps').checked) features.push('GPS')
        if(document.getElementById('feature-ac').checked) features.push('Climatisation')
        if(document.getElementById('feature-cruise').checked) features.push('R√©gulateur de vitesse')
        if(document.getElementById('feature-camera').checked) features.push('Cam√©ra de recul')
        if(document.getElementById('feature-radar').checked) features.push('Radar de recul')
        if(document.getElementById('feature-bluetooth').checked) features.push('Bluetooth')
        if(document.getElementById('feature-heated-seats').checked) features.push('Si√®ges chauffants')
        if(document.getElementById('feature-panoramic').checked) features.push('Toit panoramique')
        if(document.getElementById('feature-alloy').checked) features.push('Jantes alliage')
        if(document.getElementById('feature-audio').checked) features.push('Syst√®me audio premium')
        if(document.getElementById('feature-led').checked) features.push('Phares LED')
        if(document.getElementById('feature-parking').checked) features.push('Aide au stationnement')
        
        if(!make || !model || !year || !price){
          alert('‚ùå Marque, mod√®le, ann√©e et prix sont obligatoires')
          return
        }
        
        // V√©rifier si supabaseClient existe
        if(!window.supabaseClient){
          alert('‚ùå Erreur: Supabase non initialis√©')
          return
        }
        
        // En mode √©dition, partir des images existantes et retirer celles √† supprimer
        let existingImages = []
        if(isEdit){
          existingImages = currentVehicleImages.filter((img, index) => !imagesToDelete.includes(index))
          console.log('üñºÔ∏è Images conserv√©es:', existingImages)
        }
        
        // Upload des nouvelles images
        const imageFiles = document.getElementById('veh-images').files
        let newImageUrls = []
        const vehicleId = isEdit ? editId : Date.now()
        
        if(imageFiles.length > 0 && window.supabaseClient.uploadVehicleImage){
          for(let i = 0; i < imageFiles.length; i++){
            try{
              console.log(`üì∏ Upload image ${i+1}/${imageFiles.length}...`)
              const { data, error } = await window.supabaseClient.uploadVehicleImage(imageFiles[i], `${vehicleId}_${Date.now()}_${i}`)
              if(error){
                console.error('‚ùå Erreur upload:', error)
              } else if(data){
                newImageUrls.push(data)
                console.log(`‚úÖ Image ${i+1} upload√©e`)
              }
            }catch(err){
              console.error('‚ùå Exception upload:', err)
            }
          }
        }
        
        // Combiner les images existantes + nouvelles images
        const imageUrls = [...existingImages, ...newImageUrls]
        console.log('üì¶ Total images:', imageUrls.length, '(existantes:', existingImages.length, '+ nouvelles:', newImageUrls.length, ')')
        
        const vehicleData = {
          make,
          model,
          year: parseInt(year),
          price: parseFloat(price),
          description,
          image: imageUrls[0] || null,
          images: imageUrls,
          mileage: mileage ? parseInt(mileage) : null,
          fuel_type,
          transmission,
          color,
          doors: doors ? parseInt(doors) : null,
          seats: seats ? parseInt(seats) : null,
          horsepower: horsepower ? parseInt(horsepower) : null,
          condition,
          features,
          vin,
          registration_date,
          previous_owners: previous_owners ? parseInt(previous_owners) : null,
          technical_control_date,
          warranty_months: warranty_months ? parseInt(warranty_months) : null
        }
        
        if(!isEdit){
          vehicleData.id = vehicleId
        }
        
        console.log('üìù Donn√©es:', vehicleData)
        
        try{
          if(isEdit){
            // MODE √âDITION
            console.log('üíæ Mise √† jour dans Supabase...')
            const result = await window.supabase.from('vehicles').update(vehicleData).eq('id', editId).select()
            console.log('üìä R√©sultat:', result)
            
            if(result && result.error){
              console.error('‚ùå Erreur Supabase:', result.error)
              alert('‚ùå Erreur:\n' + result.error.message + '\n\nüí° Ex√©cutez supabase-migration-vehicle-details.sql pour ajouter les nouvelles colonnes')
              return
            }
            
            console.log('‚úÖ V√©hicule modifi√© avec succ√®s')
            alert('‚úÖ V√©hicule modifi√© avec succ√®s!')
          }else{
            // MODE AJOUT
            console.log('üíæ Insertion dans Supabase...')
            const result = await window.supabase.from('vehicles').insert([vehicleData])
            console.log('üìä R√©sultat:', result)
            
            if(result && result.error){
              console.error('‚ùå Erreur Supabase:', result.error)
              alert('‚ùå Erreur:\n' + result.error.message + '\n\nüí° Ex√©cutez supabase-migration-vehicle-details.sql pour ajouter les nouvelles colonnes')
              return
            }
            
            console.log('‚úÖ V√©hicule ajout√© avec succ√®s')
            alert('‚úÖ V√©hicule ajout√© avec succ√®s!')
          }
        }catch(e){
          console.error('‚ùå Exception:', e)
          alert('‚ùå Erreur: ' + e.message)
          return
        }
        
        console.log('üîÑ Rafra√Æchissement...')
        await renderVehiclesTable()
        await updateDashboard()
        closeVehicleModal()
        console.log('‚úÖ Op√©ration termin√©e')
      })

      function addVehicleAdmin(){ openVehicleModal() }

      async function editVehicle(id){
        console.log('‚úèÔ∏è √âdition v√©hicule ID:', id);
        try{
          // Charger les donn√©es du v√©hicule depuis Supabase
          const { data, error } = await window.supabase.from('vehicles').select('*').eq('id', id).single();
          if(error){
            console.error('‚ùå Erreur chargement v√©hicule:', error);
            alert('‚ùå Erreur lors du chargement du v√©hicule');
            return;
          }
          const v = data;
          console.log('üìã Donn√©es v√©hicule charg√©es:', v);
          
          // Pr√©-remplir le formulaire
          document.getElementById('vehicle-edit-id').value = v.id;
          document.getElementById('vehicle-modal-title').textContent = 'Modifier le v√©hicule';
          document.getElementById('veh-make').value = v.make || '';
          document.getElementById('veh-model').value = v.model || '';
          document.getElementById('veh-year').value = v.year || '';
          document.getElementById('veh-price').value = v.price || '';
          document.getElementById('veh-mileage').value = v.mileage || '';
          document.getElementById('veh-fuel').value = v.fuel_type || 'Essence';
          document.getElementById('veh-transmission').value = v.transmission || 'Manuelle';
          document.getElementById('veh-color').value = v.color || '';
          document.getElementById('veh-doors').value = v.doors || '';
          document.getElementById('veh-seats').value = v.seats || '';
          document.getElementById('veh-horsepower').value = v.horsepower || '';
          document.getElementById('veh-condition').value = v.condition || 'Occasion';
          document.getElementById('veh-vin').value = v.vin || '';
          document.getElementById('veh-registration').value = v.registration_date || '';
          document.getElementById('veh-owners').value = v.previous_owners || '';
          document.getElementById('veh-technical').value = v.technical_control_date || '';
          document.getElementById('veh-warranty').value = v.warranty_months || '';
          document.getElementById('veh-desc').value = v.description || '';
          
          // Cocher les √©quipements
          const features = v.features || [];
          document.getElementById('feature-gps').checked = features.includes('GPS');
          document.getElementById('feature-ac').checked = features.includes('Climatisation');
          document.getElementById('feature-cruise').checked = features.includes('R√©gulateur de vitesse');
          document.getElementById('feature-camera').checked = features.includes('Cam√©ra de recul');
          document.getElementById('feature-radar').checked = features.includes('Radar de recul');
          document.getElementById('feature-bluetooth').checked = features.includes('Bluetooth');
          document.getElementById('feature-heated-seats').checked = features.includes('Si√®ges chauffants');
          document.getElementById('feature-panoramic').checked = features.includes('Toit panoramique');
          document.getElementById('feature-alloy').checked = features.includes('Jantes alliage');
          document.getElementById('feature-audio').checked = features.includes('Syst√®me audio premium');
          document.getElementById('feature-led').checked = features.includes('Phares LED');
          document.getElementById('feature-parking').checked = features.includes('Aide au stationnement');
          
          // Afficher les images existantes avec option de suppression
          currentVehicleImages = v.images || []
          if(currentVehicleImages.length === 0 && v.image) currentVehicleImages = [v.image]
          imagesToDelete = []
          
          const previewContainer = document.getElementById('current-images-preview')
          previewContainer.innerHTML = ''
          if(currentVehicleImages.length > 0){
            currentVehicleImages.forEach((imgUrl, index) => {
              const imgWrapper = document.createElement('div')
              imgWrapper.style.cssText = 'position:relative;width:100%;padding-bottom:100%;border-radius:8px;overflow:hidden;border:2px solid rgba(255,255,255,0.1);'
              imgWrapper.innerHTML = `
                <img src="${imgUrl}" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;">
                <button type="button" onclick="removeImage(${index})" style="position:absolute;top:4px;right:4px;background:rgba(255,0,0,0.8);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:16px;line-height:1;padding:0;">√ó</button>
              `
              previewContainer.appendChild(imgWrapper)
            })
          } else {
            previewContainer.innerHTML = '<p style="color:var(--muted);font-size:13px;">Aucune image pour ce v√©hicule</p>'
          }
          
          // Ouvrir le modal
          vehicleModal.classList.remove('hidden');
          vehicleModal.setAttribute('aria-hidden','false');
          document.getElementById('veh-make').focus();
          
        }catch(e){
          console.error('‚ùå Exception editVehicle:', e);
          alert('‚ùå Erreur: ' + e.message);
        }
      }

      async function deleteVehicle(id){
        if(!confirm('Supprimer ce v√©hicule ?')) return
        console.log('üóëÔ∏è Suppression du v√©hicule ID:', id);
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }

          // 1. R√©cup√©rer les infos du v√©hicule avant suppression
          const { data: vehicle, error: fetchError } = await window.supabase
            .from('vehicles')
            .select('*')
            .eq('id', id)
            .single();

          if(fetchError){
            console.error('‚ùå Erreur r√©cup√©ration v√©hicule:', fetchError);
            alert('‚ùå Erreur lors de la r√©cup√©ration du v√©hicule');
            return;
          }

          // 2. Si le v√©hicule √©tait vendu, trouver et supprimer l'entr√©e de finance
          if(vehicle && vehicle.status === 'Vendu'){
            console.log('üí∞ V√©hicule vendu d√©tect√© (ID:', id, '), suppression de l\'entr√©e finance...');
            
            // Rechercher l'entr√©e de finance par vehicle_id
            const { data: financeEntries, error: financeSearchError } = await window.supabase
              .from('finances')
              .select('*')
              .eq('vehicle_id', id);

            if(financeSearchError){
              console.error('‚ùå Erreur recherche finance:', financeSearchError);
            } else if(financeEntries && financeEntries.length > 0){
              console.log('‚úÖ Trouv√©', financeEntries.length, 'entr√©e(s) finance √† supprimer');
              // Supprimer toutes les entr√©es correspondantes (normalement 1 seule)
              for(const entry of financeEntries){
                const { error: financeDeleteError } = await window.supabase
                  .from('finances')
                  .delete()
                  .eq('id', entry.id);

                if(financeDeleteError){
                  console.error('‚ùå Erreur suppression finance ID', entry.id, ':', financeDeleteError);
                } else {
                  console.log('‚úÖ Entr√©e finance ID', entry.id, 'supprim√©e (montant:', entry.amount, '‚Ç¨)');
                }
              }
            } else {
              console.log('‚ö†Ô∏è Aucune entr√©e finance trouv√©e pour vehicle_id:', id);
            }
          }

          // 3. Supprimer le v√©hicule
          if(window.supabaseClient && window.supabaseClient.deleteVehicle){
            const result = await window.supabaseClient.deleteVehicle(id);
            if(result && result.error){
              console.error('‚ùå Erreur suppression:', result.error);
              alert('‚ùå Erreur lors de la suppression: ' + result.error.message);
              return;
            }
            console.log('‚úÖ V√©hicule supprim√©');
            alert('‚úÖ V√©hicule et finances mises √† jour!');
          }
        }catch(e){
          console.error('‚ùå Exception deleteVehicle:', e);
          alert('‚ùå Erreur: ' + e.message);
          return;
        }
        await renderVehiclesTable();
        await updateDashboard();
      }

      // Modal prix de vente
      const salePriceModal = document.getElementById('sale-price-modal')
      const salePriceForm = document.getElementById('sale-price-form')
      const salePriceCancel = document.getElementById('sale-price-cancel')

      function openSalePriceModal(id, vehicleName){
        document.getElementById('sale-vehicle-id').value = id
        document.getElementById('sale-vehicle-name').value = vehicleName
        document.getElementById('sale-price-input').value = ''
        salePriceModal.classList.remove('hidden')
        salePriceModal.setAttribute('aria-hidden', 'false')
        document.getElementById('sale-price-input').focus()
      }

      function closeSalePriceModal(){
        salePriceModal.classList.add('hidden')
        salePriceModal.setAttribute('aria-hidden', 'true')
      }

      salePriceCancel.addEventListener('click', closeSalePriceModal)
      salePriceModal.addEventListener('click', (e)=>{ if(e.target === salePriceModal) closeSalePriceModal() })

      salePriceForm.addEventListener('submit', async (e)=>{
        e.preventDefault()
        const id = Number(document.getElementById('sale-vehicle-id').value)
        const vehicleName = document.getElementById('sale-vehicle-name').value
        const price = parseFloat(document.getElementById('sale-price-input').value)
        closeSalePriceModal()
        await markVehicleAsSold(id, price, vehicleName)
      })

      async function markVehicleAsSold(id, price, vehicleName){
        console.log('üí∞ Vente du v√©hicule ID:', id, 'Prix:', price);
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }
          
          // 1. Mettre √† jour le statut du v√©hicule
          const { error: updateError } = await window.supabase
            .from('vehicles')
            .update({ status: 'Vendu' })
            .eq('id', id);
          
          if(updateError){
            console.error('‚ùå Erreur mise √† jour v√©hicule:', updateError);
            alert('‚ùå Erreur lors de la mise √† jour du v√©hicule');
            return;
          }
          
          // 2. Ajouter une transaction dans finances
          const financeId = Date.now();
          const financeEntry = {
            id: financeId,
            description: `Vente v√©hicule: ${vehicleName}`,
            type: 'revenue',
            amount: parseFloat(price),
            category: 'vehicle',
            vehicle_id: id
          }
          
          const { error: financeError } = await window.supabase
            .from('finances')
            .insert([financeEntry]);
          
          if(financeError){
            console.error('‚ùå Erreur ajout finance:', financeError);
            alert('‚ùå Erreur lors de l\'ajout dans les finances');
            return;
          }
          
          console.log('‚úÖ V√©hicule vendu et finances mises √† jour');
          alert('‚úÖ V√©hicule vendu ! Montant ajout√© aux finances.');
          
          await renderVehiclesTable();
          await updateDashboard();
        }catch(e){
          console.error('‚ùå Exception markVehicleAsSold:', e);
          alert('‚ùå Erreur: ' + e.message);
        }
      }

      async function archiveVehicle(id){
        if(!confirm('Archiver ce v√©hicule ?')) return
        console.log('üì¶ Archivage du v√©hicule ID:', id);
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }
          
          const { error } = await window.supabase
            .from('vehicles')
            .update({ status: 'Archiv√©' })
            .eq('id', id);
          
          if(error){
            console.error('‚ùå Erreur archivage:', error);
            alert('‚ùå Erreur lors de l\'archivage');
            return;
          }
          
          console.log('‚úÖ V√©hicule archiv√©');
          alert('‚úÖ V√©hicule archiv√© avec succ√®s!');
          
          await renderVehiclesTable();
          await updateDashboard();
        }catch(e){
          console.error('‚ùå Exception archiveVehicle:', e);
          alert('‚ùå Erreur: ' + e.message);
        }
      }

      // ====== GESTION DES CONTACTS ======
      const contactsTbody = document.getElementById('contacts-table-body')
      const addContactBtn = document.getElementById('add-contact-admin')
      const contactsSection = document.getElementById('contacts')
      const contactsLink = document.querySelector('a[href="#contacts"]')
      const chatLeadsTbody = document.getElementById('chat-leads-table-body')
      const chatSection = document.getElementById('chat')
      const chatLink = document.querySelector('a[href="#chat"]')

      async function loadContacts(){
        try{
          if(!window.supabase){
            console.error('‚ùå Supabase non initialis√©');
            return [];
          }
          const { data, error } = await window.supabase.from('contacts').select('*').order('created_at', { ascending: false });
          if(error){
            console.error('‚ùå Erreur chargement contacts:', error);
            return [];
          }
          console.log('‚úÖ Contacts charg√©s depuis Supabase:', data.length);
          return data || [];
        }catch(e){
          console.error('‚ùå Exception loadContacts:', e);
          return [];
        }
      }

      function saveContacts(arr){
        // Deprecated: les contacts sont maintenant g√©r√©s directement dans Supabase
      }

      async function renderContactsTable(){
        const arr = await loadContacts()
        contactsTbody.innerHTML = ''
        if(arr.length===0){
          const tr = document.createElement('tr')
          tr.innerHTML = '<td colspan="5" class="activity-empty">Aucun contact.</td>'
          contactsTbody.appendChild(tr)
          return
        }
        arr.forEach(c=>{
          const tr = document.createElement('tr')
          tr.className = 'contact-row'
          const dateObj = new Date(c.created_at || c.date)
          const dateStr = dateObj.toLocaleDateString('fr-FR')
          tr.innerHTML = `<td><div class="contact-cell-title"><div class="contact-avatar">üë§</div><div><div class="contact-name">${escapeHtml(c.name||'‚Äî')}</div></div></div></td><td>${escapeHtml(c.email||'‚Äî')}</td><td>${escapeHtml(c.phone||'‚Äî')}</td><td>${dateStr}</td><td><div class="action-links"><span class="edit-contact" data-id="${c.id}" title="Supprimer" style="cursor:pointer;padding:6px 10px;background:rgba(239,68,68,0.1);border-radius:6px;font-size:16px;transition:all 0.2s;">üóëÔ∏è</span></div></td>`
          contactsTbody.appendChild(tr)
        })

        contactsTbody.querySelectorAll('.edit-contact').forEach(el=> el.addEventListener('click', (e)=>{
          const id = Number(e.target.dataset.id)
          deleteContact(id)
        }))
      }

      const contactModal = document.getElementById('contact-modal')
      const contactForm = document.getElementById('contact-form')
      const contactCancel = document.getElementById('contact-cancel')

      function openContactModal(){
        contactModal.classList.remove('hidden')
        contactModal.setAttribute('aria-hidden','false')
        contactForm.reset()
        document.getElementById('cont-name').focus()
      }

      function closeContactModal(){
        contactModal.classList.add('hidden')
        contactModal.setAttribute('aria-hidden','true')
      }

      contactCancel.addEventListener('click', closeContactModal)
      contactModal.addEventListener('click', (e)=>{ if(e.target === contactModal) closeContactModal() })

      contactForm.addEventListener('submit', async (e)=>{
        e.preventDefault()
        const name = document.getElementById('cont-name').value.trim()
        const email = document.getElementById('cont-email').value.trim()
        const phone = document.getElementById('cont-phone').value.trim()
        if(!name){ alert('‚ùå Le nom est requis'); return }
        
        const id = Date.now()
        const newC = {id, name, email, phone}
        
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }
          const { error } = await window.supabase.from('contacts').insert([newC]);
          if(error){
            console.error('‚ùå Erreur insertion:', error);
            alert('‚ùå Erreur lors de l\'ajout du contact');
            return;
          }
          console.log('‚úÖ Contact ajout√©');
          await renderContactsTable()
          closeContactModal()
        }catch(e){
          console.error('‚ùå Exception:', e);
          alert('‚ùå Erreur: ' + e.message);
        }
      })

      function addContactAdmin(){ openContactModal() }

      async function deleteContact(id){
        if(!confirm('Supprimer ce contact ?')) return
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }
          const { error } = await window.supabase.from('contacts').delete().eq('id', id);
          if(error){
            console.error('‚ùå Erreur suppression:', error);
            alert('‚ùå Erreur lors de la suppression');
            return;
          }
          console.log('‚úÖ Contact supprim√©');
          await renderContactsTable();
        }catch(e){
          console.error('‚ùå Exception:', e);
        }
      }

      // Afficher la section Contacts au clic
      if(contactsLink){
        contactsLink.addEventListener('click', async (e)=>{
          e.preventDefault()
          hideAllSections()
          contactsSection.classList.remove('hidden')
          await renderContactsTable()
        })
      }

      // ====== GESTION DES CHOIX CHAT IA ======
      let chatLeadsFilter = 'all'

      function filterChatLeads(filter){
        chatLeadsFilter = filter
        document.getElementById('chat-filter-all').style.background = filter === 'all' ? 'var(--accent)' : 'rgba(255,255,255,0.08)'
        document.getElementById('chat-filter-active').style.background = filter === 'active' ? 'var(--accent)' : 'rgba(255,255,255,0.08)'
        document.getElementById('chat-filter-archived').style.background = filter === 'archived' ? 'var(--accent)' : 'rgba(255,255,255,0.08)'
        renderChatLeadsTable()
      }
      window.filterChatLeads = filterChatLeads

      async function loadChatLeads(){
        try{
          if(!window.supabase){
            console.error('‚ùå Supabase non initialis√©');
            return []
          }
          let query = window.supabase
            .from('chat_leads')
            .select('*')
            .order('created_at', { ascending: false })

          if(chatLeadsFilter === 'active'){
            query = query.or('status.is.null,status.eq.active')
          } else if(chatLeadsFilter === 'archived'){
            query = query.eq('status', 'archived')
          }

          const { data, error } = await query

          if(error){
            console.error('‚ùå Erreur chargement chat leads:', error)
            return []
          }
          return data || []
        }catch(e){
          console.error('‚ùå Exception loadChatLeads:', e)
          return []
        }
      }

      async function archiveChatLead(id){
        if(!window.supabase) return
        const { error } = await window.supabase
          .from('chat_leads')
          .update({ status: 'archived' })
          .eq('id', id)
        if(error){
          console.error('‚ùå Erreur archivage:', error)
          alert('Erreur lors de l\'archivage')
        } else {
          await renderChatLeadsTable()
        }
      }

      async function unarchiveChatLead(id){
        if(!window.supabase) return
        const { error } = await window.supabase
          .from('chat_leads')
          .update({ status: 'active' })
          .eq('id', id)
        if(error){
          console.error('‚ùå Erreur d√©sarchivage:', error)
          alert('Erreur lors du d√©sarchivage')
        } else {
          await renderChatLeadsTable()
        }
      }

      async function deleteChatLead(id){
        if(!confirm('Supprimer d√©finitivement cette demande ?')) return
        if(!window.supabase) return
        const { error } = await window.supabase
          .from('chat_leads')
          .delete()
          .eq('id', id)
        if(error){
          console.error('‚ùå Erreur suppression:', error)
          alert('Erreur lors de la suppression')
        } else {
          if(chatDetailsModal) chatDetailsModal.style.display = 'none'
          await renderChatLeadsTable()
        }
      }

      window.archiveChatLead = archiveChatLead
      window.unarchiveChatLead = unarchiveChatLead
      window.deleteChatLead = deleteChatLead

      function formatChatDetails(row){
        if(!row || !row.payload) return '‚Äî'
        const p = row.payload
        if(row.choice === 'sell'){
          return `${escapeHtml(p.model || '‚Äî')} | ${escapeHtml(p.km || '‚Äî')} km | ${escapeHtml(p.etat || '‚Äî')} | ${escapeHtml(p.lieu || '‚Äî')}`
        }
        if(row.choice === 'buy'){
          return `${escapeHtml(p.type || '‚Äî')} | ${escapeHtml(p.budget || '‚Äî')} | ${escapeHtml(p.km || '‚Äî')} | ${escapeHtml(p.options || '‚Äî')}`
        }
        if(row.choice === 'faq'){
          return escapeHtml(p.question || '‚Äî')
        }
        if(p.callback_info){
          return `üìû ${escapeHtml(p.callback_info || '‚Äî')}`
        }
        if(p.email){
          return `üìß ${escapeHtml(p.email || '‚Äî')}`
        }
        if(p.whatsapp){
          return `üí¨ ${escapeHtml(p.whatsapp || '‚Äî')}`
        }
        if(p.rdv_info){
          return `üìÖ ${escapeHtml(p.rdv_info || '‚Äî')}`
        }
        return '‚Äî'
      }

      async function renderChatLeadsTable(){
        const arr = await loadChatLeads()
        chatLeadsTbody.innerHTML = ''
        if(arr.length===0){
          const tr = document.createElement('tr')
          tr.innerHTML = '<td colspan="5" class="activity-empty">Aucune demande trouv√©e.</td>'
          chatLeadsTbody.appendChild(tr)
          return
        }
        arr.forEach(row=>{
          const tr = document.createElement('tr')
          const dateObj = new Date(row.created_at)
          const dateStr = dateObj.toLocaleDateString('fr-FR')
          const choiceLabel = row.choice === 'sell' ? 'Vendre' : row.choice === 'buy' ? 'Acheter' : row.choice === 'ai_chat' ? 'Chat IA' : 'Question'
          const isArchived = row.status === 'archived'
          const statusBadge = isArchived
            ? '<span style="background:rgba(255,255,255,0.1);color:#888;padding:3px 10px;border-radius:20px;font-size:11px;">Archiv√©e</span>'
            : '<span style="background:rgba(16,185,129,0.15);color:#10b981;padding:3px 10px;border-radius:20px;font-size:11px;">Active</span>'
          
          const archiveBtn = isArchived
            ? `<button onclick="event.stopPropagation();unarchiveChatLead(${row.id})" style="background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);color:#60a5fa;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;" title="R√©activer">‚Ü©Ô∏è</button>`
            : `<button onclick="event.stopPropagation();archiveChatLead(${row.id})" style="background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3);color:#f59e0b;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;" title="Archiver">üì¶</button>`
          
          tr.innerHTML = `
            <td>${dateStr}</td>
            <td>${choiceLabel}</td>
            <td>${formatChatDetails(row)}</td>
            <td>${statusBadge}</td>
            <td style="display:flex;gap:6px;">
              ${archiveBtn}
              <button onclick="event.stopPropagation();deleteChatLead(${row.id})" style="background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#ef4444;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;" title="Supprimer">üóëÔ∏è</button>
            </td>
          `
          if(isArchived) tr.style.opacity = '0.6'
          tr.style.cursor = 'pointer'
          tr.addEventListener('click', () => showChatDetails(row))
          chatLeadsTbody.appendChild(tr)
        })
      }
      
      function showChatDetails(row){
        const modal = document.getElementById('chat-details-modal')
        const content = document.getElementById('chat-details-content')
        if(!modal || !content) return
        
        const dateObj = new Date(row.created_at)
        const dateStr = dateObj.toLocaleDateString('fr-FR') + ' √† ' + dateObj.toLocaleTimeString('fr-FR')
        const choiceLabel = row.choice === 'sell' ? 'Vendre un v√©hicule' : row.choice === 'buy' ? 'Acheter un v√©hicule' : 'Juste une question'
        
        let html = `
          <div style="margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.1);">
            <strong>Date:</strong> ${escapeHtml(dateStr)}<br>
            <strong>Choix:</strong> ${escapeHtml(choiceLabel)}
          </div>
        `
        
        if(row.payload){
          const p = row.payload
          html += '<div style="margin-top:15px;"><strong>Informations collect√©es:</strong></div><div style="margin-top:10px;">'
          
          if(p.question) html += `<div>‚ùì <strong>Question:</strong> ${escapeHtml(p.question)}</div>`
          if(p.model) html += `<div>üöó <strong>Mod√®le:</strong> ${escapeHtml(p.model)}</div>`
          if(p.km) html += `<div>üìè <strong>Kilom√©trage:</strong> ${escapeHtml(p.km)}</div>`
          if(p.etat) html += `<div>‚ú® <strong>√âtat:</strong> ${escapeHtml(p.etat)}</div>`
          if(p.lieu) html += `<div>üìç <strong>Lieu:</strong> ${escapeHtml(p.lieu)}</div>`
          if(p.type) html += `<div>üöô <strong>Type recherch√©:</strong> ${escapeHtml(p.type)}</div>`
          if(p.budget) html += `<div>üí∞ <strong>Budget:</strong> ${escapeHtml(p.budget)}</div>`
          if(p.options) html += `<div>‚öôÔ∏è <strong>Options:</strong> ${escapeHtml(p.options)}</div>`
          if(p.urgence) html += `<div>‚è∞ <strong>Urgence:</strong> ${escapeHtml(p.urgence)}</div>`
          
          if(p.ai_conversation_topic) html += `<div style="margin-top:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:5px;">üì¢ <strong>Sujet IA:</strong> ${escapeHtml(p.ai_conversation_topic)}</div>`
          if(p.full_conversation) html += `<div style="margin-top:10px;font-size:0.85em;max-height:150px;overflow-y:auto;padding:10px;background:rgba(0,0,0,0.2);border-radius:5px;white-space:pre-wrap;">üí¨ <strong>Historique:</strong>\n${escapeHtml(p.full_conversation)}</div>`

          if(p.contact_choice){
            const contactLabels = {
              'callback': '√ätre rappel√©',
              'email': 'Email',
              'whatsapp': 'WhatsApp',
              'rdv': 'Rendez-vous'
            }
            html += `<div>üì± <strong>Mode contact:</strong> ${escapeHtml(contactLabels[p.contact_choice] || p.contact_choice)}</div>`
          }
          if(p.callback_info) html += `<div style="color:#4CAF50;font-weight:bold;">üìû <strong>Rappel demand√©:</strong> ${escapeHtml(p.callback_info)}</div>`
          if(p.callback_nom) html += `<div>üë§ <strong>Nom:</strong> ${escapeHtml(p.callback_nom)}</div>`
          if(p.callback_tel) html += `<div>üì± <strong>T√©l√©phone:</strong> ${escapeHtml(p.callback_tel)}</div>`
          if(p.callback_date) html += `<div>üìÖ <strong>Cr√©neau:</strong> ${escapeHtml(p.callback_date)}</div>`
          if(p.email) html += `<div style="color:#4CAF50;font-weight:bold;">üìß <strong>Email:</strong> ${escapeHtml(p.email)}</div>`
          if(p.whatsapp) html += `<div style="color:#4CAF50;font-weight:bold;">üí¨ <strong>WhatsApp:</strong> ${escapeHtml(p.whatsapp)}</div>`
          if(p.rdv_info) html += `<div style="color:#4CAF50;font-weight:bold;">üìÖ <strong>RDV:</strong> ${escapeHtml(p.rdv_info)}</div>`
          
          html += '</div>'
        }
        
          const isArchived = row.status === 'archived'
          html += `<div style="margin-top:20px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:10px;">`
          if(isArchived){
            html += `<button onclick="unarchiveChatLead(${row.id})" style="background:rgba(59,130,246,0.2);border:1px solid rgba(59,130,246,0.4);color:#60a5fa;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px;">‚Ü©Ô∏è R√©activer</button>`
          } else {
            html += `<button onclick="archiveChatLead(${row.id})" style="background:rgba(245,158,11,0.2);border:1px solid rgba(245,158,11,0.4);color:#f59e0b;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px;">üì¶ Archiver</button>`
          }
          html += `<button onclick="deleteChatLead(${row.id})" style="background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.4);color:#ef4444;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px;">üóëÔ∏è Supprimer</button>`
          html += '</div>'
        
        content.innerHTML = html
        modal.style.display = 'flex'
      }
      
      const closeChatModal = document.getElementById('close-chat-modal')
      const chatDetailsModal = document.getElementById('chat-details-modal')
      
      if(closeChatModal){
        closeChatModal.addEventListener('click', () => {
          if(chatDetailsModal) chatDetailsModal.style.display = 'none'
        })
      }
      
      if(chatDetailsModal){
        chatDetailsModal.addEventListener('click', (e) => {
          if(e.target === chatDetailsModal) chatDetailsModal.style.display = 'none'
        })
      }

      if(chatLink){
        chatLink.addEventListener('click', async (e)=>{
          e.preventDefault()
          hideAllSections()
          chatSection.classList.remove('hidden')
          await renderChatLeadsTable()
        })
      }

      if(addContactBtn) addContactBtn.addEventListener('click', addContactAdmin)

      // ====== GESTION DES T√ÇCHES ======
      const tasksTbody = document.getElementById('tasks-table-body')
      const addTaskBtn = document.getElementById('add-task-admin')
      const tasksSection = document.getElementById('tache')
      const tasksLink = document.querySelector('a[href="#tache"]')

      async function loadTasks(){
        try{
          if(!window.supabase){
            console.error('‚ùå Supabase non initialis√©');
            return [];
          }
          const { data, error } = await window.supabase.from('tasks').select('*').order('created_at', { ascending: false });
          if(error){
            console.error('‚ùå Erreur chargement t√¢ches:', error);
            return [];
          }
          console.log('‚úÖ T√¢ches charg√©es depuis Supabase:', data.length);
          return data || [];
        }catch(e){
          console.error('‚ùå Exception loadTasks:', e);
          return [];
        }
      }

      function saveTasks(arr){
        // Deprecated: les t√¢ches sont maintenant g√©r√©es directement dans Supabase
      }

      async function renderTasksTable(){
        const arr = await loadTasks()
        tasksTbody.innerHTML = ''
        if(arr.length===0){
          const tr = document.createElement('tr')
          tr.innerHTML = '<td colspan="5" class="activity-empty">Aucune t√¢che.</td>'
          tasksTbody.appendChild(tr)
          return
        }
        arr.forEach(t=>{
          const tr = document.createElement('tr')
          tr.className = 'task-row'
          const dateObj = new Date(t.due_date || t.dueDate)
          const dateStr = dateObj.toLocaleDateString('fr-FR')
          const priorityColor = t.priority === 'Haute' ? '#ef4444' : t.priority === 'Moyenne' ? '#f59e0b' : '#10b981'
          const priorityBg = t.priority === 'Haute' ? 'rgba(239,68,68,0.12)' : t.priority === 'Moyenne' ? 'rgba(245,158,11,0.12)' : 'rgba(16,185,129,0.12)'
          const statusColor = t.status === '√Ä faire' ? '#9fb6d6' : t.status === 'En cours' ? '#f59e0b' : '#10b981'
          const statusBg = t.status === '√Ä faire' ? 'rgba(159,182,214,0.12)' : t.status === 'En cours' ? 'rgba(245,158,11,0.12)' : 'rgba(16,185,129,0.12)'
          tr.innerHTML = `<td><div class="task-title">${escapeHtml(t.title||'‚Äî')}</div><div class="task-desc">${escapeHtml(t.description||'')}</div></td><td><span class="priority-pill" style="background:${priorityBg};color:${priorityColor}">${escapeHtml(t.priority||'‚Äî')}</span></td><td><span class="status-pill" style="background:${statusBg};color:${statusColor}">${escapeHtml(t.status||'‚Äî')}</span></td><td>${dateStr}</td><td><div class="action-links" style="display:flex;gap:8px;"><span class="edit-task" data-id="${t.id}" title="Modifier" style="cursor:pointer;padding:6px 10px;background:rgba(16,185,129,0.1);border-radius:6px;font-size:16px;transition:all 0.2s;">‚úèÔ∏è</span><span class="del-task" data-id="${t.id}" title="Supprimer" style="cursor:pointer;padding:6px 10px;background:rgba(239,68,68,0.1);border-radius:6px;font-size:16px;transition:all 0.2s;">üóëÔ∏è</span></div></td>`
          tasksTbody.appendChild(tr)
        })

        tasksTbody.querySelectorAll('.edit-task').forEach(el=> el.addEventListener('click', (e)=>{
          const id = Number(e.target.dataset.id)
          editTask(id)
        }))
        
        tasksTbody.querySelectorAll('.del-task').forEach(el=> el.addEventListener('click', (e)=>{
          const id = Number(e.target.dataset.id)
          deleteTask(id)
        }))
      }

      const taskModal = document.getElementById('task-modal')
      const taskForm = document.getElementById('task-form')
      const taskCancel = document.getElementById('task-cancel')

      function openTaskModal(){
        taskModal.classList.remove('hidden')
        taskModal.setAttribute('aria-hidden','false')
        document.getElementById('task-title').focus()
      }

      function closeTaskModal(){
        taskModal.classList.add('hidden')
        taskModal.setAttribute('aria-hidden','true')
      }

      taskCancel.addEventListener('click', closeTaskModal)
      taskModal.addEventListener('click', (e)=>{ if(e.target === taskModal) closeTaskModal() })

      taskForm.addEventListener('submit', async (e)=>{
        e.preventDefault()
        const editId = document.getElementById('task-id').value
        const title = document.getElementById('task-title').value.trim()
        const description = document.getElementById('task-desc').value.trim()
        const priority = document.getElementById('task-priority').value
        const status = document.getElementById('task-status').value
        const dueDate = document.getElementById('task-due').value || new Date().toISOString().split('T')[0]
        if(!title){ alert('‚ùå Le titre est requis'); return }
        
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }
          
          if(editId){
            // Mise √† jour
            const { error } = await window.supabase.from('tasks').update({
              title, 
              description, 
              priority, 
              status, 
              due_date: dueDate
            }).eq('id', parseInt(editId));
            
            if(error){
              console.error('‚ùå Erreur mise √† jour:', error);
              alert('‚ùå Erreur lors de la mise √† jour de la t√¢che');
              return;
            }
            console.log('‚úÖ T√¢che modifi√©e');
          } else {
            // Insertion
            const id = Date.now()
            const newT = {
              id, 
              title, 
              description, 
              priority, 
              status, 
              due_date: dueDate
              // created_at sera automatiquement ajout√© par Supabase
            }
            
            const { error } = await window.supabase.from('tasks').insert([newT]);
            if(error){
              console.error('‚ùå Erreur insertion:', error);
              alert('‚ùå Erreur lors de l\'ajout de la t√¢che');
              return;
            }
            console.log('‚úÖ T√¢che ajout√©e');
          }
          
          await renderTasksTable()
          closeTaskModal()
        }catch(e){
          console.error('‚ùå Exception:', e);
          alert('‚ùå Erreur: ' + e.message);
        }
      })

      function addTaskAdmin(){ 
        document.getElementById('task-id').value = ''
        taskForm.reset()
        document.getElementById('task-modal-title').textContent = 'Ajouter une t√¢che'
        document.getElementById('task-submit-btn').textContent = 'Ajouter'
        openTaskModal() 
      }
      
      async function editTask(id){
        const arr = await loadTasks()
        const task = arr.find(x=>x.id===id)
        if(!task) return
        
        document.getElementById('task-id').value = id
        document.getElementById('task-title').value = task.title || ''
        document.getElementById('task-desc').value = task.description || ''
        document.getElementById('task-priority').value = task.priority || 'Basse'
        document.getElementById('task-status').value = task.status || '√Ä faire'
        document.getElementById('task-due').value = task.due_date || task.dueDate || ''
        
        document.getElementById('task-modal-title').textContent = 'Modifier la t√¢che'
        document.getElementById('task-submit-btn').textContent = 'Enregistrer'
        openTaskModal()
      }

      async function deleteTask(id){
        if(!confirm('Supprimer cette t√¢che ?')) return
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }
          const { error } = await window.supabase.from('tasks').delete().eq('id', id);
          if(error){
            console.error('‚ùå Erreur suppression:', error);
            alert('‚ùå Erreur lors de la suppression');
            return;
          }
          console.log('‚úÖ T√¢che supprim√©e');
          await renderTasksTable();
        }catch(e){
          console.error('‚ùå Exception:', e);
        }
      }

      // Afficher la section T√¢ches au clic
      if(tasksLink){
        tasksLink.addEventListener('click', async (e)=>{
          e.preventDefault()
          hideAllSections()
          tasksSection.classList.remove('hidden')
          await renderTasksTable()
        })
      }

      if(addTaskBtn) addTaskBtn.addEventListener('click', addTaskAdmin)

      // ====== GESTION DES √âV√âNEMENTS / VENTES ======
      const eventsTbody = document.getElementById('events-table-body')
      const addEventBtn = document.getElementById('add-event-admin')
      const eventsSection = document.getElementById('evenements')
      const eventsLink = document.querySelector('a[href="#evenements"]')

      function loadEvents(){
        try{ const raw = localStorage.getItem('zenoccaz_events'); return raw ? JSON.parse(raw) : [] }catch(e){ return [] }
      }

      function saveEvents(arr){
        try{ localStorage.setItem('zenoccaz_events', JSON.stringify(arr)) }catch(e){}
      }

      function renderEventsTable(){
        const arr = loadEvents()
        eventsTbody.innerHTML = ''
        if(arr.length===0){
          const tr = document.createElement('tr')
          tr.innerHTML = '<td colspan="6" class="activity-empty">Aucune vente.</td>'
          eventsTbody.appendChild(tr)
          return
        }
        arr.forEach(e=>{
          const tr = document.createElement('tr')
          tr.className = 'event-row'
          const dateObj = new Date(e.date)
          const dateStr = dateObj.toLocaleDateString('fr-FR')
          const statusColor = e.status === 'Compl√©t√©e' ? '#10b981' : e.status === 'En cours' ? '#f59e0b' : '#9fb6d6'
          const statusBg = e.status === 'Compl√©t√©e' ? 'rgba(16,185,129,0.12)' : e.status === 'En cours' ? 'rgba(245,158,11,0.12)' : 'rgba(159,182,214,0.12)'
          tr.innerHTML = `<td><div class="event-client">${escapeHtml(e.client||'‚Äî')}</div></td><td>${escapeHtml(e.vehicle||'‚Äî')}</td><td>${escapeHtml(e.price||'')} ‚Ç¨</td><td>${dateStr}</td><td><span class="status-pill" style="background:${statusBg};color:${statusColor}">${escapeHtml(e.status||'‚Äî')}</span></td><td><div class="action-links"><span class="del-event" data-id="${e.id}" style="color:#ef4444;cursor:pointer;">Supprimer</span></div></td>`
          eventsTbody.appendChild(tr)
        })

        eventsTbody.querySelectorAll('.del-event').forEach(el=> el.addEventListener('click', (e)=>{
          const id = Number(e.target.dataset.id)
          deleteEvent(id)
        }))
      }

      const eventModal = document.getElementById('event-modal')
      const eventForm = document.getElementById('event-form')
      const eventCancel = document.getElementById('event-cancel')

      function openEventModal(){
        eventModal.classList.remove('hidden')
        eventModal.setAttribute('aria-hidden','false')
        eventForm.reset()
        document.getElementById('event-client').focus()
      }

      function closeEventModal(){
        eventModal.classList.add('hidden')
        eventModal.setAttribute('aria-hidden','true')
      }

      eventCancel.addEventListener('click', closeEventModal)
      eventModal.addEventListener('click', (e)=>{ if(e.target === eventModal) closeEventModal() })

      eventForm.addEventListener('submit', (e)=>{
        e.preventDefault()
        const client = document.getElementById('event-client').value.trim()
        const vehicle = document.getElementById('event-vehicle').value.trim()
        const price = document.getElementById('event-price').value.trim()
        const status = document.getElementById('event-status').value
        if(!client || !vehicle || !price) return
        const id = Date.now()
        const newE = {id, client, vehicle, price, status, date: new Date().toISOString()}
        const arr = loadEvents()
        arr.unshift(newE)
        saveEvents(arr)
        try{ if(window.supabaseClient && window.supabaseClient.insertEvent){ window.supabaseClient.insertEvent(newE).catch(()=>{}); } }catch(e){}
        renderEventsTable()
        closeEventModal()
      })

      function addEventAdmin(){ openEventModal() }

      function deleteEvent(id){
        if(!confirm('Supprimer cette vente ?')) return
        let arr = loadEvents()
        arr = arr.filter(e=> e.id !== id)
        saveEvents(arr)
        renderEventsTable()
      }

      // Afficher la section √âv√©nements au clic
      if(eventsLink){
        eventsLink.addEventListener('click', (e)=>{
          e.preventDefault()
          hideAllSections()
          eventsSection.classList.remove('hidden')
          renderEventsTable()
        })
      }

      if(addEventBtn) addEventBtn.addEventListener('click', addEventAdmin)

      // ====== GESTION DES PI√àCES ======
      const piecesTbody = document.getElementById('pieces-table-body')
      const addPieceBtn = document.getElementById('add-piece-admin')
      const piecesSection = document.getElementById('pieces')
      const piecesLink = document.querySelector('a[href="#pieces"]')

      async function loadPieces(){
        try{
          if(!window.supabase){
            console.error('‚ùå Supabase non initialis√©');
            return [];
          }
          const { data, error } = await window.supabase.from('pieces').select('*').order('created_at', { ascending: false });
          if(error){
            console.error('‚ùå Erreur chargement pi√®ces:', error);
            return [];
          }
          console.log('‚úÖ Pi√®ces charg√©es depuis Supabase:', data.length);
          return data || [];
        }catch(e){
          console.error('‚ùå Exception loadPieces:', e);
          return [];
        }
      }

      function savePieces(arr){
        // Deprecated: les pi√®ces sont maintenant g√©r√©es directement dans Supabase
      }

      async function renderPiecesTable(){
        const arr = await loadPieces()
        piecesTbody.innerHTML = ''
        if(arr.length===0){
          const tr = document.createElement('tr')
          tr.innerHTML = '<td colspan="5" class="activity-empty">Aucune pi√®ce.</td>'
          piecesTbody.appendChild(tr)
          return
        }
        arr.forEach(p=>{
          const tr = document.createElement('tr')
          tr.className = 'piece-row'
          tr.style.background = 'rgba(255,255,255,0.02)'
          tr.style.borderRadius = '8px'
          tr.innerHTML = `<td style="padding:20px 16px;border-top-left-radius:8px;border-bottom-left-radius:8px;"><div style="display:flex;align-items:center;gap:12px;"><div style="width:40px;height:40px;background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">‚öôÔ∏è</div><div><div style="font-weight:600;color:var(--text);font-size:15px;">${escapeHtml(p.name||'‚Äî')}</div></div></div></td><td style="padding:20px 16px;"><span style="font-family:monospace;font-size:13px;color:var(--muted);background:rgba(255,255,255,0.05);padding:6px 12px;border-radius:6px;">${escapeHtml(p.reference||'‚Äî')}</span></td><td style="padding:20px 16px;"><div style="font-weight:700;color:#10b981;font-size:17px;">${escapeHtml(p.price||'0')} ‚Ç¨</div></td><td style="padding:20px 16px;"><div style="display:inline-flex;align-items:center;gap:8px;background:rgba(59,130,246,0.1);padding:8px 16px;border-radius:20px;border:1px solid rgba(59,130,246,0.2);"><span style="font-weight:600;color:#60a5fa;font-size:15px;">${escapeHtml(p.stock||'0')}</span><span style="font-size:12px;color:var(--muted);">unit√©s</span></div></td><td style="padding:20px 16px;text-align:right;border-top-right-radius:8px;border-bottom-right-radius:8px;"><div class="action-links" style="display:flex;gap:10px;justify-content:flex-end;"><span class="edit-piece" data-id="${p.id}" title="Modifier" style="cursor:pointer;padding:8px 12px;background:rgba(16,185,129,0.1);border-radius:6px;font-size:16px;transition:all 0.2s;">‚úèÔ∏è</span><span class="del-piece" data-id="${p.id}" title="Supprimer" style="cursor:pointer;padding:8px 12px;background:rgba(239,68,68,0.1);border-radius:6px;font-size:16px;transition:all 0.2s;">üóëÔ∏è</span></div></td>`
          piecesTbody.appendChild(tr)
        })

        piecesTbody.querySelectorAll('.edit-piece').forEach(el=> el.addEventListener('click', (e)=>{
          const id = Number(e.target.dataset.id)
          editPiece(id)
        }))
        piecesTbody.querySelectorAll('.del-piece').forEach(el=> el.addEventListener('click', (e)=>{
          const id = Number(e.target.dataset.id)
          deletePiece(id)
        }))
      }

      const pieceModal = document.getElementById('piece-modal')
      const pieceForm = document.getElementById('piece-form')
      const pieceCancel = document.getElementById('piece-cancel')

      function openPieceModal(){
        pieceModal.classList.remove('hidden')
        pieceModal.setAttribute('aria-hidden','false')
        pieceForm.reset()
        document.getElementById('piece-name').focus()
      }

      function closePieceModal(){
        pieceModal.classList.add('hidden')
        pieceModal.setAttribute('aria-hidden','true')
      }

      pieceCancel.addEventListener('click', closePieceModal)
      pieceModal.addEventListener('click', (e)=>{ if(e.target === pieceModal) closePieceModal() })

      pieceForm.addEventListener('submit', async (e)=>{
        e.preventDefault()
        const name = document.getElementById('piece-name').value.trim()
        const reference = document.getElementById('piece-ref').value.trim()
        const price = document.getElementById('piece-price').value.trim()
        const stock = document.getElementById('piece-stock').value.trim() || '0'
        if(!name || !price){ alert('‚ùå Le nom et le prix sont requis'); return }
        
        const id = Date.now()
        const newP = {
          id, 
          name, 
          reference, 
          price: parseFloat(price), 
          stock: parseInt(stock)
          // created_at sera automatiquement ajout√© par Supabase
        }
        
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }
          
          // 1. Ins√©rer la pi√®ce
          const { error: pieceError } = await window.supabase.from('pieces').insert([newP]);
          if(pieceError){
            console.error('‚ùå Erreur insertion pi√®ce:', pieceError);
            alert('‚ùå Erreur lors de l\'ajout de la pi√®ce');
            return;
          }
          console.log('‚úÖ Pi√®ce ajout√©e');
          
          // 2. Cr√©er automatiquement une d√©pense dans Finances
          const financeId = Date.now() + 1;
          const newFinance = {
            id: financeId,
            description: `Achat pi√®ce: ${name}${reference ? ' (R√©f: ' + reference + ')' : ''}`,
            type: 'expense',
            amount: parseFloat(price),
            category: 'parts',
            piece_id: id
            // created_at sera automatiquement ajout√© par Supabase
          };
          
          const { error: financeError } = await window.supabase.from('finances').insert([newFinance]);
          if(financeError){
            console.error('‚ùå Erreur insertion finance:', financeError);
            // La pi√®ce est cr√©√©e, mais pas la d√©pense - on continue
          } else {
            console.log('‚úÖ D√©pense automatique cr√©√©e dans Finances');
          }
          
          await renderPiecesTable()
          closePieceModal()
          
          // Si la section Finances est ouverte, la rafra√Æchir
          if(!financeSection.classList.contains('hidden')){
            await updateFinanceDashboard();
          }
        }catch(e){
          console.error('‚ùå Exception:', e);
          alert('‚ùå Erreur: ' + e.message);
        }
      })

      function addPieceAdmin(){ openPieceModal() }

      async function editPiece(id){
        const arr = await loadPieces()
        const piece = arr.find(x=>x.id===id)
        if(!piece) return
        
        const name = prompt('Nom de la pi√®ce', piece.name) || piece.name
        const reference = prompt('R√©f√©rence', piece.reference) || piece.reference
        const price = prompt('Prix (‚Ç¨)', piece.price) || piece.price
        const stock = prompt('Stock (unit√©s)', piece.stock) || piece.stock
        
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }
          const { error } = await window.supabase.from('pieces').update({
            name, 
            reference, 
            price: parseFloat(price), 
            stock: parseInt(stock)
          }).eq('id', id);
          
          if(error){
            console.error('‚ùå Erreur mise √† jour:', error);
            alert('‚ùå Erreur lors de la mise √† jour');
            return;
          }
          console.log('‚úÖ Pi√®ce mise √† jour');
          await renderPiecesTable();
        }catch(e){
          console.error('‚ùå Exception:', e);
        }
      }

      async function deletePiece(id){
        if(!confirm('Supprimer cette pi√®ce ?')) return
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }

          // 1. Rechercher et supprimer l'entr√©e finance li√©e
          console.log('üí∞ Recherche entr√©e finance pour piece_id:', id);
          const { data: financeEntries, error: financeSearchError } = await window.supabase
            .from('finances')
            .select('*')
            .eq('piece_id', id);

          if(financeSearchError){
            console.error('‚ùå Erreur recherche finance:', financeSearchError);
          } else if(financeEntries && financeEntries.length > 0){
            console.log('‚úÖ Trouv√©', financeEntries.length, 'entr√©e(s) finance √† supprimer');
            for(const entry of financeEntries){
              const { error: financeDeleteError } = await window.supabase
                .from('finances')
                .delete()
                .eq('id', entry.id);

              if(financeDeleteError){
                console.error('‚ùå Erreur suppression finance ID', entry.id, ':', financeDeleteError);
              } else {
                console.log('‚úÖ Entr√©e finance ID', entry.id, 'supprim√©e (montant:', entry.amount, '‚Ç¨)');
              }
            }
          } else {
            console.log('‚ö†Ô∏è Aucune entr√©e finance trouv√©e pour piece_id:', id);
          }

          // 2. Supprimer la pi√®ce
          const { error } = await window.supabase.from('pieces').delete().eq('id', id);
          if(error){
            console.error('‚ùå Erreur suppression:', error);
            alert('‚ùå Erreur lors de la suppression');
            return;
          }
          console.log('‚úÖ Pi√®ce supprim√©e');
          await renderPiecesTable();
          
          // Rafra√Æchir les finances si la section est ouverte
          const financeSection = document.getElementById('finances');
          if(financeSection && !financeSection.classList.contains('hidden')){
            await updateFinanceDashboard();
          }
        }catch(e){
          console.error('‚ùå Exception:', e);
        }
      }

      // Afficher la section Pi√®ces au clic
      if(piecesLink){
        piecesLink.addEventListener('click', async (e)=>{
          e.preventDefault()
          hideAllSections()
          piecesSection.classList.remove('hidden')
          await renderPiecesTable()
        })
      }

      if(addPieceBtn) addPieceBtn.addEventListener('click', addPieceAdmin)

      // ====== GESTION DES PARRAINAGES ======
      const parrainage_tbody = document.getElementById('parrainage-table-body')
      const addParrainageBtn = document.getElementById('add-parrainage-admin')
      const parrainage_section = document.getElementById('parrainages')
      const parrainage_link = document.querySelector('a[href="#parrainages"]')

      async function loadParrainages(){
        try{
          if(!window.supabase){
            console.error('‚ùå Supabase non initialis√©');
            return [];
          }
          const { data, error } = await window.supabase.from('parrainages').select('*').order('created_at', { ascending: false });
          if(error){
            console.error('‚ùå Erreur chargement parrainages:', error);
            return [];
          }
          console.log('‚úÖ Parrainages charg√©s depuis Supabase:', data.length);
          return data || [];
        }catch(e){
          console.error('‚ùå Exception loadParrainages:', e);
          return [];
        }
      }

      function saveParrainages(arr){
        // Deprecated: les parrainages sont maintenant g√©r√©s directement dans Supabase
      }

      async function renderParrainageTable(){
        const arr = await loadParrainages()
        parrainage_tbody.innerHTML = ''
        if(arr.length===0){
          const tr = document.createElement('tr')
          tr.innerHTML = '<td colspan="6" class="activity-empty">Aucun parrainage.</td>'
          parrainage_tbody.appendChild(tr)
          return
        }
        arr.forEach(pa=>{
          const tr = document.createElement('tr')
          tr.className = 'parrainage-row'
          const dateObj = new Date(pa.created_at || pa.date)
          const dateStr = dateObj.toLocaleDateString('fr-FR')
          const statusColor = pa.status === 'Actif' ? '#10b981' : '#9fb6d6'
          const statusBg = pa.status === 'Actif' ? 'rgba(16,185,129,0.12)' : 'rgba(159,182,214,0.12)'
          tr.style.borderBottom = '1px solid rgba(255,255,255,0.06)'
          const rewardText = pa.reward_type === 'bon_125' ? 'üéÅ Bon 125‚Ç¨' : pa.reward_type === 'vidange_75' ? 'üîß Vidange 75‚Ç¨' : '‚Äî'
          const statusColorMap = {'Actif': '#10b981', 'Fini': '#3b82f6', 'Archiv√©': '#6b7280'}
          const statusBgMap = {'Actif': 'rgba(16,185,129,0.12)', 'Fini': 'rgba(59,130,246,0.12)', 'Archiv√©': 'rgba(107,114,128,0.12)'}
          const finalStatusColor = statusColorMap[pa.status] || '#9fb6d6'
          const finalStatusBg = statusBgMap[pa.status] || 'rgba(159,182,214,0.12)'
          
          tr.innerHTML = `<td style="padding:16px 12px;"><div class="parrainage-cell"><div class="parrainage-avatar" style="width:40px;height:40px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">üë§</div><div style="margin-left:12px;"><div class="parrainage-name" style="font-weight:600;color:var(--text);margin-bottom:2px;">${escapeHtml(pa.parrain||'‚Äî')}</div><div class="parrainage-email" style="font-size:13px;color:var(--muted);">${escapeHtml(pa.parrain_email||'')}</div></div></div></td><td style="padding:16px 12px;"><div style="font-weight:500;color:var(--text);">${escapeHtml(pa.filleul||'‚Äî')}</div></td><td style="padding:16px 12px;"><div style="font-weight:500;color:#a855f7;font-size:14px;">${rewardText}</div></td><td style="padding:16px 12px;"><span class="status-pill" style="background:${finalStatusBg};color:${finalStatusColor};padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;display:inline-block;">${escapeHtml(pa.status||'‚Äî')}</span></td><td style="padding:16px 12px;"><div style="font-weight:600;color:#a855f7;font-size:15px;">${escapeHtml(pa.commission||'0')} ‚Ç¨</div></td><td style="padding:16px 12px;"><div style="color:var(--muted);font-size:13px;">${dateStr}</div></td><td style="padding:16px 12px;"><div class="action-links" style="display:flex;gap:8px;flex-wrap:wrap;"><button class="send-mail-btn" data-email="${escapeHtml(pa.parrain_email||'')}" data-name="${escapeHtml(pa.parrain||'')}" data-filleul="${escapeHtml(pa.filleul||'')}" data-commission="${escapeHtml(pa.commission||'0')}" data-status="${escapeHtml(pa.status||'')}" data-date="${dateStr}" title="Envoyer un mail" style="cursor:pointer;padding:6px 10px;background:rgba(59,130,246,0.1);border:none;border-radius:6px;font-size:16px;transition:all 0.2s;">üìß</button><span class="edit-parrainage" data-id="${pa.id}" title="Modifier" style="cursor:pointer;padding:6px 10px;background:rgba(16,185,129,0.1);border-radius:6px;font-size:16px;transition:all 0.2s;">‚úèÔ∏è</span><span class="del-parrainage" data-id="${pa.id}" title="Supprimer" style="cursor:pointer;padding:6px 10px;background:rgba(239,68,68,0.1);border-radius:6px;font-size:16px;transition:all 0.2s;">üóëÔ∏è</span></div></td>`
          parrainage_tbody.appendChild(tr)
        })

        parrainage_tbody.querySelectorAll('.del-parrainage').forEach(el=> el.addEventListener('click', (e)=>{
          const id = Number(e.target.dataset.id)
          deleteParrainage(id)
        }))
        
        parrainage_tbody.querySelectorAll('.edit-parrainage').forEach(el=> el.addEventListener('click', (e)=>{
          const id = Number(e.target.dataset.id)
          editParrainage(id)
        }))
        
        parrainage_tbody.querySelectorAll('.send-mail-btn').forEach(btn=> btn.addEventListener('click', (e)=>{
          const email = e.target.dataset.email
          const name = e.target.dataset.name
          const filleul = e.target.dataset.filleul
          const commission = e.target.dataset.commission
          const status = e.target.dataset.status
          const date = e.target.dataset.date
          
          if(!email){
            alert('‚ùå Email manquant pour ce parrain')
            return
          }
          
          showMailOptions(email, name, filleul, commission, status, date)
        }))
      }

      async function updateParrainageStats(){
        const arr = await loadParrainages()
        const actifs = arr.filter(p=> p.status === 'Actif').length
        const conversions = arr.filter(p=> p.status === 'Actif' && p.filleul).length
        let commissions = 0
        arr.forEach(p=> { commissions += parseFloat(p.commission) || 0 })
        
        document.getElementById('parrainage-count').textContent = actifs
        document.getElementById('parrainage-conversions').textContent = conversions
        document.getElementById('parrainage-commissions').textContent = commissions.toFixed(2) + ' ‚Ç¨'
      }

      const parrainageModal = document.getElementById('parrainage-modal')
      const parrainageForm = document.getElementById('parrainage-form')
      const parrainageCancel = document.getElementById('parrainage-cancel')

      function openParrainageModal(){
        parrainageModal.classList.remove('hidden')
        parrainageModal.setAttribute('aria-hidden','false')
        parrainageForm.reset()
        document.getElementById('parr-parrain').focus()
      }

      function closeParrainageModal(){
        parrainageModal.classList.add('hidden')
        parrainageModal.setAttribute('aria-hidden','true')
      }
      
      function showMailOptions(toEmail, name, filleul, commission, status, date){
        const subject = `Commission parrainage - ${commission}‚Ç¨`
        const body = `Bonjour ${name},\n\nNous vous remercions pour votre parrainage de ${filleul}.\n\nVoici le d√©tail de votre commission :\n- Montant : ${commission}‚Ç¨\n- Statut : ${status}\n- Date : ${date}\n\nCordialement,\nL'√©quipe ZenOccaz`
        
        // Cr√©er le modal d'information mail
        const modalHtml = `
          <div id="mail-choice-modal" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;backdrop-filter:blur(4px);">
            <div style="background:var(--card-bg);padding:32px;border-radius:16px;max-width:600px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5);max-height:90vh;overflow-y:auto;">
              <h3 style="margin:0 0 8px;color:var(--text);font-size:20px;">üìß Informations pour le mail</h3>
              <p style="color:var(--muted);margin:0 0 24px;font-size:14px;">Copiez ces informations et ouvrez votre messagerie</p>
              
              <div style="display:flex;flex-direction:column;gap:20px;">
                <!-- Instructions -->
                <div style="background:rgba(59,130,246,0.1);padding:16px;border-radius:8px;border:1px solid rgba(59,130,246,0.2);">
                  <div style="font-size:14px;color:#60a5fa;font-weight:600;margin-bottom:8px;">üìã Instructions :</div>
                  <ol style="margin:0;padding-left:20px;color:var(--text);font-size:13px;line-height:1.8;">
                    <li>Copiez les informations ci-dessous</li>
                    <li>Ouvrez Gmail ou votre messagerie (onglet s√©par√© ou priv√©)</li>
                    <li>Connectez-vous avec : <strong>serviceclient.zenoccaz@gmail.com</strong></li>
                    <li>Cr√©ez un nouveau message et collez les informations</li>
                  </ol>
                </div>
                
                <!-- Destinataire -->
                <div>
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <label style="font-size:13px;color:var(--muted);font-weight:600;">√Ä :</label>
                    <button id="copy-to-btn" style="padding:4px 12px;background:rgba(59,130,246,0.2);border:none;border-radius:6px;color:#60a5fa;font-size:12px;cursor:pointer;">üìã Copier</button>
                  </div>
                  <input readonly value="${toEmail}" style="width:100%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text);font-size:14px;">
                </div>
                
                <!-- Objet -->
                <div>
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <label style="font-size:13px;color:var(--muted);font-weight:600;">Objet :</label>
                    <button id="copy-subject-btn" style="padding:4px 12px;background:rgba(59,130,246,0.2);border:none;border-radius:6px;color:#60a5fa;font-size:12px;cursor:pointer;">üìã Copier</button>
                  </div>
                  <input readonly value="${subject}" style="width:100%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text);font-size:14px;">
                </div>
                
                <!-- Message -->
                <div>
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <label style="font-size:13px;color:var(--muted);font-weight:600;">Message :</label>
                    <button id="copy-body-btn" style="padding:4px 12px;background:rgba(59,130,246,0.2);border:none;border-radius:6px;color:#60a5fa;font-size:12px;cursor:pointer;">üìã Copier</button>
                  </div>
                  <textarea readonly style="width:100%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text);font-size:14px;min-height:200px;resize:vertical;font-family:inherit;">${body}</textarea>
                </div>
                
                <!-- Bouton tout copier -->
                <button id="copy-all-btn" style="padding:16px;background:linear-gradient(135deg,#10b981,#059669);border:none;border-radius:10px;color:white;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;transition:transform 0.2s;font-size:15px;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                  <span style="font-size:20px;">üìã</span>
                  Tout copier dans le presse-papier
                </button>
                
                <!-- Liens rapides -->
                <div style="border-top:1px solid rgba(255,255,255,0.1);padding-top:20px;">
                  <div style="font-size:13px;color:var(--muted);margin-bottom:12px;font-weight:600;">üîó Ouvrir votre messagerie :</div>
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <a href="https://mail.google.com" target="_blank" style="padding:12px;background:rgba(234,67,53,0.15);border:1px solid rgba(234,67,53,0.3);border-radius:8px;text-decoration:none;color:#ea4335;font-weight:600;text-align:center;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='rgba(234,67,53,0.25)'" onmouseout="this.style.background='rgba(234,67,53,0.15)'">üì¨ Gmail</a>
                    <a href="https://outlook.live.com/mail" target="_blank" style="padding:12px;background:rgba(0,120,212,0.15);border:1px solid rgba(0,120,212,0.3);border-radius:8px;text-decoration:none;color:#0078d4;font-weight:600;text-align:center;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='rgba(0,120,212,0.25)'" onmouseout="this.style.background='rgba(0,120,212,0.15)'">üìÆ Outlook</a>
                  </div>
                </div>
              </div>
              
              <button id="cancel-mail-btn" style="margin-top:20px;width:100%;padding:12px;background:rgba(255,255,255,0.1);border:none;border-radius:8px;color:var(--text);font-weight:500;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">Fermer</button>
            </div>
          </div>
        `
        
        document.body.insertAdjacentHTML('beforeend', modalHtml)
        
        const modal = document.getElementById('mail-choice-modal')
        
        // Fonction de copie
        function copyToClipboard(text, btn){
          navigator.clipboard.writeText(text).then(()=>{
            const originalText = btn.textContent
            btn.textContent = '‚úì Copi√© !'
            btn.style.background = 'rgba(16,185,129,0.3)'
            setTimeout(()=>{
              btn.textContent = originalText
              btn.style.background = 'rgba(59,130,246,0.2)'
            }, 2000)
          }).catch(()=> alert('‚ùå Erreur de copie'))
        }
        
        // Copier destinataire
        document.getElementById('copy-to-btn').addEventListener('click', (e)=>{
          copyToClipboard(toEmail, e.target)
        })
        
        // Copier objet
        document.getElementById('copy-subject-btn').addEventListener('click', (e)=>{
          copyToClipboard(subject, e.target)
        })
        
        // Copier message
        document.getElementById('copy-body-btn').addEventListener('click', (e)=>{
          copyToClipboard(body, e.target)
        })
        
        // Tout copier
        document.getElementById('copy-all-btn').addEventListener('click', (e)=>{
          const fullText = `√Ä : ${toEmail}\n\nObjet : ${subject}\n\nMessage :\n${body}`
          copyToClipboard(fullText, e.target)
        })
        
        // Fermer
        document.getElementById('cancel-mail-btn').addEventListener('click', ()=>{ modal.remove() })
        
        // Fermer au clic sur le fond
        modal.addEventListener('click', (e)=>{
          if(e.target.id === 'mail-choice-modal'){
            modal.remove()
          }
        })
      }

      parrainageCancel.addEventListener('click', closeParrainageModal)
      parrainageModal.addEventListener('click', (e)=>{ if(e.target === parrainageModal) closeParrainageModal() })

      parrainageForm.addEventListener('submit', async (e)=>{
        e.preventDefault()
        const editId = document.getElementById('parr-id').value
        const parrain = document.getElementById('parr-parrain').value.trim()
        const parrain_email = document.getElementById('parr-email').value.trim()
        const filleul = document.getElementById('parr-filleul').value.trim()
        const reward_type = document.getElementById('parr-reward').value
        const status = document.getElementById('parr-status').value
        const commission = document.getElementById('parr-commission').value.trim() || '0'
        if(!parrain){ alert('‚ùå Le nom du parrain est requis'); return }
        if(!reward_type){ alert('‚ùå Le type de r√©compense est requis'); return }
        
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }
          
          if(editId){
            // Mise √† jour
            const { error } = await window.supabase.from('parrainages').update({
              parrain, 
              parrain_email, 
              filleul, 
              reward_type,
              status, 
              commission: parseFloat(commission)
            }).eq('id', parseInt(editId));
            
            if(error){
              console.error('‚ùå Erreur mise √† jour parrainage:', error);
              alert('‚ùå Erreur lors de la mise √† jour du parrainage');
              return;
            }
            console.log('‚úÖ Parrainage modifi√©');
          } else {
            // Insertion
            const id = Date.now()
            const newPa = {
              id, 
              parrain, 
              parrain_email, 
              filleul, 
              reward_type,
              status, 
              commission: parseFloat(commission)
              // created_at sera automatiquement ajout√© par Supabase
            }
            
            const { error } = await window.supabase.from('parrainages').insert([newPa]);
            if(error){
              console.error('‚ùå Erreur insertion parrainage:', error);
              alert('‚ùå Erreur lors de l\'ajout du parrainage');
              return;
            }
            console.log('‚úÖ Parrainage ajout√©');
          }
          
          await renderParrainageTable()
          await updateParrainageStats()
          closeParrainageModal()
        }catch(e){
          console.error('‚ùå Exception:', e);
          alert('‚ùå Erreur: ' + e.message);
        }
      })

      function addParrainageAdmin(){ 
        document.getElementById('parr-id').value = ''
        document.getElementById('parrainage-modal-title').textContent = 'Ajouter un parrainage'
        document.getElementById('parrainage-submit-btn').textContent = 'Ajouter'
        openParrainageModal() 
      }
      
      async function editParrainage(id){
        const arr = await loadParrainages()
        const parrainage = arr.find(x=>x.id===id)
        if(!parrainage) return
        
        document.getElementById('parr-id').value = id
        document.getElementById('parr-parrain').value = parrainage.parrain || ''
        document.getElementById('parr-email').value = parrainage.parrain_email || ''
        document.getElementById('parr-filleul').value = parrainage.filleul || ''
        document.getElementById('parr-reward').value = parrainage.reward_type || 'bon_125'
        document.getElementById('parr-status').value = parrainage.status || 'Actif'
        document.getElementById('parr-commission').value = parrainage.commission || '0'
        
        document.getElementById('parrainage-modal-title').textContent = 'Modifier le parrainage'
        document.getElementById('parrainage-submit-btn').textContent = 'Enregistrer'
        openParrainageModal()
      }

      async function deleteParrainage(id){
        if(!confirm('Supprimer ce parrainage ?')) return
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }
          const { error } = await window.supabase.from('parrainages').delete().eq('id', id);
          if(error){
            console.error('‚ùå Erreur suppression:', error);
            alert('‚ùå Erreur lors de la suppression');
            return;
          }
          console.log('‚úÖ Parrainage supprim√©');
          await renderParrainageTable();
          await updateParrainageStats();
        }catch(e){
          console.error('‚ùå Exception:', e);
        }
      }

      // Afficher la section Parrainages au clic
      if(parrainage_link){
        parrainage_link.addEventListener('click', async (e)=>{
          e.preventDefault()
          hideAllSections()
          parrainage_section.classList.remove('hidden')
          await renderParrainageTable()
          await updateParrainageStats()
        })
      }

      if(addParrainageBtn) addParrainageBtn.addEventListener('click', addParrainageAdmin)

      // ====== GESTION DES FINANCES ======
      const financeSection = document.getElementById('finances')
      const financesLink = document.querySelector('a[href="#finances"]')
      const addFinanceBtn = document.getElementById('add-finance-admin')

      async function loadFinances(){
        try{
          if(!window.supabase){
            console.error('‚ùå Supabase non initialis√©');
            return [];
          }
          const { data, error } = await window.supabase.from('finances').select('*').order('created_at', { ascending: false });
          if(error){
            console.error('‚ùå Erreur chargement finances:', error);
            return [];
          }
          console.log('‚úÖ Finances charg√©es depuis Supabase:', data.length);
          return data || [];
        }catch(e){
          console.error('‚ùå Exception loadFinances:', e);
          return [];
        }
      }

      function saveFinances(arr){
        // Deprecated: les finances sont maintenant g√©r√©es directement dans Supabase
      }

      function triggerMarginEffect(netMargin){
        // √âviter de d√©clencher l'effet plusieurs fois rapidement
        if(window.marginEffectActive) return
        window.marginEffectActive = true
        
        // Cr√©er le conteneur d'effet
        const container = document.createElement('div')
        container.className = 'margin-effect-container'
        
        if(netMargin > 0){
          // EFFET POSITIF - Cyberpunk futuriste üöÄ
          document.body.classList.add('screen-flash-green')
          
          // Texte glitch avec effet cyberpunk
          const text = document.createElement('div')
          text.className = 'margin-positive-effect'
          text.innerHTML = `üí∞ PROFIT D√âTECT√â ! üí∞<br><span style="font-size:48px;">+${netMargin.toFixed(2)} ‚Ç¨</span><br>üî• MONEY MODE üî•`
          container.appendChild(text)
          
          // Bordure cyberpunk anim√©e
          const border = document.createElement('div')
          border.className = 'cyberpunk-border'
          document.body.appendChild(border)
          
          // Particules vertes qui montent (comme des billets)
          for(let i = 0; i < 30; i++){
            const particle = document.createElement('div')
            particle.className = 'particle'
            particle.style.left = Math.random() * 100 + '%'
            particle.style.top = '100%'
            particle.style.background = `linear-gradient(135deg, #10b981, #3b82f6)`
            particle.style.animationDelay = Math.random() * 0.5 + 's'
            particle.style.animationDuration = (1 + Math.random()) + 's'
            particle.style.width = (10 + Math.random() * 20) + 'px'
            particle.style.height = particle.style.width
            particle.style.animation = 'particleFall 2s ease-out forwards reverse'
            container.appendChild(particle)
          }
          
          setTimeout(() => {
            border.remove()
          }, 3000)
          
        }else if(netMargin < 0){
          // EFFET N√âGATIF - Catastrophe visuelle üí•
          document.body.classList.add('screen-flash-red', 'screen-shake')
          
          // Texte glitch rouge/noir
          const text = document.createElement('div')
          text.className = 'margin-negative-effect'
          text.innerHTML = `‚ùå MARGE N√âGATIVE ‚ùå<br><span style="font-size:48px;">${netMargin.toFixed(2)} ‚Ç¨</span><br>üíÄ ALERTE PERTES üíÄ`
          container.appendChild(text)
          
          // Particules rouges qui tombent (effet de destruction)
          for(let i = 0; i < 50; i++){
            const particle = document.createElement('div')
            particle.className = 'particle'
            particle.style.left = Math.random() * 100 + '%'
            particle.style.top = Math.random() * 30 + '%'
            particle.style.background = `linear-gradient(135deg, #ef4444, #000)`
            particle.style.animationDelay = Math.random() * 0.5 + 's'
            particle.style.animationDuration = (1.5 + Math.random()) + 's'
            particle.style.width = (8 + Math.random() * 15) + 'px'
            particle.style.height = particle.style.width
            container.appendChild(particle)
          }
          
          setTimeout(() => {
            document.body.classList.remove('screen-shake')
          }, 500)
        }
        
        if(netMargin !== 0){
          document.body.appendChild(container)
          
          // Nettoyer apr√®s 3 secondes
          setTimeout(() => {
            container.remove()
            document.body.classList.remove('screen-flash-red', 'screen-flash-green')
            window.marginEffectActive = false
          }, 3000)
        }else{
          window.marginEffectActive = false
        }
      }

      async function updateFinanceDashboard(){
        const arr = await loadFinances()
        let revenue = 0, expenses = 0
        let vehicleRevenue = 0, zenscanRevenue = 0 // Revenus par cat√©gorie
        const vehiclesHtml = [], reprisesHtml = [], partsHtml = []
        
        arr.forEach(f=>{
          const amount = parseFloat(f.amount) || 0
          
          if(f.type === 'revenue'){
            revenue += amount
            // Cat√©goriser les revenus
            if(f.category === 'vehicle') vehicleRevenue += amount
            else if(f.category === 'zenscan') zenscanRevenue += amount
          }else{
            expenses += amount
          }
          
          const dateObj = new Date(f.created_at || f.date)
          const dateStr = dateObj.toLocaleDateString('fr-FR')
          const item = `<div style="padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;"><div><div style="font-weight:600;color:var(--text)">${escapeHtml(f.description||'‚Äî')}</div><div style="font-size:13px;color:var(--muted)">${dateStr}</div></div><div style="color:${f.type==='revenue'?'#10b981':'#ef4444'};font-weight:700;">${f.type==='revenue'?'+':'-'}${Math.abs(amount)} ‚Ç¨</div></div>`
          
          if(f.category === 'vehicle') vehiclesHtml.push(item)
          else if(f.category === 'reprise') reprisesHtml.push(item)
          else if(f.category === 'parts') partsHtml.push(item)
        })
        
        const profit = revenue - expenses
        const margin = revenue > 0 ? ((profit/revenue)*100).toFixed(1) : 0
        
        document.getElementById('finance-revenue').textContent = revenue.toFixed(2) + ' ‚Ç¨'
        document.getElementById('finance-expenses').textContent = expenses.toFixed(2) + ' ‚Ç¨'
        document.getElementById('finance-profit').textContent = profit.toFixed(2) + ' ‚Ç¨'
        document.getElementById('finance-margin').textContent = margin + '%'
        
        // Calcul URSSAF Vente Voitures (12,6%)
        const URSSAF_VEHICLE_RATE = 0.126
        const urssafVehicleTax = vehicleRevenue * URSSAF_VEHICLE_RATE
        const netMarginVehicle = vehicleRevenue - urssafVehicleTax
        const netMarginVehiclePercent = vehicleRevenue > 0 ? ((netMarginVehicle / vehicleRevenue) * 100).toFixed(1) : 0
        
        document.getElementById('urssaf-vehicle-revenue').textContent = vehicleRevenue.toFixed(2) + ' ‚Ç¨'
        document.getElementById('urssaf-vehicle-tax').textContent = urssafVehicleTax.toFixed(2) + ' ‚Ç¨'
        document.getElementById('urssaf-vehicle-net').textContent = netMarginVehicle.toFixed(2) + ' ‚Ç¨'
        document.getElementById('urssaf-vehicle-net-percent').textContent = netMarginVehiclePercent + '% du revenu brut'
        
        // Calcul URSSAF D√©pannage ZenScan (21,4%)
        const URSSAF_ZENSCAN_RATE = 0.214
        const urssafZenscanTax = zenscanRevenue * URSSAF_ZENSCAN_RATE
        const netMarginZenscan = zenscanRevenue - urssafZenscanTax
        const netMarginZenscanPercent = zenscanRevenue > 0 ? ((netMarginZenscan / zenscanRevenue) * 100).toFixed(1) : 0
        
        document.getElementById('urssaf-zenscan-revenue').textContent = zenscanRevenue.toFixed(2) + ' ‚Ç¨'
        document.getElementById('urssaf-zenscan-tax').textContent = urssafZenscanTax.toFixed(2) + ' ‚Ç¨'
        document.getElementById('urssaf-zenscan-net').textContent = netMarginZenscan.toFixed(2) + ' ‚Ç¨'
        document.getElementById('urssaf-zenscan-net-percent').textContent = netMarginZenscanPercent + '% du revenu brut'
        
        // Total des marges nettes
        const totalGlobalMargin = netMarginVehicle + netMarginZenscan
        document.getElementById('total-vehicle-margin').textContent = netMarginVehicle.toFixed(2) + ' ‚Ç¨'
        document.getElementById('total-zenscan-margin').textContent = netMarginZenscan.toFixed(2) + ' ‚Ç¨'
        document.getElementById('total-global-margin').textContent = totalGlobalMargin.toFixed(2) + ' ‚Ç¨'
        
        // Effets visuels selon la marge nette GLOBALE
        triggerMarginEffect(totalGlobalMargin)
        
        const vehiclesDiv = document.getElementById('finance-vehicles')
        vehiclesDiv.innerHTML = vehiclesHtml.length > 0 ? vehiclesHtml.join('') : '<div class="activity-empty">Aucun v√©hicule vendu.</div>'
        
        const reprisesDiv = document.getElementById('finance-reprises')
        const reprisesCount = reprisesHtml.length
        reprisesDiv.innerHTML = reprisesHtml.length > 0 ? `<div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:6px;margin-bottom:12px;border-left:3px solid #3b82f6;"><div style="color:#3b82f6;font-weight:700;font-size:16px;">${reprisesCount} v√©hicule${reprisesCount>1?'s':''} achet√©${reprisesCount>1?'s':''}</div></div>` + reprisesHtml.join('') : '<div class="activity-empty">Aucun v√©hicule achet√©.</div>'
        
        const partsDiv = document.getElementById('finance-parts')
        partsDiv.innerHTML = partsHtml.length > 0 ? partsHtml.join('') : '<div class="activity-empty">Aucun achat de pi√®ce.</div>'
        
        // V√©rifier si archivage mensuel n√©cessaire
        await checkMonthlyArchive()
      }

      // Fonction pour v√©rifier et archiver automatiquement chaque mois
      async function checkMonthlyArchive(){
        try{
          const now = new Date()
          const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`
          
          // V√©rifier le dernier archivage dans localStorage
          const lastArchive = localStorage.getItem('last_finance_archive')
          
          if(!lastArchive || lastArchive !== currentMonth){
            console.log('üìÖ Nouveau mois d√©tect√©, v√©rification des archives...')
            
            // Si on a un mois pr√©c√©dent √† archiver
            if(lastArchive){
              const finances = await loadFinances()
              
              // Filtrer les donn√©es du mois pr√©c√©dent
              const lastMonthDate = new Date(lastArchive + '-01')
              const previousMonthData = finances.filter(f => {
                const financeDate = new Date(f.created_at || f.date)
                return financeDate.getMonth() === lastMonthDate.getMonth() && 
                       financeDate.getFullYear() === lastMonthDate.getFullYear()
              })
              
              if(previousMonthData.length > 0){
                console.log(`üì¶ Archivage du mois ${lastArchive}...`)
                await archiveMonth(lastArchive, previousMonthData)
              }
            }
            
            // Mettre √† jour le mois courant
            localStorage.setItem('last_finance_archive', currentMonth)
          }
        }catch(e){
          console.error('‚ùå Erreur v√©rification archive mensuelle:', e)
        }
      }

      // Fonction pour archiver un mois et g√©n√©rer le PDF
      async function archiveMonth(monthStr, financeData){
        try{
          // Calculer les statistiques du mois
          let totalRevenue = 0, totalExpenses = 0
          let vehicleRevenue = 0, zenscanRevenue = 0
          let vehicleCount = 0, zenscanCount = 0, repriseCount = 0, partsCount = 0
          
          financeData.forEach(f => {
            const amount = parseFloat(f.amount) || 0
            if(f.type === 'revenue'){
              totalRevenue += amount
              if(f.category === 'vehicle'){
                vehicleRevenue += amount
                vehicleCount++
              }else if(f.category === 'zenscan'){
                zenscanRevenue += amount
                zenscanCount++
              }
            }else{
              totalExpenses += amount
              if(f.category === 'reprise') repriseCount++
              else if(f.category === 'parts') partsCount++
            }
          })
          
          const totalProfit = totalRevenue - totalExpenses
          const urssafVehicleTax = vehicleRevenue * 0.126
          const urssafZenscanTax = zenscanRevenue * 0.214
          const netMarginVehicle = vehicleRevenue - urssafVehicleTax
          const netMarginZenscan = zenscanRevenue - urssafZenscanTax
          const netMarginTotal = netMarginVehicle + netMarginZenscan
          
          // Cr√©er le nom du mois
          const [year, month] = monthStr.split('-')
          const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                              'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre']
          const monthName = `${monthNames[parseInt(month) - 1]} ${year}`
          
          // Enregistrer dans Supabase
          const archiveData = {
            month: monthStr,
            month_name: monthName,
            total_revenue: totalRevenue,
            total_expenses: totalExpenses,
            total_profit: totalProfit,
            vehicle_revenue: vehicleRevenue,
            zenscan_revenue: zenscanRevenue,
            vehicle_count: vehicleCount,
            zenscan_count: zenscanCount,
            reprise_count: repriseCount,
            parts_count: partsCount,
            urssaf_vehicle_tax: urssafVehicleTax,
            urssaf_zenscan_tax: urssafZenscanTax,
            net_margin_vehicle: netMarginVehicle,
            net_margin_zenscan: netMarginZenscan,
            net_margin_total: netMarginTotal,
            pdf_generated: false
          }
          
          const { error } = await window.supabase.from('finance_archives').insert([archiveData])
          if(error){
            console.error('‚ùå Erreur sauvegarde archive:', error)
            return
          }
          
          console.log('‚úÖ Archive cr√©√©e pour', monthName)
          
          // G√©n√©rer le PDF
          await generateMonthlyPDF(monthName, archiveData, financeData)
          
          // Supprimer les anciennes donn√©es financi√®res du mois archiv√©
          const idsToDelete = financeData.map(f => f.id)
          if(idsToDelete.length > 0){
            const { error: deleteError } = await window.supabase
              .from('finances')
              .delete()
              .in('id', idsToDelete)
            
            if(deleteError){
              console.error('‚ùå Erreur suppression anciennes finances:', deleteError)
            }else{
              console.log('‚úÖ Anciennes finances supprim√©es')
            }
          }
          
          alert(`‚úÖ Archive mensuelle cr√©√©e pour ${monthName}\n\nLe PDF a √©t√© t√©l√©charg√© automatiquement.`)
          
        }catch(e){
          console.error('‚ùå Erreur archivage:', e)
          alert('‚ùå Erreur lors de l\'archivage mensuel')
        }
      }

      // Fonction pour g√©n√©rer le PDF mensuel
      async function generateMonthlyPDF(monthName, stats, financeData){
        try{
          const { jsPDF } = window.jspdf
          const doc = new jsPDF()
          
          let y = 20
          
          // Titre
          doc.setFontSize(20)
          doc.setFont('helvetica', 'bold')
          doc.text('ZENOCCAZ - Rapport Financier Mensuel', 105, y, { align: 'center' })
          y += 15
          
          doc.setFontSize(14)
          doc.text(monthName, 105, y, { align: 'center' })
          y += 15
          
          // R√©sum√©
          doc.setFontSize(12)
          doc.setFont('helvetica', 'bold')
          doc.text('R√âSUM√â FINANCIER', 20, y)
          y += 10
          
          doc.setFont('helvetica', 'normal')
          doc.setFontSize(10)
          doc.text(`Revenus totaux: ${stats.total_revenue.toFixed(2)} ‚Ç¨`, 20, y)
          y += 7
          doc.text(`D√©penses totales: ${stats.total_expenses.toFixed(2)} ‚Ç¨`, 20, y)
          y += 7
          doc.text(`B√©n√©fice brut: ${stats.total_profit.toFixed(2)} ‚Ç¨`, 20, y)
          y += 15
          
          // Vente voitures
          doc.setFont('helvetica', 'bold')
          doc.text('VENTE VOITURES (URSSAF 12,6%)', 20, y)
          y += 7
          doc.setFont('helvetica', 'normal')
          doc.text(`Revenus: ${stats.vehicle_revenue.toFixed(2)} ‚Ç¨`, 30, y)
          y += 6
          doc.text(`Cotisations URSSAF: ${stats.urssaf_vehicle_tax.toFixed(2)} ‚Ç¨`, 30, y)
          y += 6
          doc.text(`Marge nette: ${stats.net_margin_vehicle.toFixed(2)} ‚Ç¨`, 30, y)
          y += 6
          doc.text(`V√©hicules vendus: ${stats.vehicle_count}`, 30, y)
          y += 12
          
          // D√©pannage ZenScan
          doc.setFont('helvetica', 'bold')
          doc.text('D√âPANNAGE ZENSCAN (URSSAF 21,4%)', 20, y)
          y += 7
          doc.setFont('helvetica', 'normal')
          doc.text(`Revenus: ${stats.zenscan_revenue.toFixed(2)} ‚Ç¨`, 30, y)
          y += 6
          doc.text(`Cotisations URSSAF: ${stats.urssaf_zenscan_tax.toFixed(2)} ‚Ç¨`, 30, y)
          y += 6
          doc.text(`Marge nette: ${stats.net_margin_zenscan.toFixed(2)} ‚Ç¨`, 30, y)
          y += 6
          doc.text(`Services effectu√©s: ${stats.zenscan_count}`, 30, y)
          y += 12
          
          // Total
          doc.setFont('helvetica', 'bold')
          doc.setFontSize(12)
          doc.text(`MARGE NETTE TOTALE: ${stats.net_margin_total.toFixed(2)} ‚Ç¨`, 20, y)
          y += 15
          
          // D√©tails des transactions
          if(y > 250){
            doc.addPage()
            y = 20
          }
          
          doc.setFontSize(12)
          doc.text('D√âTAILS DES TRANSACTIONS', 20, y)
          y += 10
          
          doc.setFontSize(9)
          financeData.forEach((f, i) => {
            if(y > 270){
              doc.addPage()
              y = 20
            }
            const date = new Date(f.created_at || f.date).toLocaleDateString('fr-FR')
            const type = f.type === 'revenue' ? '+ Revenu' : '- D√©pense'
            const text = `${date} | ${type} | ${f.description || 'N/A'} | ${Math.abs(parseFloat(f.amount) || 0).toFixed(2)} ‚Ç¨`
            doc.text(text, 20, y)
            y += 6
          })
          
          // Sauvegarder
          const fileName = `ZENOCCAZ_Finances_${monthName.replace(' ', '_')}.pdf`
          doc.save(fileName)
          
          console.log('‚úÖ PDF g√©n√©r√©:', fileName)
          
        }catch(e){
          console.error('‚ùå Erreur g√©n√©ration PDF:', e)
        }
      }

      const financeModal = document.getElementById('finance-modal')
      const financeForm = document.getElementById('finance-form')
      const financeCancel = document.getElementById('finance-cancel')

      function openFinanceModal(){
        financeModal.classList.remove('hidden')
        financeModal.setAttribute('aria-hidden','false')
        financeForm.reset()
        document.getElementById('fin-desc').focus()
      }

      function closeFinanceModal(){
        financeModal.classList.add('hidden')
        financeModal.setAttribute('aria-hidden','true')
      }

      financeCancel.addEventListener('click', closeFinanceModal)
      financeModal.addEventListener('click', (e)=>{ if(e.target === financeModal) closeFinanceModal() })

      financeForm.addEventListener('submit', async (e)=>{
        e.preventDefault()
        const description = document.getElementById('fin-desc').value.trim()
        const type = document.getElementById('fin-type').value
        const amount = document.getElementById('fin-amount').value.trim()
        const category = document.getElementById('fin-category').value
        if(!description || !amount){ alert('‚ùå La description et le montant sont requis'); return }
        
        const id = Date.now()
        const newF = {
          id, 
          description, 
          type, 
          amount: parseFloat(amount), 
          category
          // created_at sera automatiquement ajout√© par Supabase
        }
        
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }
          const { error } = await window.supabase.from('finances').insert([newF]);
          if(error){
            console.error('‚ùå Erreur insertion finance:', error);
            alert('‚ùå Erreur lors de l\'ajout de la transaction');
            return;
          }
          console.log('‚úÖ Transaction financi√®re ajout√©e');
          await updateFinanceDashboard()
          closeFinanceModal()
        }catch(e){
          console.error('‚ùå Exception:', e);
          alert('‚ùå Erreur: ' + e.message);
        }
      })

      function addFinanceAdmin(){ openFinanceModal() }

      // Afficher la section Finances au clic
      if(financesLink){
        financesLink.addEventListener('click', async (e)=>{
          e.preventDefault()
          hideAllSections()
          financeSection.classList.remove('hidden')
          await updateFinanceDashboard()
        })
      }

      if(addFinanceBtn) addFinanceBtn.addEventListener('click', addFinanceAdmin)
      // ====== GESTION DES ZENSCAN (demandes) ======
      const zenscanTbody = document.getElementById('zenscan-table-body')
      const zenscanSection = document.getElementById('zenscan')
      const zenscanLink = document.querySelector('a[href="#zenscan"]')

      async function loadZenscans(){
        try{
          if(!window.supabase){
            console.error('‚ùå Supabase non initialis√©');
            return [];
          }
          const { data, error } = await window.supabase.from('zenscan_requests').select('*').order('created_at', { ascending: false });
          if(error){
            console.error('‚ùå Erreur chargement zenscan:', error);
            return [];
          }
          console.log('‚úÖ ZenScan charg√©s depuis Supabase:', data.length);
          return data || [];
        }catch(e){
          console.error('‚ùå Exception loadZenscans:', e);
          return [];
        }
      }
      
      function saveZenscans(arr){
        // Deprecated: les zenscan sont maintenant g√©r√©s directement dans Supabase
      }

      async function renderZenscanTable(){
        const arr = await loadZenscans()
        zenscanTbody.innerHTML = ''
        if(arr.length===0){
          const tr = document.createElement('tr')
          tr.innerHTML = '<td colspan="7" class="activity-empty">Aucune demande ZenScan.</td>'
          zenscanTbody.appendChild(tr)
          return
        }
        const contacts = await loadContacts()
        arr.forEach(r=>{
          const tr = document.createElement('tr')
          const dateObj = new Date(r.created_at || r.date)
          const dateStr = dateObj.toLocaleDateString('fr-FR') + ' ' + dateObj.toLocaleTimeString('fr-FR')
          const contact = contacts.find(c=> c.id === r.contact_id || c.id === r.contactId)
          const clientName = contact ? escapeHtml(contact.name) : ('Contact #' + (r.contactId||'‚Äî'))
          // prefer to show the exact request text (breakdown) if available, preserving lines and making each line a distinct item
          const breakdownRaw = r.breakdown || ''
          let servicesHtml = ''
          // Cr√©er un r√©sum√© tronqu√© des services
          let servicesPreview = ''
          let servicesFullText = ''
          if(breakdownRaw){
            servicesFullText = breakdownRaw
            const firstLine = breakdownRaw.split('\n')[0].trim()
            servicesPreview = escapeHtml(firstLine.substring(0, 50)) + (firstLine.length > 50 || breakdownRaw.split('\n').length > 1 ? '...' : '')
          } else if((r.services||[]).length){
            servicesFullText = (r.services||[]).join('\n')
            servicesPreview = escapeHtml((r.services||[])[0].substring(0, 50)) + ((r.services||[])[0].length > 50 || (r.services||[]).length > 1 ? '...' : '')
          } else {
            servicesPreview = '‚Äî'
            servicesFullText = '‚Äî'
          }
          
          const dest = escapeHtml(r.dest||'‚Äî')
          const total = escapeHtml(r.total||'‚Äî')
          const statusBadge = r.confirmed ? '<span style="background:rgba(16,185,129,0.12);color:#10b981;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;">‚úì Confirm√©</span>' : ''
          const confirmBtn = r.confirmed ? '' : `<button class="confirm-zenscan" data-id="${r.id}" data-total="${escapeHtml(r.total||'')}" data-client="${escapeHtml(clientName)}" style="background:rgba(16,185,129,0.1);color:#10b981;border:1px solid rgba(16,185,129,0.2);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:16px;transition:all 0.2s;margin-right:8px;" onmouseover="this.style.background='rgba(16,185,129,0.2)'" onmouseout="this.style.background='rgba(16,185,129,0.1)'" title="Confirmer">‚úÖ</button>`
          
          tr.innerHTML = `<td style="white-space:nowrap;">${r.id}</td><td style="min-width:160px">${clientName}</td><td style="cursor:pointer;color:#f97316;" class="zenscan-view-details" data-id="${r.id}" title="Cliquer pour voir les d√©tails">${servicesPreview}</td><td style="min-width:180px">${dest}</td><td style="white-space:nowrap">${total} ${statusBadge}</td><td style="white-space:nowrap">${dateStr}</td><td><div class="action-links" style="display:flex;gap:8px;">${confirmBtn}<button class="del-zenscan" data-id="${r.id}" style="background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.2);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:16px;transition:all 0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.2)'" onmouseout="this.style.background='rgba(239,68,68,0.1)'" title="Supprimer">üóëÔ∏è</button></div></td>`
          
          // Stocker les donn√©es compl√®tes pour le modal
          tr.dataset.zenscanData = JSON.stringify({
            id: r.id,
            client: clientName,
            services: servicesFullText,
            dest: r.dest || '‚Äî',
            total: r.total || '‚Äî',
            date: dateStr,
            confirmed: r.confirmed
          })
          
          zenscanTbody.appendChild(tr)
        })

        zenscanTbody.querySelectorAll('.zenscan-view-details').forEach(el=> el.addEventListener('click', (e)=>{
          const tr = e.target.closest('tr')
          const data = JSON.parse(tr.dataset.zenscanData)
          showZenscanDetails(data)
        }))
        
        zenscanTbody.querySelectorAll('.confirm-zenscan').forEach(el=> el.addEventListener('click', (e)=>{
          e.stopPropagation()
          const id = Number(e.target.dataset.id)
          const total = e.target.dataset.total
          const client = e.target.dataset.client
          confirmZenscan(id, total, client)
        }))
        zenscanTbody.querySelectorAll('.del-zenscan').forEach(el=> el.addEventListener('click', (e)=>{
          e.stopPropagation()
          const id = Number(e.target.dataset.id)
          deleteZenscan(id)
        }))
      }

      // Modal d√©tails ZenScan
      const zenscanDetailsModal = document.getElementById('zenscan-details-modal')
      const zenscanDetailsClose = document.getElementById('zenscan-details-close')
      
      function showZenscanDetails(data){
        const content = document.getElementById('zenscan-details-content')
        const servicesLines = data.services.split('\n').map(line => `<div style="padding:8px;background:rgba(249,115,22,0.05);border-left:3px solid #f97316;margin-bottom:8px;border-radius:4px;">${escapeHtml(line)}</div>`).join('')
        
        content.innerHTML = `
          <div style="background:rgba(255,255,255,0.02);padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);">
            <div style="display:grid;gap:12px;">
              <div><strong style="color:var(--muted);">R√©f√©rence:</strong> <span style="color:var(--text);">${data.id}</span></div>
              <div><strong style="color:var(--muted);">Client:</strong> <span style="color:var(--text);">${data.client}</span></div>
              <div><strong style="color:var(--muted);">Date:</strong> <span style="color:var(--text);">${data.date}</span></div>
              <div><strong style="color:var(--muted);">Destination:</strong> <span style="color:var(--text);">${escapeHtml(data.dest)}</span></div>
              <div><strong style="color:var(--muted);">Total:</strong> <span style="color:#10b981;font-size:18px;font-weight:700;">${escapeHtml(data.total)}</span></div>
              ${data.confirmed ? '<div><span style="background:rgba(16,185,129,0.12);color:#10b981;padding:6px 12px;border-radius:6px;font-weight:600;">‚úì Confirm√©</span></div>' : ''}
            </div>
          </div>
          <div style="margin-top:16px;">
            <strong style="color:var(--text);margin-bottom:12px;display:block;">Services demand√©s:</strong>
            ${servicesLines}
          </div>
        `
        
        zenscanDetailsModal.classList.remove('hidden')
        zenscanDetailsModal.setAttribute('aria-hidden', 'false')
      }
      
      function closeZenscanDetailsModal(){
        zenscanDetailsModal.classList.add('hidden')
        zenscanDetailsModal.setAttribute('aria-hidden', 'true')
      }
      
      zenscanDetailsClose.addEventListener('click', closeZenscanDetailsModal)
      zenscanDetailsModal.addEventListener('click', (e)=>{ if(e.target === zenscanDetailsModal) closeZenscanDetailsModal() })

      async function confirmZenscan(id, totalStr, clientName){
        if(!confirm(`Confirmer la demande ZenScan pour ${clientName} (${totalStr}) ?`)) return
        console.log('‚úÖ Confirmation ZenScan ID:', id);
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }

          // 1. Marquer la demande comme confirm√©e
          const { error: updateError } = await window.supabase
            .from('zenscan_requests')
            .update({ confirmed: true })
            .eq('id', id);

          if(updateError){
            console.error('‚ùå Erreur mise √† jour ZenScan:', updateError);
            alert('‚ùå Erreur lors de la mise √† jour');
            return;
          }

          // 2. Extraire le montant num√©rique du total (ex: "250 ‚Ç¨" -> 250)
          const amount = parseFloat(totalStr.replace(/[^0-9.-]/g, '')) || 0;

          if(amount > 0){
            // 3. Ajouter une entr√©e dans finances
            const financeId = Date.now();
            const financeEntry = {
              id: financeId,
              description: `ZenScan: ${clientName}`,
              type: 'revenue',
              amount: amount,
              category: 'zenscan',
              zenscan_id: id
            };

            const { error: financeError } = await window.supabase
              .from('finances')
              .insert([financeEntry]);

            if(financeError){
              console.error('‚ùå Erreur ajout finance:', financeError);
              alert('‚ùå Erreur lors de l\'ajout dans les finances');
              return;
            }

            console.log('‚úÖ Entr√©e finance cr√©√©e pour ZenScan');
          }

          alert('‚úÖ ZenScan confirm√© et ajout√© aux finances !');
          await renderZenscanTable();
          
          // Rafra√Æchir les finances si la section est ouverte
          const financeSection = document.getElementById('finances');
          if(financeSection && !financeSection.classList.contains('hidden')){
            await updateFinanceDashboard();
          }
        }catch(e){
          console.error('‚ùå Exception confirmZenscan:', e);
          alert('‚ùå Erreur: ' + e.message);
        }
      }

      async function deleteZenscan(id){ 
        if(!confirm('Supprimer cette demande ZenScan ?')) return; 
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }

          // 1. Rechercher et supprimer l'entr√©e finance li√©e (si confirm√©)
          console.log('üí∞ Recherche entr√©e finance pour zenscan_id:', id);
          const { data: financeEntries, error: financeSearchError } = await window.supabase
            .from('finances')
            .select('*')
            .eq('zenscan_id', id);

          if(financeSearchError){
            console.error('‚ùå Erreur recherche finance:', financeSearchError);
          } else if(financeEntries && financeEntries.length > 0){
            console.log('‚úÖ Trouv√©', financeEntries.length, 'entr√©e(s) finance √† supprimer');
            for(const entry of financeEntries){
              const { error: financeDeleteError } = await window.supabase
                .from('finances')
                .delete()
                .eq('id', entry.id);

              if(financeDeleteError){
                console.error('‚ùå Erreur suppression finance ID', entry.id, ':', financeDeleteError);
              } else {
                console.log('‚úÖ Entr√©e finance ID', entry.id, 'supprim√©e (montant:', entry.amount, '‚Ç¨)');
              }
            }
          } else {
            console.log('‚ÑπÔ∏è Aucune entr√©e finance trouv√©e pour zenscan_id:', id);
          }

          // 2. Supprimer la demande ZenScan
          const { error } = await window.supabase.from('zenscan_requests').delete().eq('id', id);
          if(error){
            console.error('‚ùå Erreur suppression:', error);
            alert('‚ùå Erreur lors de la suppression');
            return;
          }
          console.log('‚úÖ ZenScan supprim√©');
          await renderZenscanTable();
          
          // Rafra√Æchir les finances si la section est ouverte
          const financeSection = document.getElementById('finances');
          if(financeSection && !financeSection.classList.contains('hidden')){
            await updateFinanceDashboard();
          }
        }catch(e){
          console.error('‚ùå Exception:', e);
        }
      }

      if(zenscanLink){ zenscanLink.addEventListener('click', async (e)=>{ e.preventDefault(); hideAllSections(); zenscanSection.classList.remove('hidden'); await renderZenscanTable(); }) }

      // ====== GESTION DES REPRISES (v√©hicules rachet√©s) ======
      const reprisesTableDiv = document.getElementById('reprises-table')
      const reprisesSection = document.getElementById('reprises')
      const reprisesLink = document.querySelector('a[href="#reprises"]')
      const reprisesModal = document.getElementById('reprises-modal')
      const reprisesForm = document.getElementById('reprises-form')

      async function loadReprises(){
        try{
          if(!window.supabase){
            console.error('‚ùå Supabase non initialis√©');
            return [];
          }
          const { data, error } = await window.supabase.from('reprises').select('*').order('purchase_date', { ascending: false });
          if(error){
            console.error('‚ùå Erreur chargement reprises:', error);
            return [];
          }
          console.log('‚úÖ Reprises charg√©es depuis Supabase:', data.length);
          return data || [];
        }catch(e){
          console.error('‚ùå Exception loadReprises:', e);
          return [];
        }
      }

      async function renderReprisesTable(){
        const arr = await loadReprises()
        if(arr.length===0){
          reprisesTableDiv.innerHTML = '<div class="activity-empty" style="text-align:center;padding:40px;color:var(--muted);">Aucun v√©hicule repris pour le moment.</div>'
          return
        }
        
        let html = '<table style="width:100%;border-collapse:separate;border-spacing:0 8px;"><thead><tr style="color:var(--muted);font-size:13px;text-align:left;"><th style="padding:12px;">V√©hicule</th><th style="padding:12px;">Vendeur</th><th style="padding:12px;">Prix d\'achat</th><th style="padding:12px;">Date</th><th style="padding:12px;">Statut</th><th style="padding:12px;">Actions</th></tr></thead><tbody>'
        
        arr.forEach(rep=>{
          const dateStr = new Date(rep.purchase_date).toLocaleDateString('fr-FR')
          const statusColors = {
            'Achet√©': {bg: 'rgba(59,130,246,0.12)', color: '#3b82f6'},
            'En r√©paration': {bg: 'rgba(245,158,11,0.12)', color: '#f59e0b'},
            'Pr√™t √† la vente': {bg: 'rgba(16,185,129,0.12)', color: '#10b981'},
            'Vendu': {bg: 'rgba(107,114,128,0.12)', color: '#6b7280'}
          }
          const statusStyle = statusColors[rep.status] || {bg: 'rgba(159,182,214,0.12)', color: '#9fb6d6'}
          
          html += `<tr class="reprise-row" data-id="${rep.id}" style="background:rgba(255,255,255,0.02);border-radius:8px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.04)'" onmouseout="this.style.background='rgba(255,255,255,0.02)'" title="Cliquer pour voir tous les d√©tails"><td style="padding:20px 16px;border-top-left-radius:8px;border-bottom-left-radius:8px;"><div><div style="font-weight:600;color:var(--text);margin-bottom:4px;">${escapeHtml(rep.make)} ${escapeHtml(rep.model)}</div><div style="font-size:13px;color:var(--muted);">${rep.year} ‚Ä¢ ${rep.mileage.toLocaleString()} km ‚Ä¢ ${escapeHtml(rep.fuel_type)}</div><div style="font-size:12px;color:var(--muted);margin-top:2px;">üìã ${escapeHtml(rep.registration)}</div></div></td><td style="padding:20px 16px;"><div><div style="color:var(--text);font-weight:500;margin-bottom:2px;">${escapeHtml(rep.seller_name)}</div><div style="font-size:13px;color:var(--muted);">${escapeHtml(rep.seller_phone||'‚Äî')}</div></div></td><td style="padding:20px 16px;"><div style="font-weight:700;color:#10b981;font-size:16px;">${parseFloat(rep.purchase_price).toLocaleString()} ‚Ç¨</div></td><td style="padding:20px 16px;"><div style="color:var(--muted);font-size:13px;">${dateStr}</div></td><td style="padding:20px 16px;"><span style="background:${statusStyle.bg};color:${statusStyle.color};padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;display:inline-block;">${escapeHtml(rep.status)}</span></td><td style="padding:20px 16px;border-top-right-radius:8px;border-bottom-right-radius:8px;"><div style="display:flex;gap:8px;"><span class="edit-reprise" data-id="${rep.id}" title="Modifier" style="cursor:pointer;padding:6px 10px;background:rgba(16,185,129,0.1);border-radius:6px;font-size:16px;transition:all 0.2s;">‚úèÔ∏è</span><span class="del-reprise" data-id="${rep.id}" title="Supprimer" style="cursor:pointer;padding:6px 10px;background:rgba(239,68,68,0.1);border-radius:6px;font-size:16px;transition:all 0.2s;">üóëÔ∏è</span></div></td></tr>`
        })
        
        html += '</tbody></table>'
        reprisesTableDiv.innerHTML = html
        
        // Attacher les √©v√©nements
        document.querySelectorAll('.reprise-row').forEach(row=> row.addEventListener('click', async (e)=>{
          // Ne pas ouvrir le modal si on clique sur edit ou delete
          if(e.target.closest('.edit-reprise') || e.target.closest('.del-reprise')) return
          const id = Number(row.dataset.id)
          const repData = arr.find(r=> r.id === id)
          if(repData) showRepriseDetails(repData)
        }))
        
        document.querySelectorAll('.edit-reprise').forEach(el=> el.addEventListener('click', (e)=>{
          e.stopPropagation()
          const id = Number(e.target.dataset.id)
          editReprise(id)
        }))
        
        document.querySelectorAll('.del-reprise').forEach(el=> el.addEventListener('click', (e)=>{
          e.stopPropagation()
          const id = Number(e.target.dataset.id)
          deleteReprise(id)
        }))
      }

      // Modal d√©tails reprise
      const repriseDetailsModal = document.getElementById('reprise-details-modal')
      const repriseDetailsClose = document.getElementById('reprise-details-close')
      
      function showRepriseDetails(rep){
        const content = document.getElementById('reprise-details-content')
        const dateStr = new Date(rep.purchase_date).toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' })
        
        // Formater les documents
        const documentsHtml = (rep.documents && rep.documents.length > 0) 
          ? rep.documents.map(doc => `<span style="background:rgba(16,185,129,0.1);color:#10b981;padding:4px 8px;border-radius:4px;font-size:12px;margin-right:8px;display:inline-block;margin-bottom:4px;">‚úì ${escapeHtml(doc)}</span>`).join('')
          : '<span style="color:var(--muted);">Aucun document</span>'
        
        content.innerHTML = `
          <!-- Informations du v√©hicule -->
          <div style="background:linear-gradient(135deg, rgba(16,185,129,0.1), rgba(59,130,246,0.1));padding:20px;border-radius:12px;border:1px solid rgba(16,185,129,0.2);">
            <h3 style="margin:0 0 16px;color:var(--text);font-size:24px;font-weight:700;">üöó ${escapeHtml(rep.make)} ${escapeHtml(rep.model)}</h3>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">Ann√©e</div>
                <div style="color:var(--text);font-weight:600;font-size:16px;">${rep.year}</div>
              </div>
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">Kilom√©trage</div>
                <div style="color:var(--text);font-weight:600;font-size:16px;">${rep.mileage.toLocaleString()} km</div>
              </div>
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">Carburant</div>
                <div style="color:var(--text);font-weight:600;font-size:16px;">${escapeHtml(rep.fuel_type)}</div>
              </div>
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">Immatriculation</div>
                <div style="color:var(--text);font-weight:600;font-size:16px;">üìã ${escapeHtml(rep.registration)}</div>
              </div>
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">VIN</div>
                <div style="color:var(--text);font-weight:600;font-size:16px;">${escapeHtml(rep.vin || '‚Äî')}</div>
              </div>
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">Statut</div>
                <div style="color:#10b981;font-weight:600;font-size:16px;">${escapeHtml(rep.status)}</div>
              </div>
            </div>
          </div>
          
          <!-- Informations du vendeur -->
          <div style="background:rgba(255,255,255,0.02);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);">
            <h3 style="margin:0 0 16px;color:var(--text);font-size:18px;font-weight:600;">üë§ Informations du vendeur</h3>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;">
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">Nom</div>
                <div style="color:var(--text);font-weight:600;">${escapeHtml(rep.seller_name)}</div>
              </div>
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">T√©l√©phone</div>
                <div style="color:var(--text);font-weight:600;">${escapeHtml(rep.seller_phone || '‚Äî')}</div>
              </div>
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">Email</div>
                <div style="color:var(--text);font-weight:600;">${escapeHtml(rep.seller_email || '‚Äî')}</div>
              </div>
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">Adresse</div>
                <div style="color:var(--text);font-weight:600;">${escapeHtml(rep.seller_address || '‚Äî')}</div>
              </div>
            </div>
          </div>
          
          <!-- Informations d'achat -->
          <div style="background:rgba(255,255,255,0.02);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);">
            <h3 style="margin:0 0 16px;color:var(--text);font-size:18px;font-weight:600;">üí∞ Informations d'achat</h3>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">Acheteur</div>
                <div style="color:var(--text);font-weight:600;font-size:16px;">${escapeHtml(rep.buyer_name || '‚Äî')}</div>
              </div>
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">Prix d'achat</div>
                <div style="color:#10b981;font-weight:700;font-size:24px;">${parseFloat(rep.purchase_price).toLocaleString()} ‚Ç¨</div>
              </div>
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">Date de rachat</div>
                <div style="color:var(--text);font-weight:600;font-size:16px;">${dateStr}</div>
              </div>
            </div>
          </div>
          
          <!-- √âtat du v√©hicule -->
          <div style="background:rgba(255,255,255,0.02);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);">
            <h3 style="margin:0 0 16px;color:var(--text);font-size:18px;font-weight:600;">üîß √âtat du v√©hicule</h3>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:16px;">
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">Contr√¥le technique</div>
                <div style="color:var(--text);font-weight:600;">${escapeHtml(rep.technical_control || '‚Äî')}</div>
              </div>
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">Carnet d'entretien</div>
                <div style="color:var(--text);font-weight:600;">${escapeHtml(rep.maintenance_book || '‚Äî')}</div>
              </div>
              <div>
                <div style="color:var(--muted);font-size:13px;margin-bottom:4px;">√âtat g√©n√©ral</div>
                <div style="color:var(--text);font-weight:600;">${escapeHtml(rep.condition || '‚Äî')}</div>
              </div>
            </div>
            <div>
              <div style="color:var(--muted);font-size:13px;margin-bottom:8px;">Documents fournis</div>
              <div>${documentsHtml}</div>
            </div>
          </div>
          
          <!-- Notes -->
          ${rep.notes ? `
          <div style="background:rgba(249,115,22,0.05);padding:20px;border-radius:12px;border-left:4px solid #f97316;">
            <h3 style="margin:0 0 12px;color:var(--text);font-size:18px;font-weight:600;">üìù Notes et observations</h3>
            <div style="color:var(--text);line-height:1.6;white-space:pre-wrap;">${escapeHtml(rep.notes)}</div>
          </div>
          ` : ''}
        `
        
        repriseDetailsModal.classList.remove('hidden')
        repriseDetailsModal.setAttribute('aria-hidden', 'false')
      }
      
      function closeRepriseDetailsModal(){
        repriseDetailsModal.classList.add('hidden')
        repriseDetailsModal.setAttribute('aria-hidden', 'true')
      }
      
      repriseDetailsClose.addEventListener('click', closeRepriseDetailsModal)
      repriseDetailsModal.addEventListener('click', (e)=>{ if(e.target === repriseDetailsModal) closeRepriseDetailsModal() })

      window.openReprisesModal = function(){
        document.getElementById('reprises-modal-title').textContent = 'Ajouter un v√©hicule repris'
        document.getElementById('reprise-edit-id').value = ''
        reprisesForm.reset()
        // Date du jour par d√©faut
        document.getElementById('rep-purchase-date').valueAsDate = new Date()
        reprisesModal.classList.remove('hidden')
        reprisesModal.setAttribute('aria-hidden', 'false')
      }

      window.closeReprisesModal = function(){
        reprisesModal.classList.add('hidden')
        reprisesModal.setAttribute('aria-hidden', 'true')
        reprisesForm.reset()
      }

      async function editReprise(id){
        try{
          const arr = await loadReprises()
          const rep = arr.find(r=> r.id === id)
          if(!rep){
            alert('‚ùå Reprise introuvable')
            return
          }
          
          document.getElementById('reprises-modal-title').textContent = 'Modifier le v√©hicule repris'
          document.getElementById('reprise-edit-id').value = id
          document.getElementById('rep-make').value = rep.make || ''
          document.getElementById('rep-model').value = rep.model || ''
          document.getElementById('rep-year').value = rep.year || ''
          document.getElementById('rep-mileage').value = rep.mileage || ''
          document.getElementById('rep-fuel').value = rep.fuel_type || ''
          document.getElementById('rep-immat').value = rep.registration || ''
          document.getElementById('rep-vin').value = rep.vin || ''
          document.getElementById('rep-seller-name').value = rep.seller_name || ''
          document.getElementById('rep-seller-phone').value = rep.seller_phone || ''
          document.getElementById('rep-seller-email').value = rep.seller_email || ''
          document.getElementById('rep-seller-address').value = rep.seller_address || ''
          document.getElementById('rep-buyer-name').value = rep.buyer_name || ''
          document.getElementById('rep-purchase-price').value = rep.purchase_price || ''
          document.getElementById('rep-purchase-date').value = rep.purchase_date || ''
          document.getElementById('rep-status').value = rep.status || ''
          document.getElementById('rep-ct').value = rep.technical_control || ''
          document.getElementById('rep-carnet').value = rep.maintenance_book || ''
          document.getElementById('rep-condition').value = rep.condition || ''
          document.getElementById('rep-notes').value = rep.notes || ''
          
          // Cocher les documents
          const docs = rep.documents || []
          document.getElementById('doc-carte-grise').checked = docs.includes('Carte grise')
          document.getElementById('doc-certificat').checked = docs.includes('Certificat de cession')
          document.getElementById('doc-non-gage').checked = docs.includes('Certificat de non-gage')
          document.getElementById('doc-ct').checked = docs.includes('Contr√¥le technique')
          document.getElementById('doc-factures').checked = docs.includes('Factures d\'entretien')
          document.getElementById('doc-2cles').checked = docs.includes('2 cl√©s')
          
          reprisesModal.classList.remove('hidden')
          reprisesModal.setAttribute('aria-hidden', 'false')
        }catch(e){
          console.error('‚ùå Exception:', e)
          alert('‚ùå Erreur lors du chargement')
        }
      }

      async function deleteReprise(id){
        if(!confirm('‚ùå Supprimer d√©finitivement ce v√©hicule repris ?')) return
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }

          // 1. Rechercher et supprimer l'entr√©e finance li√©e
          console.log('üí∞ Recherche entr√©e finance pour reprise_id:', id);
          const { data: financeEntries, error: financeSearchError } = await window.supabase
            .from('finances')
            .select('*')
            .eq('reprise_id', id);

          if(financeSearchError){
            console.error('‚ùå Erreur recherche finance:', financeSearchError);
          } else if(financeEntries && financeEntries.length > 0){
            console.log('‚úÖ Trouv√©', financeEntries.length, 'entr√©e(s) finance √† supprimer');
            for(const entry of financeEntries){
              const { error: financeDeleteError } = await window.supabase
                .from('finances')
                .delete()
                .eq('id', entry.id);

              if(financeDeleteError){
                console.error('‚ùå Erreur suppression finance ID', entry.id, ':', financeDeleteError);
              } else {
                console.log('‚úÖ Entr√©e finance ID', entry.id, 'supprim√©e (montant:', entry.amount, '‚Ç¨)');
              }
            }
          } else {
            console.log('‚ÑπÔ∏è Aucune entr√©e finance trouv√©e pour reprise_id:', id);
          }

          // 2. Supprimer la reprise
          const { error } = await window.supabase.from('reprises').delete().eq('id', id);
          if(error){
            console.error('‚ùå Erreur suppression:', error);
            alert('‚ùå Erreur lors de la suppression');
            return;
          }
          console.log('‚úÖ Reprise supprim√©e');
          await renderReprisesTable();
          
          // Rafra√Æchir les finances si la section est ouverte
          const financeSection = document.getElementById('finances');
          if(financeSection && !financeSection.classList.contains('hidden')){
            await updateFinanceDashboard();
          }
        }catch(e){
          console.error('‚ùå Exception:', e);
        }
      }

      reprisesForm.addEventListener('submit', async (e)=>{
        e.preventDefault()
        
        const editId = document.getElementById('reprise-edit-id').value
        
        // R√©cup√©rer les documents coch√©s
        const documents = []
        if(document.getElementById('doc-carte-grise').checked) documents.push('Carte grise')
        if(document.getElementById('doc-certificat').checked) documents.push('Certificat de cession')
        if(document.getElementById('doc-non-gage').checked) documents.push('Certificat de non-gage')
        if(document.getElementById('doc-ct').checked) documents.push('Contr√¥le technique')
        if(document.getElementById('doc-factures').checked) documents.push('Factures d\'entretien')
        if(document.getElementById('doc-2cles').checked) documents.push('2 cl√©s')
        
        const repriseData = {
          make: document.getElementById('rep-make').value,
          model: document.getElementById('rep-model').value,
          year: parseInt(document.getElementById('rep-year').value),
          mileage: parseInt(document.getElementById('rep-mileage').value),
          fuel_type: document.getElementById('rep-fuel').value,
          registration: document.getElementById('rep-immat').value,
          vin: document.getElementById('rep-vin').value || null,
          seller_name: document.getElementById('rep-seller-name').value,
          seller_phone: document.getElementById('rep-seller-phone').value || null,
          seller_email: document.getElementById('rep-seller-email').value || null,
          seller_address: document.getElementById('rep-seller-address').value || null,
          buyer_name: document.getElementById('rep-buyer-name').value,
          purchase_price: parseFloat(document.getElementById('rep-purchase-price').value),
          purchase_date: document.getElementById('rep-purchase-date').value,
          status: document.getElementById('rep-status').value,
          technical_control: document.getElementById('rep-ct').value || null,
          maintenance_book: document.getElementById('rep-carnet').value || null,
          documents: documents,
          condition: document.getElementById('rep-condition').value || null,
          notes: document.getElementById('rep-notes').value || null
        }
        
        try{
          if(!window.supabase){
            alert('‚ùå Erreur: Supabase non initialis√©');
            return;
          }
          
          if(editId){
            // Mode √©dition
            const { error } = await window.supabase.from('reprises').update(repriseData).eq('id', parseInt(editId));
            if(error){
              console.error('‚ùå Erreur mise √† jour:', error);
              alert('‚ùå Erreur lors de la mise √† jour');
              return;
            }
            console.log('‚úÖ Reprise mise √† jour');
          }else{
            // Mode cr√©ation - Ne pas d√©finir l'ID, laisser PostgreSQL le g√©n√©rer
            const { data: newReprise, error } = await window.supabase
              .from('reprises')
              .insert([repriseData])
              .select()
              .single();
              
            if(error){
              console.error('‚ùå Erreur insertion:', error);
              console.error('‚ùå Message:', error.message);
              console.error('‚ùå Details:', error.details);
              alert('‚ùå Erreur lors de l\'ajout:\n\n' + error.message + '\n\nD√©tails: ' + (error.details || 'Aucun') + '\n\nV√©rifiez la console (F12) et assurez-vous d\'avoir ex√©cut√© les migrations SQL (buyer_name dans reprises)');
              return;
            }
            
            console.log('‚úÖ Reprise ajout√©e avec ID:', newReprise.id);
            
            // Cr√©er automatiquement une d√©pense dans Finances avec l'ID g√©n√©r√©
            const financeId = Date.now();
            const newFinance = {
              id: financeId,
              description: `Achat v√©hicule: ${repriseData.make} ${repriseData.model}`,
              type: 'expense',
              amount: repriseData.purchase_price,
              category: 'reprise',
              reprise_id: newReprise.id
            };
            
            const { error: financeError } = await window.supabase.from('finances').insert([newFinance]);
            if(financeError){
              console.error('‚ùå Erreur insertion finance:', financeError);
              // La reprise est cr√©√©e, mais pas la d√©pense - on continue
            } else {
              console.log('‚úÖ D√©pense automatique cr√©√©e dans Finances');
              
              // Rafra√Æchir la dashboard si elle est ouverte
              const financePanel = document.getElementById('financePanel');
              if(financePanel && financePanel.style.display === 'block'){
                await updateFinanceDashboard();
              }
            }
          }
          
          await renderReprisesTable();
          closeReprisesModal();
          
          // Si la section Finances est ouverte, la rafra√Æchir
          const financeSection = document.getElementById('finances');
          if(financeSection && !financeSection.classList.contains('hidden')){
            await updateFinanceDashboard();
          }
        }catch(e){
          console.error('‚ùå Exception:', e);
          alert('‚ùå Erreur: ' + e.message);
        }
      })

      if(reprisesLink){
        reprisesLink.addEventListener('click', async (e)=>{
          e.preventDefault()
          hideAllSections()
          reprisesSection.classList.remove('hidden')
          await renderReprisesTable()
        })
      }

      // Navigation Expertises
      const expertisesLink = document.querySelector('a[href="#expertises"]')
      const expertisesSection = document.querySelector('#expertises')
      if(expertisesLink){ expertisesLink.addEventListener('click', (e)=>{ e.preventDefault(); hideAllSections(); expertisesSection.classList.remove('hidden'); }) }

      // Navigation Avis Clients
      const avisLink = document.querySelector('a[href="#avis"]')
      const avisSection = document.querySelector('#avis')
      if(avisLink){ avisLink.addEventListener('click', async (e)=>{ e.preventDefault(); hideAllSections(); avisSection.classList.remove('hidden'); await loadReviews(); }) }

      // Navigation Archives
      const archivesLink = document.querySelector('a[href="#archives"]')
      const archivesSection = document.querySelector('#archives')
      if(archivesLink){ archivesLink.addEventListener('click', async (e)=>{ e.preventDefault(); hideAllSections(); archivesSection.classList.remove('hidden'); await loadArchives(); }) }

      // ========================
      // Gestion Archives
      // ========================
      async function loadArchives(){
        try{
          if(!window.supabase){
            console.error('‚ùå Supabase non initialis√©')
            return
          }
          
          const { data, error } = await window.supabase
            .from('finance_archives')
            .select('*')
            .order('month', { ascending: false })
          
          if(error){
            console.error('‚ùå Erreur chargement archives:', error)
            document.getElementById('archives-list').innerHTML = '<div class="activity-empty">Erreur de chargement</div>'
            return
          }
          
          if(!data || data.length === 0){
            document.getElementById('archives-list').innerHTML = '<div class="activity-empty">Aucune archive disponible</div>'
            return
          }
          
          const archivesHtml = data.map(archive => {
            const date = new Date(archive.created_at).toLocaleDateString('fr-FR')
            return `
              <div style="background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:24px;border-radius:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                  <div>
                    <h3 style="margin:0 0 8px;color:var(--text);font-size:20px;">üìä ${escapeHtml(archive.month_name)}</h3>
                    <div style="color:var(--muted);font-size:13px;">Archiv√© le ${date}</div>
                  </div>
                  <button onclick="downloadArchivePDF('${archive.month}', ${JSON.stringify(archive).replace(/"/g, '&quot;')})" class="btn primary">
                    üì• T√©l√©charger PDF
                  </button>
                </div>
                
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:16px;">
                  <div style="background:rgba(16,185,129,0.1);padding:12px;border-radius:8px;border:1px solid rgba(16,185,129,0.3);">
                    <div style="color:var(--muted);font-size:12px;margin-bottom:4px;">Revenus totaux</div>
                    <div style="color:#10b981;font-size:18px;font-weight:700;">${parseFloat(archive.total_revenue).toFixed(2)} ‚Ç¨</div>
                  </div>
                  <div style="background:rgba(239,68,68,0.1);padding:12px;border-radius:8px;border:1px solid rgba(239,68,68,0.3);">
                    <div style="color:var(--muted);font-size:12px;margin-bottom:4px;">D√©penses totales</div>
                    <div style="color:#ef4444;font-size:18px;font-weight:700;">${parseFloat(archive.total_expenses).toFixed(2)} ‚Ç¨</div>
                  </div>
                  <div style="background:rgba(59,130,246,0.1);padding:12px;border-radius:8px;border:1px solid rgba(59,130,246,0.3);">
                    <div style="color:var(--muted);font-size:12px;margin-bottom:4px;">Marge nette totale</div>
                    <div style="color:#3b82f6;font-size:18px;font-weight:700;">${parseFloat(archive.net_margin_total).toFixed(2)} ‚Ç¨</div>
                  </div>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.06);">
                  <div>
                    <div style="color:var(--muted);font-size:12px;margin-bottom:8px;">üöó Vente voitures</div>
                    <div style="display:flex;gap:12px;">
                      <div><span style="color:var(--muted);font-size:11px;">Revenus:</span> <span style="color:#10b981;font-weight:600;">${parseFloat(archive.vehicle_revenue).toFixed(2)} ‚Ç¨</span></div>
                      <div><span style="color:var(--muted);font-size:11px;">V√©hicules:</span> <span style="color:var(--text);font-weight:600;">${archive.vehicle_count}</span></div>
                    </div>
                    <div style="margin-top:4px;"><span style="color:var(--muted);font-size:11px;">Marge nette:</span> <span style="color:#10b981;font-weight:600;">${parseFloat(archive.net_margin_vehicle).toFixed(2)} ‚Ç¨</span></div>
                  </div>
                  <div>
                    <div style="color:var(--muted);font-size:12px;margin-bottom:8px;">üîß D√©pannage ZenScan</div>
                    <div style="display:flex;gap:12px;">
                      <div><span style="color:var(--muted);font-size:11px;">Revenus:</span> <span style="color:#10b981;font-weight:600;">${parseFloat(archive.zenscan_revenue).toFixed(2)} ‚Ç¨</span></div>
                      <div><span style="color:var(--muted);font-size:11px;">Services:</span> <span style="color:var(--text);font-weight:600;">${archive.zenscan_count}</span></div>
                    </div>
                    <div style="margin-top:4px;"><span style="color:var(--muted);font-size:11px;">Marge nette:</span> <span style="color:#10b981;font-weight:600;">${parseFloat(archive.net_margin_zenscan).toFixed(2)} ‚Ç¨</span></div>
                  </div>
                </div>
              </div>
            `
          }).join('')
          
          document.getElementById('archives-list').innerHTML = archivesHtml
          
        }catch(e){
          console.error('‚ùå Exception loadArchives:', e)
          document.getElementById('archives-list').innerHTML = '<div class="activity-empty">Erreur de chargement</div>'
        }
      }

      // Fonction pour t√©l√©charger le PDF d'une archive
      window.downloadArchivePDF = async function(monthStr, archiveData){
        try{
          // R√©cup√©rer les transactions du mois depuis l'archive (si disponibles)
          // Pour simplifier, on r√©g√©n√®re le PDF avec les donn√©es d'archive
          const { jsPDF } = window.jspdf
          const doc = new jsPDF()
          
          let y = 20
          
          // Titre
          doc.setFontSize(20)
          doc.setFont('helvetica', 'bold')
          doc.text('ZENOCCAZ - Rapport Financier Mensuel', 105, y, { align: 'center' })
          y += 15
          
          doc.setFontSize(14)
          doc.text(archiveData.month_name, 105, y, { align: 'center' })
          y += 15
          
          // R√©sum√©
          doc.setFontSize(12)
          doc.setFont('helvetica', 'bold')
          doc.text('R√âSUM√â FINANCIER', 20, y)
          y += 10
          
          doc.setFont('helvetica', 'normal')
          doc.setFontSize(10)
          doc.text(`Revenus totaux: ${parseFloat(archiveData.total_revenue).toFixed(2)} ‚Ç¨`, 20, y)
          y += 7
          doc.text(`D√©penses totales: ${parseFloat(archiveData.total_expenses).toFixed(2)} ‚Ç¨`, 20, y)
          y += 7
          doc.text(`B√©n√©fice brut: ${parseFloat(archiveData.total_profit).toFixed(2)} ‚Ç¨`, 20, y)
          y += 15
          
          // Vente voitures
          doc.setFont('helvetica', 'bold')
          doc.text('VENTE VOITURES (URSSAF 12,6%)', 20, y)
          y += 7
          doc.setFont('helvetica', 'normal')
          doc.text(`Revenus: ${parseFloat(archiveData.vehicle_revenue).toFixed(2)} ‚Ç¨`, 30, y)
          y += 6
          doc.text(`Cotisations URSSAF: ${parseFloat(archiveData.urssaf_vehicle_tax).toFixed(2)} ‚Ç¨`, 30, y)
          y += 6
          doc.text(`Marge nette: ${parseFloat(archiveData.net_margin_vehicle).toFixed(2)} ‚Ç¨`, 30, y)
          y += 6
          doc.text(`V√©hicules vendus: ${archiveData.vehicle_count}`, 30, y)
          y += 12
          
          // D√©pannage ZenScan
          doc.setFont('helvetica', 'bold')
          doc.text('D√âPANNAGE ZENSCAN (URSSAF 21,4%)', 20, y)
          y += 7
          doc.setFont('helvetica', 'normal')
          doc.text(`Revenus: ${parseFloat(archiveData.zenscan_revenue).toFixed(2)} ‚Ç¨`, 30, y)
          y += 6
          doc.text(`Cotisations URSSAF: ${parseFloat(archiveData.urssaf_zenscan_tax).toFixed(2)} ‚Ç¨`, 30, y)
          y += 6
          doc.text(`Marge nette: ${parseFloat(archiveData.net_margin_zenscan).toFixed(2)} ‚Ç¨`, 30, y)
          y += 6
          doc.text(`Services effectu√©s: ${archiveData.zenscan_count}`, 30, y)
          y += 12
          
          // Total
          doc.setFont('helvetica', 'bold')
          doc.setFontSize(12)
          doc.text(`MARGE NETTE TOTALE: ${parseFloat(archiveData.net_margin_total).toFixed(2)} ‚Ç¨`, 20, y)
          y += 15
          
          // Autres statistiques
          doc.setFontSize(10)
          doc.setFont('helvetica', 'normal')
          doc.text(`V√©hicules achet√©s (reprises): ${archiveData.reprise_count}`, 20, y)
          y += 6
          doc.text(`Achats de pi√®ces: ${archiveData.parts_count}`, 20, y)
          
          // Sauvegarder
          const fileName = `ZENOCCAZ_Finances_${archiveData.month_name.replace(' ', '_')}.pdf`
          doc.save(fileName)
          
          console.log('‚úÖ PDF t√©l√©charg√©:', fileName)
          
        }catch(e){
          console.error('‚ùå Erreur t√©l√©chargement PDF:', e)
          alert('‚ùå Erreur lors du t√©l√©chargement du PDF')
        }
      }

      // Fonction de test pour forcer l'archivage du mois en cours
      window.forceArchiveCurrentMonth = async function(){
        if(!confirm('‚ö†Ô∏è TEST : Voulez-vous archiver le mois en cours ?\n\nCela va cr√©er une archive et t√©l√©charger le PDF avec toutes les transactions actuelles.')){
          return
        }
        
        try{
          const now = new Date()
          const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`
          
          // Charger toutes les finances actuelles
          const finances = await loadFinances()
          
          if(finances.length === 0){
            alert('‚ùå Aucune donn√©e financi√®re √† archiver')
            return
          }
          
          console.log('üß™ Archivage forc√© du mois', currentMonth)
          await archiveMonth(currentMonth, finances)
          
          // Recharger la liste des archives
          await loadArchives()
          
        }catch(e){
          console.error('‚ùå Erreur test archivage:', e)
          alert('‚ùå Erreur lors du test d\'archivage')
        }
      }

      // ========================
      // Gestion Avis Clients
      // ========================
      async function loadReviews(){
        try{
          if(!window.supabase){
            console.error('‚ùå Supabase non initialis√©');
            return;
          }
          const { data, error } = await window.supabase.from('reviews').select('*').order('created_at', { ascending: false });
          if(error){
            console.error('‚ùå Erreur chargement avis:', error);
            return;
          }
          await renderReviewsTable(data || []);
        }catch(e){
          console.error('‚ùå Exception:', e);
        }
      }

      async function renderReviewsTable(reviews){
        const container = document.getElementById('avis-table')
        if(!container) return

        // Calculer les statistiques
        const total = reviews.length
        const average = total > 0 ? (reviews.reduce((sum, r) => sum + r.rating, 0) / total).toFixed(1) : 0
        const fiveStars = reviews.filter(r => r.rating === 5).length
        const lowStars = reviews.filter(r => r.rating <= 2).length

        // Mise √† jour des stats
        document.getElementById('avis-total').textContent = total
        document.getElementById('avis-average').textContent = `${average} ‚≠ê`
        document.getElementById('avis-5stars').textContent = fiveStars
        document.getElementById('avis-lowstars').textContent = lowStars

        if(reviews.length === 0){
          container.innerHTML = `
            <div style="background:rgba(255,255,255,0.02);padding:40px;text-align:center;border-radius:12px;border:1px solid rgba(255,255,255,0.06);">
              <div style="font-size:48px;margin-bottom:16px;opacity:0.3;">üí¨</div>
              <div style="color:var(--muted);font-size:15px;">Aucun avis client pour le moment</div>
            </div>
          `
          return
        }

        let html = `
          <div style="background:rgba(255,255,255,0.02);border-radius:12px;border:1px solid rgba(255,255,255,0.06);overflow:hidden;">
            <table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr style="background:rgba(255,255,255,0.03);border-bottom:1px solid rgba(255,255,255,0.06);">
                  <th style="padding:14px 16px;text-align:left;color:var(--muted);font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.5px;">Client</th>
                  <th style="padding:14px 16px;text-align:left;color:var(--muted);font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.5px;">Note</th>
                  <th style="padding:14px 16px;text-align:left;color:var(--muted);font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.5px;">Commentaire</th>
                  <th style="padding:14px 16px;text-align:left;color:var(--muted);font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.5px;">Date</th>
                  <th style="padding:14px 16px;text-align:center;color:var(--muted);font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.5px;">Actions</th>
                </tr>
              </thead>
              <tbody>
        `

        reviews.forEach((review, index) => {
          const date = new Date(review.created_at).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' })
          const stars = '‚≠ê'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating)
          const ratingColor = review.rating >= 4 ? '#10b981' : review.rating === 3 ? '#f59e0b' : '#ef4444'
          const borderBottom = index < reviews.length - 1 ? 'border-bottom:1px solid rgba(255,255,255,0.06);' : ''
          
          html += `
            <tr style="${borderBottom}">
              <td style="padding:14px 16px;">
                <div style="font-weight:600;color:var(--text);font-size:14px;">${review.client_name}</div>
              </td>
              <td style="padding:14px 16px;">
                <div style="font-size:16px;color:${ratingColor};" title="${review.rating}/5">${stars}</div>
              </td>
              <td style="padding:14px 16px;">
                <div style="color:var(--text);font-size:14px;max-width:400px;line-height:1.5;">${review.comment}</div>
              </td>
              <td style="padding:14px 16px;">
                <div style="color:var(--muted);font-size:13px;">${date}</div>
              </td>
              <td style="padding:14px 16px;text-align:center;">
                <button onclick="deleteReview(${review.id})" style="background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.2);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:16px;transition:all 0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.2)'" onmouseout="this.style.background='rgba(239,68,68,0.1)'">üóëÔ∏è</button>
              </td>
            </tr>
          `
        })

        html += `
              </tbody>
            </table>
          </div>
        `

        container.innerHTML = html
      }

      // Stocker loadReviews dans window pour y acc√©der depuis deleteReview
      window.loadReviewsAdmin = loadReviews;

      // init
      (async ()=>{
        await renderVehiclesTable()
        await updateDashboard()
      })()

      if(addAdminBtn) addAdminBtn.addEventListener('click', addVehicleAdmin)
    }
  </script>
</body>
</html>
